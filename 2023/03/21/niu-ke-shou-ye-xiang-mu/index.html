<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="仿牛客项目, 认言知">
    <meta name="description" content="一.开发社区首页开发流程:

一次请求的过程

分步实现

开发社区首页,显示前十个帖子
开发分页组件,分页显示所有帖子

后端关键点一:​	由于查询discussPost表时会查询到用户id,而我们在前端页面上现实的是用户的姓名,那么就需">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>仿牛客项目 | 认言知</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.1.1"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">认言知</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">认言知</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">仿牛客项目</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                后端
                            </a>
                        
                            <a href="/categories/%E5%90%8E%E7%AB%AF/spring/" class="post-category">
                                spring
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-03-21
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    19.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    100 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="一-开发社区首页"><a href="#一-开发社区首页" class="headerlink" title="一.开发社区首页"></a>一.开发社区首页</h1><p>开发流程:</p>
<ul>
<li>一次请求的过程</li>
</ul>
<p>分步实现</p>
<ul>
<li>开发社区首页,显示前十个帖子</li>
<li>开发分页组件,分页显示所有帖子</li>
</ul>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><h3 id="关键点一"><a href="#关键点一" class="headerlink" title="关键点一:"></a>关键点一:</h3><p>​	由于查询discussPost表时会查询到用户id,而我们在前端页面上现实的是用户的姓名,那么就需要根据用户id查询姓名. 作法有两种,第一种是连表查询. 第二种是根据查到的id到用户表中查找姓名,最后再同一封装给前端:本项目采用第一种方案:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210317222.png" alt="image-20230217210317222"></p>
<h3 id="关键点二"><a href="#关键点二" class="headerlink" title="关键点二:"></a>关键点二:</h3><p>关于springmvc对于方法中的model和其他参数的问题:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210546363.png" alt="image-20230217210546363"></p>
<h2 id="前端-thymeleaf"><a href="#前端-thymeleaf" class="headerlink" title="前端(thymeleaf)"></a>前端(thymeleaf)</h2><h3 id="关键点一-1"><a href="#关键点一-1" class="headerlink" title="关键点一:"></a>关键点一:</h3><p>关于thymeleaf的语法问题:</p>
<p>通常使用  <strong>${}</strong> 的形式接受后端传过来的参数,而使用 xx: **${yy}**可以为参数取别名:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210824347.png" alt="image-20230217210824347"></p>
<p><strong>th:if</strong>用于判断条件,条件成立则显示html的内容,否则不显示:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211008030.png" alt="image-20230217211008030"></p>
<p>thymeleaf关于时间日期的格式转换,采用内置的函数#dates.format(date,format):</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211238698.png" alt="image-20230217211238698"></p>
<p><strong>th:utext</strong>会将特殊字符转义,th:text则不会</p>
<h3 id="关键点二-1"><a href="#关键点二-1" class="headerlink" title="关键点二:"></a>关键点二:</h3><p>有一些相对路径的静态资源时,通常需要使用</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211422825.png" alt="image-20230217211422825"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211433609.png" alt="image-20230217211433609"></p>
<p>这样就会让程序从static目录下寻找静态资源了</p>
<p>而在请求路径中这样写是相对于整个项目的路径如:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212449870.png" alt="image-20230217212449870"></p>
<p>请求路径为:<a target="_blank" rel="noopener" href="http://localhost:8080/community/index?current=1">http://localhost:8080/community/index?current=1</a></p>
<h3 id="关键点三"><a href="#关键点三" class="headerlink" title="关键点三:"></a>关键点三:</h3><p>动态为html标签添加类:| 固定类名,  ${条件语句} |</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212634231.png" alt="image-20230217212634231"></p>
<p>同时,themeleaf还有创建连续数数组<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212758254.png" alt="image-20230217212758254">的方法,#numbers.sequence(a,b)—&gt;创建从a到b的数组</p>
<h1 id="二-发送邮件"><a href="#二-发送邮件" class="headerlink" title="二.发送邮件"></a>二.发送邮件</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218141925711.png" alt="image-20230218141925711"></p>
<h2 id="1-启动代发送邮件客户端的smtp功能"><a href="#1-启动代发送邮件客户端的smtp功能" class="headerlink" title="1.启动代发送邮件客户端的smtp功能,"></a>1.启动代发送邮件客户端的smtp功能,</h2><p>本人使用的是qq邮箱,那么就要从设置中启用:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218164836043.png" alt="image-20230218164836043"></p>
<h2 id="2-导入spring-email相关的jar包"><a href="#2-导入spring-email相关的jar包" class="headerlink" title="2.导入spring email相关的jar包"></a>2.导入spring email相关的jar包</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置邮箱参数"><a href="#3-配置邮箱参数" class="headerlink" title="3.配置邮箱参数"></a>3.配置邮箱参数</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="attr">spring.mail.port</span>=<span class="string">465</span></span><br><span class="line"><span class="attr">spring.mail.username</span>=<span class="string">1975131479@qq.com</span></span><br><span class="line"><span class="attr">spring.mail.password</span>=<span class="string">idhhgkpulgrufaac</span></span><br><span class="line"><span class="attr">spring.mail.protocol</span>=<span class="string">smtps</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.ssl.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtl.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h2 id="4-使用JavaMailSender发送邮件"><a href="#4-使用JavaMailSender发送邮件" class="headerlink" title="4.使用JavaMailSender发送邮件"></a>4.使用JavaMailSender发送邮件</h2><p>创建发送工具类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MailClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(MailClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JavaMailSender mailSender;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.mail.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String from;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMail</span><span class="params">(String to,String subject,String content)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MimeMessage message=mailSender.createMimeMessage();</span><br><span class="line">            MimeMessageHelper helper=<span class="keyword">new</span> <span class="title class_">MimeMessageHelper</span>(message);</span><br><span class="line">            helper.setFrom(from);</span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setSubject(subject);</span><br><span class="line">            helper.setText(content,<span class="literal">true</span>);</span><br><span class="line">            mailSender.send(helper.getMimeMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">           logger.error(<span class="string">&quot;发送邮件失败:&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218165210336.png" alt="image-20230218165210336"></p>
<h2 id="5-引入thymeleaf引擎发送html邮件"><a href="#5-引入thymeleaf引擎发送html邮件" class="headerlink" title="5.引入thymeleaf引擎发送html邮件:"></a>5.引入thymeleaf引擎发送html邮件:</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218165309093.png" alt="image-20230218165309093"></p>
<h1 id="三-开发注册功能"><a href="#三-开发注册功能" class="headerlink" title="三.开发注册功能"></a>三.开发注册功能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218145913743.png" alt="image-20230218145913743"></p>
<h2 id="1-开发访问注册页面"><a href="#1-开发访问注册页面" class="headerlink" title="1.开发访问注册页面"></a>1.开发访问注册页面</h2><p>控制层中直接加入代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/register&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getRegisterPage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/register&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-提交注册数据-注册激活账号"><a href="#2-提交注册数据-注册激活账号" class="headerlink" title="2.提交注册数据,注册激活账号"></a>2.提交注册数据,注册激活账号</h2><p>业务层中加入如下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;community.path.domain&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String domain;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;server.servlet.context-path&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String contextPath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//注册方法</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String,Object&gt;register(User user)&#123;</span><br><span class="line">    <span class="comment">//map作为传给前端的值</span></span><br><span class="line">    Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//对空值进行判断处理</span></span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getUsername()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMessage&quot;</span>,<span class="string">&quot;账号不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getPassword()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMessage&quot;</span>,<span class="string">&quot;密码不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getEmail()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;emailMessage&quot;</span>,<span class="string">&quot;邮箱不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证账号是否已经存在</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> userMapper.selectByName(user.getUsername());</span><br><span class="line">    <span class="keyword">if</span>(user1!=<span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMessage&quot;</span>,<span class="string">&quot;该账号已经存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证邮箱</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> userMapper.selectByEmail(user.getEmail());</span><br><span class="line">    <span class="keyword">if</span>(user2!=<span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;emailMessage&quot;</span>,<span class="string">&quot;该邮箱已被注册&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册用户</span></span><br><span class="line">    <span class="comment">//盐的长度设置为5位</span></span><br><span class="line">    user.setSalt(CommunityUtil.generateUUID().substring(<span class="number">0</span>,<span class="number">5</span>));</span><br><span class="line">    user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));</span><br><span class="line">    user.setType(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//0表示暂未激活</span></span><br><span class="line">    user.setStatus(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//生成激活码</span></span><br><span class="line">    user.setActivationCode(CommunityUtil.generateUUID());</span><br><span class="line">    user.setHeaderUrl(String.format(<span class="string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span>,<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>)));</span><br><span class="line">    user.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    userMapper.insertUser(user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送激活邮件</span></span><br><span class="line">    Context context=<span class="keyword">new</span> <span class="title class_">Context</span>();</span><br><span class="line">    context.setVariable(<span class="string">&quot;email&quot;</span>,user.getEmail());</span><br><span class="line">    <span class="comment">//通过地址的方式传递账户id和激活码,用户只需要点击一下激活就可以</span></span><br><span class="line">    <span class="comment">//http://localhost:8080/community/activation/101/code</span></span><br><span class="line">    String url=domain+contextPath+<span class="string">&quot;/activation/&quot;</span>+user.getId()+<span class="string">&quot;/&quot;</span>+user.getActivationCode();</span><br><span class="line">    context.setVariable(<span class="string">&quot;url&quot;</span>,url);</span><br><span class="line">    String content=templateEngine.process(<span class="string">&quot;/mail/activation&quot;</span>,context);</span><br><span class="line">    mailClient.sendMail(user.getEmail(),<span class="string">&quot;激活牛客账号&quot;</span>,content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中注册成功和激活成功的结果都是返回同一个页面,但是页面的内容根据结果而定:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170058916.png" alt="image-20230218170058916"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170122721.png" alt="image-20230218170122721"></p>
<p>该页面的关键点在于提示信息,和跳转的页面</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170212433.png" alt="image-20230218170212433"></p>
<h1 id="四-生成验证码"><a href="#四-生成验证码" class="headerlink" title="四.生成验证码"></a>四.生成验证码</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219134332696.png" alt="image-20230219134332696"></p>
<h2 id="1-导入jar包"><a href="#1-导入jar包" class="headerlink" title="1.导入jar包"></a>1.导入jar包</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--验证码--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-编辑配置类"><a href="#2-编辑配置类" class="headerlink" title="2.编辑配置类"></a>2.编辑配置类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Producer <span class="title function_">kaptchaProducer</span><span class="params">()</span>&#123;</span><br><span class="line">        Properties properties=<span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>,<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>,<span class="string">&quot;40&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.size&quot;</span>,<span class="string">&quot;32&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.font.color&quot;</span>,<span class="string">&quot;0,0,0&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.string&quot;</span>,<span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>,<span class="string">&quot;4&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.noise.impl&quot;</span>,<span class="string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DefaultKaptcha kaptcha=<span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        Config config=<span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        kaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> kaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-生成随机验证码"><a href="#3-生成随机验证码" class="headerlink" title="3.生成随机验证码"></a>3.生成随机验证码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/kaptcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getKaptcha</span><span class="params">(HttpServletResponse response, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="comment">//生成验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> kaptchaProducer.createText();</span><br><span class="line">    <span class="comment">//生成验证码图片</span></span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> kaptchaProducer.createImage(text);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把验证码存入session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;kaptcha&quot;</span>,text);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将图片输出给浏览器</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        <span class="comment">//输出图片的工具类</span></span><br><span class="line">        ImageIO.write(image,<span class="string">&quot;png&quot;</span>,os);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">       logger.error(<span class="string">&quot;响应验证码失败:&quot;</span>+e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五-登录-退出功能"><a href="#五-登录-退出功能" class="headerlink" title="五.登录,退出功能"></a>五.登录,退出功能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219143026346.png" alt="image-20230219143026346"></p>
<h2 id="1-验证账号-密码-验证码"><a href="#1-验证账号-密码-验证码" class="headerlink" title="1.验证账号,密码,验证码"></a>1.验证账号,密码,验证码</h2><p>验证账号密码的逻辑写在业务层,并且也附带一些提示信息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//登录</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String,Object&gt;login(String username,String password,<span class="type">int</span> expiredSeconds)&#123;</span><br><span class="line">    Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//空值处理</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(username)) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>,<span class="string">&quot;账号不能为空!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(password))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>,<span class="string">&quot;密码不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证账号</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectByName(username);</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>,<span class="string">&quot;该账号不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//验证是否激活</span></span><br><span class="line">    <span class="keyword">if</span>(user.getStatus()==<span class="number">0</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>,<span class="string">&quot;该账号未激活&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));</span></span><br><span class="line">    <span class="comment">//验证密码</span></span><br><span class="line">    <span class="keyword">if</span>(!CommunityUtil.md5(password + user.getSalt()).equals(user.getPassword()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>,<span class="string">&quot;输入的密码不正确,请再次输入&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//全部通过之后,成功登录,生成登录凭证</span></span><br><span class="line">    LoginTicket loginTicket=<span class="keyword">new</span> <span class="title class_">LoginTicket</span>();</span><br><span class="line">    <span class="comment">//登录凭证由随机字符组成</span></span><br><span class="line">    loginTicket.setTicket(CommunityUtil.generateUUID());</span><br><span class="line">    loginTicket.setUserId(user.getId());</span><br><span class="line">    loginTicket.setStatus(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//登录凭证的过期时间</span></span><br><span class="line">    loginTicket.setExpired(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()+expiredSeconds* <span class="number">1000L</span>));</span><br><span class="line">    </span><br><span class="line">    loginTicketMapper.insertLoginTicket(loginTicket);</span><br><span class="line">    map.put(<span class="string">&quot;ticket&quot;</span>,loginTicket.getTicket());</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在控制层:</p>
<p>验证用户输入的验证码和session中存放的是否一致:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查验证码</span></span><br><span class="line"><span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isBlank(code)||StringUtils.isBlank(kaptcha)||!kaptcha.equalsIgnoreCase(code)) &#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;codeMsg&quot;</span>,<span class="string">&quot;验证码不正确&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查账号密码以及重定向逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查账号密码</span></span><br><span class="line"><span class="type">int</span> expiredSeconds=rememberMe?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;</span><br><span class="line">Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);</span><br><span class="line"><span class="comment">//如果mao中包含&quot;ticket&quot;,则说明用户的账号密码信息正确,可以登录</span></span><br><span class="line"><span class="keyword">if</span>(map.containsKey(<span class="string">&quot;ticket&quot;</span>))&#123;</span><br><span class="line">    <span class="comment">//拿到cookie信息</span></span><br><span class="line">    Cookie cookie=<span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;ticket&quot;</span>,map.get(<span class="string">&quot;ticket&quot;</span>).toString());</span><br><span class="line">    <span class="comment">//设置cookie有效的路径: 整个项目</span></span><br><span class="line">    cookie.setPath(contextPath);</span><br><span class="line">    cookie.setMaxAge(expiredSeconds);</span><br><span class="line">    <span class="comment">//将设置好的cookie返回给浏览器</span></span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//用户在登录的某一环节出了差错</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;usernameMsg&quot;</span>,map.get(<span class="string">&quot;usernameMsg&quot;</span>));</span><br><span class="line">    model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>,map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-前端登录处理"><a href="#2-前端登录处理" class="headerlink" title="2.前端登录处理:"></a>2.前端登录处理:</h2><p>注意:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219180535635.png" alt="image-20230219180535635"></p>
<p>正常的java类型写在了参数列表里, springmvc不会自动将其加入到model中(自定义的一些类可以).虽然能为input标签添加name属性将其自动注入到参数中,但是前端无法通过model再次访问这些值. </p>
<p>解决方法: 1.手动添加到model中</p>
<p>​				2.thymeleaf为我们提供了param字段,相当于可以通过request得到请求携带的参数(request.getParameter(…))</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219181225032.png" alt="image-20230219181225032"></p>
<p>这样处理的好处是可以在输入错误后,将上一次输入的结果保留到输入框内</p>
<h2 id="3-登出功能"><a href="#3-登出功能" class="headerlink" title="3.登出功能"></a>3.登出功能</h2><p>登出功能的逻辑就是:</p>
<p> 将上一次登录的cookie设置为失效状态,然后重定向到登录界面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span>&#123;</span><br><span class="line">    loginTicketMapper.updateStatus(ticket,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/logout&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">logout</span><span class="params">(<span class="meta">@CookieValue(&quot;ticket&quot;)</span>String ticket)</span>&#123;</span><br><span class="line">    userService.logout(ticket);</span><br><span class="line">    <span class="comment">//默认get请求</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/login&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@CookieValue注解可以直接从本地获得存放的cookie字符串</p>
<h1 id="六-显示登录信息"><a href="#六-显示登录信息" class="headerlink" title="六.显示登录信息"></a>六.显示登录信息</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219160834081.png" alt="image-20230219160834081"></p>
<h2 id="1-定义拦截器-在请求开始前查询登录用户"><a href="#1-定义拦截器-在请求开始前查询登录用户" class="headerlink" title="1.定义拦截器,在请求开始前查询登录用户"></a>1.定义拦截器,在请求开始前查询登录用户</h2><p>定义工具类,每个线程对应一个user对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HostHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;User&gt; userThreadLocal=<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUser</span><span class="params">(User user)</span>&#123;</span><br><span class="line">        userThreadLocal.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;</span><br><span class="line">        userThreadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginTicketInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//从cookie中获取凭证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> CookieUtil.getValue(request, <span class="string">&quot;ticket&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ticket!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//表示登录了</span></span><br><span class="line">            <span class="comment">//查询凭证</span></span><br><span class="line">            <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> userService.findLoginTicket(ticket);</span><br><span class="line">            <span class="comment">//检查凭证是否有效</span></span><br><span class="line">            <span class="keyword">if</span>(loginTicket!=<span class="literal">null</span>&amp;&amp;loginTicket.getStatus()==<span class="number">0</span>&amp;&amp;loginTicket.getExpired().after(<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">                <span class="comment">//根据凭证查询用户</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(loginTicket.getUserId());</span><br><span class="line">                <span class="comment">//在本次请求中持有用户</span></span><br><span class="line">                hostHolder.setUser(user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>配置拦截器:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginTicketInterceptor loginTicketInterceptor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(loginTicketInterceptor)</span><br><span class="line">                <span class="comment">//放行下面的路径,其他的全部拦截</span></span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>,<span class="string">&quot;/**/*.js&quot;</span>,<span class="string">&quot;/**/*.png&quot;</span>,<span class="string">&quot;/**/*.jpg&quot;</span>,<span class="string">&quot;/**/*.jpeg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-在模板视图上显示用户数据-且登录或者未登录的情况下显示的状态栏应该不同"><a href="#2-在模板视图上显示用户数据-且登录或者未登录的情况下显示的状态栏应该不同" class="headerlink" title="2.在模板视图上显示用户数据. 且登录或者未登录的情况下显示的状态栏应该不同:"></a>2.在模板视图上显示用户数据. 且登录或者未登录的情况下显示的状态栏应该不同:</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    <span class="comment">//将持有的用户数据放给视图层</span></span><br><span class="line">    <span class="keyword">if</span>(user!=<span class="literal">null</span>&amp;&amp;modelAndView!=<span class="literal">null</span>)&#123;</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;loginUser&quot;</span>,user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//清理用户数据</span></span><br><span class="line">    hostHolder.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据登录或者未登录的状态,修改index导航栏得相关信息:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219182230298.png" alt="image-20230219182230298"></p>
<h1 id="七-账号设置"><a href="#七-账号设置" class="headerlink" title="七.账号设置"></a>七.账号设置</h1><h2 id="1-上传文件"><a href="#1-上传文件" class="headerlink" title="1.上传文件"></a>1.上传文件</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220160818386.png" alt="image-20230220160818386"></p>
<p>携带表单信息,所以必须得是post请求</p>
<p>表单中得添加属性: (上传文件的标识)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enctype=&quot;multipart/form-data&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220192958424.png" alt="image-20230220192958424"></p>
<p>开发步骤</p>
<h3 id="1-将用户上传的图像保存在服务器"><a href="#1-将用户上传的图像保存在服务器" class="headerlink" title="(1)将用户上传的图像保存在服务器:"></a>(1)将用户上传的图像保存在服务器:</h3><ul>
<li>检查格式</li>
<li>生成随机文件名</li>
<li>保存在指定路径</li>
<li>更新用户保存的头像路径</li>
<li>重定向到首页</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">uploadHeaderImg</span><span class="params">(MultipartFile headerImg, Model model)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(headerImg==<span class="literal">null</span>)&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;您还没有选择图片&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> headerImg.getOriginalFilename();</span><br><span class="line">    <span class="comment">//解析文件后缀</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(suffix)) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;文件的格式不正确&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(suffix.equals(<span class="string">&quot;png&quot;</span>)||suffix.equals(<span class="string">&quot;jpg&quot;</span>)||suffix.equals(<span class="string">&quot;jpeg&quot;</span>)))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;error&quot;</span>,<span class="string">&quot;文件的格式不正确&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成随机文件名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> CommunityUtil.generateUUID() +<span class="string">&quot;.&quot;</span>+ suffix;</span><br><span class="line">    <span class="comment">//确定文件存放的路径</span></span><br><span class="line">    File dest=<span class="keyword">new</span> <span class="title class_">File</span>(uploadPath+<span class="string">&quot;/&quot;</span>+filename);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//存储文件</span></span><br><span class="line">        headerImg.transferTo(dest);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;上传文件失败&quot;</span>+e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;上传文件失败,服务器异常&quot;</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新当前用户头像的路径(web路径)</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    String headerUrl=domain+contextPath+<span class="string">&quot;/user/header/&quot;</span>+filename;</span><br><span class="line">    userService.updateHeaderImg(user.getId(),headerUrl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-创建访问文件路径"><a href="#2-创建访问文件路径" class="headerlink" title="(2)创建访问文件路径"></a>(2)创建访问文件路径</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置头像的访问路径</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;header/&#123;filename&#125;&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getHeader</span><span class="params">(<span class="meta">@PathVariable(&quot;filename&quot;)</span>String filename, HttpServletResponse response)</span>&#123;</span><br><span class="line">    <span class="comment">//服务器存放的路径:</span></span><br><span class="line">    filename=uploadPath+<span class="string">&quot;/&quot;</span>+filename;</span><br><span class="line">    <span class="comment">//输出图片</span></span><br><span class="line">    <span class="comment">//文件后缀</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//响应图片</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;image/&quot;</span>+suffix);</span><br><span class="line">    <span class="comment">//在try括号里的流,都会在finally里中自动关闭</span></span><br><span class="line">    <span class="keyword">try</span> ( FileInputStream fis=<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename))&#123;</span><br><span class="line">        OutputStream os=response.getOutputStream();</span><br><span class="line">        <span class="comment">//缓冲区</span></span><br><span class="line">        <span class="type">byte</span>[]buffer=<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> b=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((b=fis.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            os.write(buffer,<span class="number">0</span>,b);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;读取头像失败&quot;</span>+e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-修改密码"><a href="#2-修改密码" class="headerlink" title="2.修改密码"></a>2.修改密码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改密码</span></span><br><span class="line"><span class="meta">@LoginRequired</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/updatePassword&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">updatePassword</span><span class="params">(String oldPassword,String newPassword1,String newPassword2,Model model)</span>&#123;</span><br><span class="line">    <span class="comment">//获取当前用户</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(oldPassword)) &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;oldPasswordMsg&quot;</span>,<span class="string">&quot;密码不能为空!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若原密码不正确</span></span><br><span class="line">    <span class="keyword">if</span>(!user.getPassword().equals(CommunityUtil.md5(oldPassword+user.getSalt())))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;oldPasswordMsg&quot;</span>,<span class="string">&quot;原密码错误,请重新输入!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若新密码为空:</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(newPassword1))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;newPasswordMsg1&quot;</span>,<span class="string">&quot;新密码不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若两次输入的密码不一致</span></span><br><span class="line">    <span class="keyword">if</span>(!newPassword1.equals(newPassword2))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;newPasswordMsg2&quot;</span>,<span class="string">&quot;两次输入的密码不一致,请重新输入!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若新密码和原密码一致:</span></span><br><span class="line">    <span class="keyword">if</span>(user.getPassword().equals(CommunityUtil.md5(newPassword1+user.getSalt())))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;newPasswordMsg1&quot;</span>,<span class="string">&quot;新密码不能与原密码一致!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    newPassword2=CommunityUtil.md5(newPassword2+user.getSalt());</span><br><span class="line">    userService.updatePassword(user.getId(),newPassword2);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/logout&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="八-检查登录状态"><a href="#八-检查登录状态" class="headerlink" title="八.检查登录状态"></a>八.检查登录状态</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220191030200.png" alt="image-20230220191030200"></p>
<p>有一些路径在未登录的状态下不允许访问,例如个人的设置页. 这种情况下虽然我们在前端隐藏了,但是还是可以通过输入访问路径的方式来得到页面,这是不安全的. 解决方法是使用拦截器.</p>
<p>工作中常见的除了直接指定拦截路径外,还可以指定拦截器作用的方法,通过自定义注解了来实现:</p>
<h2 id="1-自定义注解"><a href="#1-自定义注解" class="headerlink" title="1.自定义注解"></a>1.自定义注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dylan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/20 19:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 用来标记哪些方法是需要拦截的</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoginRequired &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-拦截器"><a href="#2-拦截器" class="headerlink" title="2.拦截器"></a>2.拦截器</h2><p>prehandle方法参数中的Object handler可以得到拦截的对象,强制转换为HandlerMethod对拦截的方法进行操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginRequiredInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//若拦截对象是方法</span></span><br><span class="line">        <span class="keyword">if</span>(handler <span class="keyword">instanceof</span> HandlerMethod)&#123;</span><br><span class="line">            <span class="comment">//强转</span></span><br><span class="line">            HandlerMethod handlerMethod=(HandlerMethod)handler;</span><br><span class="line">            <span class="comment">//得到方法</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> handlerMethod.getMethod();</span><br><span class="line">            <span class="comment">//获取方法的自定义标记注解</span></span><br><span class="line">            <span class="type">LoginRequired</span> <span class="variable">loginRequired</span> <span class="operator">=</span> method.getAnnotation(LoginRequired.class);</span><br><span class="line">			<span class="comment">//若注解对象不为空且未处在登录状态</span></span><br><span class="line">            <span class="keyword">if</span>(loginRequired!=<span class="literal">null</span>&amp;&amp;hostHolder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//重定向</span></span><br><span class="line">                response.sendRedirect(request.getContextPath()+<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="九-过滤敏感词"><a href="#九-过滤敏感词" class="headerlink" title="九.过滤敏感词"></a>九.过滤敏感词</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221105339374.png" alt="image-20230221105339374"></p>
<p>前缀树特点: </p>
<ul>
<li>根节点为空</li>
<li>每个节点只携带一个字符</li>
<li>每个节点的下一层不能有相同元素</li>
<li>可以快速查询检索字符串</li>
<li>核心思想是用空间换取时间</li>
</ul>
<h2 id="1-前缀树的定义"><a href="#1-前缀树的定义" class="headerlink" title="1.前缀树的定义"></a>1.前缀树的定义</h2><p>定义为私有内部类的方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//描述前缀树的节点</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TrieNode</span>&#123;</span><br><span class="line">    <span class="comment">//关键词结束的标识</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isKeyWordEnd=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前节点的子节点(key是下级节点的字符,value是下级节点</span></span><br><span class="line">    <span class="comment">//使用map存储</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character,TrieNode&gt;subNodes=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//是否是关键词汇的最后一个字符</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isKeyWordEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> isKeyWordEnd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKeyWordEnd</span><span class="params">(<span class="type">boolean</span> keyWordEnd)</span> &#123;</span><br><span class="line">        isKeyWordEnd = keyWordEnd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加子节点的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSubNode</span><span class="params">(Character c,TrieNode node)</span>&#123;</span><br><span class="line">        subNodes.put(c,node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取子节点的方法</span></span><br><span class="line">    <span class="keyword">public</span> TrieNode <span class="title function_">getSubNode</span><span class="params">(Character c)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subNodes.get(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-根据敏感词初始化前缀树"><a href="#2-根据敏感词初始化前缀树" class="headerlink" title="2.根据敏感词初始化前缀树"></a>2.根据敏感词初始化前缀树</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//改注解表示这是一个初始化方法,当容器初始化后,这个方法会自动被调用</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//读文件的字符</span></span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line">        <span class="comment">//类加载器读取文件流</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;sensitive-words.txt&quot;</span>);</span><br><span class="line">             BufferedReader reader=<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">    ) &#123;</span><br><span class="line">            String keyword;</span><br><span class="line">            <span class="keyword">while</span> ((keyword=reader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//添加到前缀树</span></span><br><span class="line">                <span class="built_in">this</span>.addKeyword(keyword);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;加载敏感词异常:&quot;</span>+e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将一个敏感词添加到前缀树</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addKeyword</span><span class="params">(String keyword)</span>&#123;</span><br><span class="line">    TrieNode tem=root;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyword.length(); i++) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> keyword.charAt(i);</span><br><span class="line">        <span class="type">TrieNode</span> <span class="variable">subNode</span> <span class="operator">=</span> tem.getSubNode(c);</span><br><span class="line">        <span class="keyword">if</span>(tem.getSubNode(c)==<span class="literal">null</span>)&#123;</span><br><span class="line">            subNode = <span class="keyword">new</span> <span class="title class_">TrieNode</span>();</span><br><span class="line">            tem.addSubNode(c,subNode);</span><br><span class="line">        &#125;</span><br><span class="line">            tem= subNode;</span><br><span class="line">            <span class="comment">//设置结束的标识</span></span><br><span class="line">            <span class="keyword">if</span>(i==keyword.length()-<span class="number">1</span>)&#123;</span><br><span class="line">                tem.setKeyWordEnd(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-编写过滤词汇的方法"><a href="#3-编写过滤词汇的方法" class="headerlink" title="3.编写过滤词汇的方法"></a>3.编写过滤词汇的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现检索敏感词的过程</span></span><br><span class="line"><span class="comment">//过滤敏感词并返回过滤后的结果</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">filter</span><span class="params">(String text)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(text))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//指针1:指向树的节点</span></span><br><span class="line">    TrieNode tem=root;</span><br><span class="line">    <span class="comment">//指针2</span></span><br><span class="line">    <span class="type">int</span> begin=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//指针3</span></span><br><span class="line">    <span class="type">int</span> end=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//结果</span></span><br><span class="line">    StringBuilder stringBuilder=<span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (end&lt;text.length())&#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> text.charAt(end);</span><br><span class="line">        <span class="comment">//跳过符号</span></span><br><span class="line">        <span class="keyword">if</span>(isSymbol(c))&#123;</span><br><span class="line">            <span class="comment">//若指针1是根节点,将该符号计入结果,让指针2向下走</span></span><br><span class="line">            <span class="keyword">if</span>(tem==root)&#123;</span><br><span class="line">                stringBuilder.append(c);</span><br><span class="line">                begin++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//无论符号在开头还是中间,指针3都向下走</span></span><br><span class="line">            end++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//字符不是特殊字符</span></span><br><span class="line">        <span class="comment">//检查下级节点</span></span><br><span class="line">        tem=tem.getSubNode(c);</span><br><span class="line">        <span class="keyword">if</span>(tem==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//以begin开头的字符串不是敏感词</span></span><br><span class="line">            stringBuilder.append(c);</span><br><span class="line">            begin++;</span><br><span class="line">            end=begin;</span><br><span class="line">            <span class="comment">//重新指向根节点</span></span><br><span class="line">            tem=root;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!tem.isKeyWordEnd)&#123;</span><br><span class="line">            <span class="comment">//该字符不是最后一个敏感字符</span></span><br><span class="line">            end++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//该字符是最后一个敏感字符:</span></span><br><span class="line">            stringBuilder.append(REPLACEMENT);</span><br><span class="line">            end++;</span><br><span class="line">            begin=end;</span><br><span class="line">            <span class="comment">//重新指向根节点</span></span><br><span class="line">            tem=root;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将最后一批计入结果</span></span><br><span class="line">    stringBuilder.append(text.substring(begin));</span><br><span class="line">    <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否为符号</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSymbol</span><span class="params">(Character c)</span>&#123;</span><br><span class="line">    <span class="comment">//是特殊字符的话返回true,普通字符返回false         东亚的文字范围</span></span><br><span class="line">    <span class="keyword">return</span> !CharUtils.isAsciiAlphanumeric(c)&amp;&amp;(c&lt;<span class="number">0x2E80</span>||c&gt;<span class="number">0x9FFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十-发布帖子"><a href="#十-发布帖子" class="headerlink" title="十.发布帖子"></a>十.发布帖子</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221152115978.png" alt="image-20230221152115978"></p>
<h2 id="1-处理后端插入数据的代码"><a href="#1-处理后端插入数据的代码" class="headerlink" title="1.处理后端插入数据的代码"></a>1.处理后端插入数据的代码</h2><p>由于是插入一条帖子的字段,所以dao层的方法应该为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">insertDiscussPost</span><span class="params">(DiscussPost post)</span>;</span><br></pre></td></tr></table></figure>

<p>mapper.xml的内容:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span></span><br><span class="line">        user_id,title,content,type,status,create_time,comment_count,score</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertDiscussPost&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;DiscussPost&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">    insert into discuss_post(<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>)</span><br><span class="line">    values(#&#123;userId&#125;,#&#123;title&#125;,#&#123;content&#125;,#&#123;type&#125;,#&#123;status&#125;,#&#123;createTime&#125;,#&#123;commentCount&#125;,#&#123;score&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-编写业务层逻辑"><a href="#2-编写业务层逻辑" class="headerlink" title="2.编写业务层逻辑"></a>2.编写业务层逻辑</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addDiscussPost</span><span class="params">(DiscussPost discussPost)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(discussPost==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理标签</span></span><br><span class="line">    <span class="comment">//转义HTML标签(比如在标题或内容中写&lt;h1&gt;你好&lt;h1&gt;,会将大于号小于号视为普通字符而不是标签)</span></span><br><span class="line">    discussPost.setTitle(HtmlUtils.htmlEscape(discussPost.getTitle()));</span><br><span class="line">    discussPost.setContent(HtmlUtils.htmlEscape(discussPost.getContent()));</span><br><span class="line">    <span class="comment">//过滤敏感词</span></span><br><span class="line">    discussPost.setTitle(sensitiveFilter.filter(discussPost.getTitle()));</span><br><span class="line">    discussPost.setContent(sensitiveFilter.filter(discussPost.getContent()));</span><br><span class="line">    <span class="comment">//插入</span></span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.insertDiscussPost(discussPost);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-控制层逻辑"><a href="#3-控制层逻辑" class="headerlink" title="3.控制层逻辑"></a>3.控制层逻辑</h2><p>一些简单的检查:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addDiscussPost</span><span class="params">(String title,String content)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">403</span>,<span class="string">&quot;您还未登录,请登录后再进行发帖&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(title)||StringUtils.isBlank(content))&#123;</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">1</span>,<span class="string">&quot;标题或内容不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    DiscussPost post=<span class="keyword">new</span> <span class="title class_">DiscussPost</span>();</span><br><span class="line">    post.setTitle(title);</span><br><span class="line">    post.setUserId(user.getId());</span><br><span class="line">    post.setContent(content);</span><br><span class="line">    post.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    discussPostService.addDiscussPost(post);</span><br><span class="line">    <span class="comment">//报错将来统一处理</span></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="string">&quot;发布成功!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-利用ajax异步发送请求"><a href="#4-利用ajax异步发送请求" class="headerlink" title="4.利用ajax异步发送请求"></a>4.利用ajax异步发送请求</h2><p>前端利用ajax异步发送请求:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   $(<span class="string">&quot;#publishBtn&quot;</span>).<span class="title function_">click</span>(publish);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">publish</span>(<span class="params"></span>) &#123;</span><br><span class="line">   $(<span class="string">&quot;#publishModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line">   <span class="comment">//获取标题和内容</span></span><br><span class="line">   <span class="keyword">let</span> title=$(<span class="string">&quot;#recipient-name&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   <span class="keyword">let</span> content=$(<span class="string">&quot;#message-text&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   <span class="comment">//发送异步请求</span></span><br><span class="line">   $.<span class="title function_">post</span>(</span><br><span class="line">      <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/discuss/add&quot;</span>,</span><br><span class="line">      <span class="comment">//参数</span></span><br><span class="line">      &#123;<span class="string">&quot;title&quot;</span>:title,<span class="string">&quot;content&quot;</span>:content&#125;,</span><br><span class="line">      <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">         data=$.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">         <span class="comment">//在提示框中显示返回的消息</span></span><br><span class="line">         $(<span class="string">&quot;#hintBody&quot;</span>).<span class="title function_">text</span>(data.<span class="property">msg</span>);</span><br><span class="line">         <span class="comment">//显示提示框</span></span><br><span class="line">         $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;show&quot;</span>);</span><br><span class="line">         <span class="comment">//两秒后自动隐藏提示框</span></span><br><span class="line">         <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line">            <span class="comment">//成功发布刷新页面</span></span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;, <span class="number">2000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十一-帖子详情"><a href="#十一-帖子详情" class="headerlink" title="十一.帖子详情"></a>十一.帖子详情</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221171350640.png" alt="image-20230221171350640"></p>
<h2 id="1-处理后端查询数据的代码"><a href="#1-处理后端查询数据的代码" class="headerlink" title="1.处理后端查询数据的代码:"></a>1.处理后端查询数据的代码:</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPostById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;DiscussPost&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from discuss_post</span><br><span class="line">    where id=#&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-处理业务层代码"><a href="#2-处理业务层代码" class="headerlink" title="2.处理业务层代码:"></a>2.处理业务层代码:</h2><p>直接调用</p>
<h2 id="3-处理控制层"><a href="#3-处理控制层" class="headerlink" title="3.处理控制层"></a>3.处理控制层</h2><p>因为查询帖子会用到用户的信息,可以有两种解决方案, </p>
<ul>
<li>一种是连表查询</li>
<li>第二种是根据帖子自带的用户id再查询一次user,这样效率比较低但是可以后期利用缓存.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDiscussPost</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span><span class="type">int</span> id, Model model)</span>&#123;</span><br><span class="line">    <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(id);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;post&quot;</span>,post);</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/discuss-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-处理前端的逻辑"><a href="#4-处理前端的逻辑" class="headerlink" title="4.处理前端的逻辑"></a>4.处理前端的逻辑</h2><p>前端首页只需要将标题上的超链接改为帖子详情的路径:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221175213206.png" alt="image-20230221175213206"></p>
<p>但是有一个点需要注意,thymeleaf在路径有变量有常量时,不能直接字符串拼接. 而是使用| |将常量和变量括起来,然后变量自取</p>
<h1 id="十二-显示评论"><a href="#十二-显示评论" class="headerlink" title="十二.显示评论"></a>十二.显示评论</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114033384.png" alt="image-20230223114033384"></p>
<h2 id="1-处理数据访问层"><a href="#1-处理数据访问层" class="headerlink" title="1.处理数据访问层"></a>1.处理数据访问层</h2><p>首先需要对comment表有一个细致的了解.</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114439016.png" alt="image-20230223114439016"></p>
<p>首先每个post表都有包含评论该post表的评论数量.</p>
<p>而comment表中的user_id是发表该评论的userId. </p>
<p>entity_type的字段表示评论的类型(1代表回复帖子的评论,2代表回复帖子里评论的评论)</p>
<p>当entity_type是1时,entity_id就是回复的主题帖子的id</p>
<p>当entity_type是2时,entity_id就是评论的楼主的id,无论该楼里是否有楼中楼,每个楼中楼的entity_id都是楼主的id</p>
<p>如果target_id不为0的话,说明该条评论是回复别人的,也就是楼中楼,那么targetId就是回复对象的id</p>
<p>mybatis的xml文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span></span><br><span class="line">    id,user_id,entity_type,entity_id,target_id,content,status,create_time</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span></span><br><span class="line">    user_id,entity_type,entity_id,target_id,content,status,create_time</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCommentByEntity&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Comment&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from comment</span><br><span class="line">    where status=0</span><br><span class="line">    and entity_type=#&#123;entityType&#125; and entity_id=#&#123;entityId&#125;</span><br><span class="line">    order by create_time asc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCountByEntity&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id)</span><br><span class="line">    from comment</span><br><span class="line">    where status=0</span><br><span class="line">    and entity_type=#&#123;entityType&#125; and entity_id=#&#123;entityId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertComment&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;comment&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">    insert into comment(<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>)</span><br><span class="line">    values (#&#123;userId&#125;,#&#123;entityType&#125;,#&#123;entityId&#125;,#&#123;targetId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-业务层逻辑"><a href="#2-业务层逻辑" class="headerlink" title="2.业务层逻辑"></a>2.业务层逻辑</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CommentMapper commentMapper;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> SensitiveFilter sensitiveFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Comment&gt;findCommentByEntity(<span class="type">int</span> entityType,<span class="type">int</span> entityId,<span class="type">int</span> offset,<span class="type">int</span> limit)&#123;</span><br><span class="line">    <span class="keyword">return</span> commentMapper.selectCommentByEntity(entityType,entityId,offset,limit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findCommentCount</span><span class="params">(<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> commentMapper.selectCountByEntity(entityType,entityId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加帖子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(comment==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;评论不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过滤html标签</span></span><br><span class="line">    comment.setContent(HtmlUtils.htmlUnescape(comment.getContent()));</span><br><span class="line">    <span class="comment">//过滤敏感词</span></span><br><span class="line">    comment.setContent(sensitiveFilter.filter(comment.getContent()));</span><br><span class="line">    <span class="comment">//添加评论</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> commentMapper.insertComment(comment);</span><br><span class="line">    <span class="comment">//更新回复给帖子的评论数量</span></span><br><span class="line">    <span class="keyword">if</span>(comment.getEntityType()==ENTITY_TYPE_POST)&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());</span><br><span class="line">        discussPostService.updateCommentCount(comment.getEntityId(),count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-控制层-评论详情"><a href="#3-控制层-评论详情" class="headerlink" title="3.控制层,评论详情"></a>3.控制层,评论详情</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDiscussPost</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span><span class="type">int</span> id, Model model, Page page)</span>&#123;</span><br><span class="line">    <span class="comment">//帖子</span></span><br><span class="line">    <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(id);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;post&quot;</span>,post);</span><br><span class="line">    <span class="comment">//作者</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//评论的分页信息</span></span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/discuss/detail/&quot;</span>+id);</span><br><span class="line">    <span class="comment">//单个帖子的评论总数</span></span><br><span class="line">    page.setRows(post.getCommentCount());</span><br><span class="line">    <span class="comment">//给帖子的评论:评论</span></span><br><span class="line">    <span class="comment">//给评论的评论:回复</span></span><br><span class="line">    List&lt;Comment&gt; commentList =</span><br><span class="line">            commentService.findCommentByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());</span><br><span class="line">    <span class="comment">//评论的列表</span></span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;commentVoList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(commentList!=<span class="literal">null</span>&amp;&amp;!commentList.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">for</span> (Comment comment : commentList) &#123;</span><br><span class="line">            <span class="comment">//一个评论的vo</span></span><br><span class="line">            Map&lt;String,Object&gt;commentVo=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">//评论</span></span><br><span class="line">            commentVo.put(<span class="string">&quot;comment&quot;</span>,comment);</span><br><span class="line">            <span class="comment">//评论的作者</span></span><br><span class="line">            commentVo.put(<span class="string">&quot;user&quot;</span>,userService.findUserById(comment.getUserId()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//查询回复列表</span></span><br><span class="line">            List&lt;Comment&gt; replyList =</span><br><span class="line">                    commentService.findCommentByEntity(ENTITY_TYPE_COMMENT, comment.getId(), <span class="number">0</span>, Integer.MAX_VALUE);</span><br><span class="line">            <span class="comment">//回复VO列表</span></span><br><span class="line">            List&lt;Map&lt;String,Object&gt;&gt;replyVoList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span>(replyList!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span> (Comment reply : replyList) &#123;</span><br><span class="line">                    Map&lt;String,Object&gt;replyVo=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    <span class="comment">//存回复:</span></span><br><span class="line">                    replyVo.put(<span class="string">&quot;reply&quot;</span>,reply);</span><br><span class="line">                    replyVo.put(<span class="string">&quot;user&quot;</span>,userService.findUserById(reply.getUserId()));</span><br><span class="line">                    <span class="comment">//回复的目标</span></span><br><span class="line">                    <span class="keyword">if</span>(reply.getTargetId()!=<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> userService.findUserById(reply.getTargetId());</span><br><span class="line">                        replyVo.put(<span class="string">&quot;target&quot;</span>,target);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        replyVo.put(<span class="string">&quot;target&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    replyVoList.add(replyVo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            commentVo.put(<span class="string">&quot;replys&quot;</span>,replyVoList);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//回复的数量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">commentCount</span> <span class="operator">=</span> commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());</span><br><span class="line">            commentVo.put(<span class="string">&quot;replyCount&quot;</span>,commentCount);</span><br><span class="line">            commentVoList.add(commentVo);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;comments&quot;</span>,commentVoList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/discuss-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-前端页面"><a href="#4-前端页面" class="headerlink" title="4.前端页面"></a>4.前端页面</h2><p>注意一个点</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223120650954.png" alt="image-20230223120650954"></p>
<p>当需要知道循环次数时,往往需要在别名后面加上Stat如rvoStat再取count就为当时处在第几次循环</p>
<h1 id="十三-添加评论"><a href="#十三-添加评论" class="headerlink" title="十三.添加评论"></a>十三.添加评论</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114101675.png" alt="image-20230223114101675"></p>
<h2 id="1-业务层"><a href="#1-业务层" class="headerlink" title="1.业务层"></a>1.业务层</h2><p>因为添加帖子时,会影响到另外一张表discuss_post的数据. 所以我们要使用到spring为我们提供的事务管理方法;</p>
<p>在本次方法上就使用注解的方式进行事务管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加帖子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addComment</span><span class="params">(Comment comment)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(comment==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;评论不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过滤html标签</span></span><br><span class="line">    comment.setContent(HtmlUtils.htmlUnescape(comment.getContent()));</span><br><span class="line">    <span class="comment">//过滤敏感词</span></span><br><span class="line">    comment.setContent(sensitiveFilter.filter(comment.getContent()));</span><br><span class="line">    <span class="comment">//添加评论  </span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> commentMapper.insertComment(comment);</span><br><span class="line">    <span class="comment">//更新回复给帖子的评论数量</span></span><br><span class="line">    <span class="keyword">if</span>(comment.getEntityType()==ENTITY_TYPE_POST)&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());</span><br><span class="line">        discussPostService.updateCommentCount(comment.getEntityId(),count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-控制层"><a href="#2-控制层" class="headerlink" title="2.控制层"></a>2.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/comment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CommentService commentService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder holder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;,method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span><span class="type">int</span> discussPostId, Comment comment)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(comment.getContent()==<span class="literal">null</span>||<span class="string">&quot;&quot;</span>.equals(comment.getContent()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail&quot;</span>+discussPostId;</span><br><span class="line">        &#125;</span><br><span class="line">         comment.setUserId(holder.getUser().getId());</span><br><span class="line">         comment.setStatus(<span class="number">0</span>);</span><br><span class="line">         comment.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">         commentService.addComment(comment);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span>+discussPostId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十四-私信列表"><a href="#十四-私信列表" class="headerlink" title="十四.私信列表"></a>十四.私信列表</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114155129.png" alt="image-20230223114155129"></p>
<h2 id="1-数据访问层"><a href="#1-数据访问层" class="headerlink" title="1.数据访问层"></a>1.数据访问层</h2><p>message的表结构:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223121834387.png" alt="image-20230223121834387"></p>
<p>xml文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span></span><br><span class="line">    id,from_id,to_id,conversation_id,content,status,create_time</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectConversations&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message where id in(</span><br><span class="line">        select max(id) from message</span><br><span class="line">        where status!=2</span><br><span class="line">        and `from_id`!=1</span><br><span class="line">        and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)</span><br><span class="line">        GROUP BY conversation_id</span><br><span class="line">    )</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectConversationCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    SELECT count(*) from</span><br><span class="line">        (</span><br><span class="line">            select count(id) from message</span><br><span class="line">            where status!=2 and from_id!=1</span><br><span class="line">         and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)</span><br><span class="line">            group by conversation_id</span><br><span class="line">        )a</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLetters&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message</span><br><span class="line">    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLetterCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectUnReadLetterCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status=0 and `from_id`!=1 and to_id=#&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;conversationId!=null&quot;</span>&gt;</span></span><br><span class="line">        and conversation_id=#&#123;conversationId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-控制层-1"><a href="#2-控制层-1" class="headerlink" title="2.控制层"></a>2.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户的私信列表</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/letter/list&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getLetterList</span><span class="params">(Model model, Page page)</span>&#123;</span><br><span class="line">    <span class="comment">//配置分页信息</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/letter/list&quot;</span>);</span><br><span class="line">    page.setRows(messageService.findConversationCount(user.getId()));</span><br><span class="line">    </span><br><span class="line">    List&lt;Message&gt; conversations = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;conversationList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (conversations!=<span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message conversation : conversations) &#123;</span><br><span class="line">            Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;conversation&quot;</span>,conversation);</span><br><span class="line">            <span class="comment">//用户未读消息数量</span></span><br><span class="line">            map.put(<span class="string">&quot;unreadCount&quot;</span>,messageService.findUnreadLetter(user.getId(), conversation.getConversationId()));</span><br><span class="line">            <span class="comment">//某一条会话的消息数量</span></span><br><span class="line">            map.put(<span class="string">&quot;letterCount&quot;</span>,messageService.findLetterCount(conversation.getConversationId()));</span><br><span class="line">            <span class="type">int</span> targetId=user.getId()==conversation.getFromId()?conversation.getToId():conversation.getFromId();</span><br><span class="line">            map.put(<span class="string">&quot;target&quot;</span>,userService.findUserById(targetId));</span><br><span class="line">            conversationList.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;conversations&quot;</span>,conversationList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总共的未读数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">unreadLetterTotal</span> <span class="operator">=</span> messageService.findUnreadLetter(user.getId(), <span class="literal">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;unreadLetterTotal&quot;</span>,unreadLetterTotal);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/letter&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户某一条私信的具体详情</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/letter/detail/&#123;conversationId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getLetterDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;conversationId&quot;)</span>String conversationId,Page page,Model model)</span>&#123;</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/letter/detail/&quot;</span>+conversationId);</span><br><span class="line">    page.setRows(messageService.findLetterCount(conversationId));</span><br><span class="line">    <span class="comment">//私信具体列表</span></span><br><span class="line">    List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;letters=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span>(letterList!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">            Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;letter&quot;</span>,message);</span><br><span class="line">            map.put(<span class="string">&quot;fromUser&quot;</span>,userService.findUserById(message.getFromId()));</span><br><span class="line">            letters.add(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;letters&quot;</span>,letters);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;target&quot;</span>,targetUser(conversationId));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/letter-detail&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分解conversationId</span></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">targetUser</span><span class="params">(String conversationId)</span>&#123;</span><br><span class="line">    String[] strings = conversationId.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">    <span class="type">int</span> id1=Integer.parseInt(strings[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> id2=Integer.parseInt(strings[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span>(holder.getUser().getId()==id1)&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id2);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十五-发送私信"><a href="#十五-发送私信" class="headerlink" title="十五.发送私信"></a>十五.发送私信</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223122150688.png" alt="image-20230223122150688"></p>
<h2 id="1-数据层"><a href="#1-数据层" class="headerlink" title="1.数据层"></a>1.数据层</h2><p>发送私信主要操作的是message表</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224124209233.png" alt="image-20230224124209233"></p>
<p>status为1代表消息已读,status为2代表消息被删除</p>
<p>status为0代表消息未读</p>
<p>发送消息和读取消息主要涉及到消息的插入和更新(主要更新的是status的值)</p>
<p>而每个消息框都要显示最新的消息内容,因为id是自动增长的,所以我们不用通过操作时间的方式来显示查询最新消息,只要获取id最大的message字段就行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectConversations&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message where id in(</span><br><span class="line">        select max(id) from message</span><br><span class="line">        where status!=2</span><br><span class="line">        and `from_id`!=1</span><br><span class="line">        and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)</span><br><span class="line">        GROUP BY conversation_id</span><br><span class="line">    )</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectConversationCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    SELECT count(*) from</span><br><span class="line">        (</span><br><span class="line">            select count(id) from message</span><br><span class="line">            where status!=2 and from_id!=1</span><br><span class="line">         and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)</span><br><span class="line">            group by conversation_id</span><br><span class="line">        )a</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLetters&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message</span><br><span class="line">    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLetterCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectUnReadLetterCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status=0 and `from_id`!=1 and to_id=#&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;conversationId!=null&quot;</span>&gt;</span></span><br><span class="line">        and conversation_id=#&#123;conversationId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertMessage&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    insert into message (<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>)</span><br><span class="line">    values (#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;conversationId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateStatus&quot;</span>&gt;</span></span><br><span class="line">    update message set status=#&#123;status&#125;</span><br><span class="line">    where id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">        #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-业务层"><a href="#2-业务层" class="headerlink" title="2.业务层"></a>2.业务层</h2><p>业务层有一点需要注意的是,当点进某个具体的消息会话内时,to_id为点进去的用户的id的所有未读消息的状态都要被设置为已读</p>
<h2 id="3-控制层"><a href="#3-控制层" class="headerlink" title="3.控制层"></a>3.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//用户某一条私信的具体详情</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/letter/detail/&#123;conversationId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLetterDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;conversationId&quot;)</span>String conversationId,Page page,Model model)</span>&#123;</span><br><span class="line">        page.setLimit(<span class="number">5</span>);</span><br><span class="line">        page.setPath(<span class="string">&quot;/letter/detail/&quot;</span>+conversationId);</span><br><span class="line">        page.setRows(messageService.findLetterCount(conversationId));</span><br><span class="line">        <span class="comment">//私信具体列表</span></span><br><span class="line">        List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());</span><br><span class="line">        List&lt;Map&lt;String,Object&gt;&gt;letters=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(letterList!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">                Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;letter&quot;</span>,message);</span><br><span class="line">                map.put(<span class="string">&quot;fromUser&quot;</span>,userService.findUserById(message.getFromId()));</span><br><span class="line">                letters.add(map);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;letters&quot;</span>,letters);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;target&quot;</span>,targetUser(conversationId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置已读</span></span><br><span class="line">        List&lt;Integer&gt;ids=getLetterIds(letterList);</span><br><span class="line">        <span class="keyword">if</span>(!ids.isEmpty())&#123;</span><br><span class="line">             messageService.readMessage(ids);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/letter-detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到集合中未读的消息的id</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; <span class="title function_">getLetterIds</span><span class="params">(List&lt;Message&gt;letterList)</span>&#123;</span><br><span class="line">    List&lt;Integer&gt;ids=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (letterList!=<span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">            <span class="comment">//当前用户是否是接受者</span></span><br><span class="line">            <span class="keyword">if</span>(holder.getUser().getId()==message.getToId()&amp;&amp;message.getStatus()==<span class="number">0</span>)&#123;</span><br><span class="line">                ids.add(message.getId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ids;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分解conversationId</span></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">targetUser</span><span class="params">(String conversationId)</span>&#123;</span><br><span class="line">    String[] strings = conversationId.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">    <span class="type">int</span> id1=Integer.parseInt(strings[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> id2=Integer.parseInt(strings[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span>(holder.getUser().getId()==id1)&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id2);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//异步请求</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/letter/send&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">sendLetter</span><span class="params">(String toName,String content)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> userService.findUserByName(toName);</span><br><span class="line">    <span class="keyword">if</span>(target==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">1</span>,<span class="string">&quot;目标用户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Message message=<span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    message.setFromId(holder.getUser().getId());</span><br><span class="line">    message.setToId(target.getId());</span><br><span class="line">    message.setContent(content);</span><br><span class="line">    <span class="keyword">if</span> (message.getFromId()&lt;message.getToId()) &#123;</span><br><span class="line">        message.setConversationId(message.getFromId()+<span class="string">&quot;_&quot;</span>+message.getToId());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        message.setConversationId(message.getToId()+<span class="string">&quot;_&quot;</span>+message.getFromId());</span><br><span class="line">    &#125;</span><br><span class="line">    message.setStatus(<span class="number">0</span>);</span><br><span class="line">    message.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    messageService.addMessage(message);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-前端"><a href="#4-前端" class="headerlink" title="4.前端"></a>4.前端</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   $(<span class="string">&quot;#sendBtn&quot;</span>).<span class="title function_">click</span>(send_letter);</span><br><span class="line">   $(<span class="string">&quot;.close&quot;</span>).<span class="title function_">click</span>(delete_msg);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">send_letter</span>(<span class="params"></span>) &#123;</span><br><span class="line">   $(<span class="string">&quot;#sendModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> toName=$(<span class="string">&quot;#recipient-name&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   <span class="keyword">let</span> content=$(<span class="string">&quot;#message-text&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">   $.<span class="title function_">post</span>(</span><br><span class="line">      <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/letter/send&quot;</span>,</span><br><span class="line">      &#123;<span class="string">&quot;toName&quot;</span>:toName,<span class="string">&quot;content&quot;</span>:content&#125;,</span><br><span class="line">      <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">         data=$.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">         <span class="keyword">if</span>(data.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">            $(<span class="string">&quot;#hintBody&quot;</span>).<span class="title function_">text</span>(<span class="string">&quot;发送成功&quot;</span>)</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $(<span class="string">&quot;#hintBody&quot;</span>).<span class="title function_">text</span>(data.<span class="property">msg</span>)</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">         $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;show&quot;</span>);</span><br><span class="line">         <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line">            location.<span class="title function_">reload</span>();</span><br><span class="line">         &#125;, <span class="number">2000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十六-统一处理异常"><a href="#十六-统一处理异常" class="headerlink" title="十六.统一处理异常"></a>十六.统一处理异常</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223133010699.png" alt="image-20230223133010699"></p>
<p>advice包下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扫描带有controller的bean</span></span><br><span class="line"><span class="meta">@ControllerAdvice(annotations = Controller.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(ExceptionAdvice.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;Exception.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception e, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;服务器发生异常:&quot;</span>+e.getMessage());</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement stackTraceElement : e.getStackTrace()) &#123;</span><br><span class="line">            logger.error(stackTraceElement.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取请求方式</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">xRequestedWith</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">        <span class="comment">//该请求是异步请求,返回json</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;</span><br><span class="line">            <span class="comment">//设置响应格式为普通文本</span></span><br><span class="line">            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">            PrintWriter writer=response.getWriter();</span><br><span class="line">            writer.write(CommunityUtil.getJsonString(<span class="number">1</span>,<span class="string">&quot;服务器异常&quot;</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//普通请求</span></span><br><span class="line">            <span class="comment">//普通请求直接重定向到error界面</span></span><br><span class="line">            response.sendRedirect(request.getContextPath()+<span class="string">&quot;/error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十七-统一记录日志"><a href="#十七-统一记录日志" class="headerlink" title="十七.统一记录日志"></a>十七.统一记录日志</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141027338.png" alt="image-20230223141027338"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141318952.png" alt="image-20230223141318952"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141734679.png" alt="image-20230223141734679"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223142344480.png" alt="image-20230223142344480"></p>
<h2 id="引入jar包-编写织入程序"><a href="#引入jar包-编写织入程序" class="headerlink" title="引入jar包,编写织入程序:"></a>引入jar包,编写织入程序:</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--aspect--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>aspect包下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceLogAspect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(ServiceLogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//织入到service上的方法</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.newcode.community.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(JoinPoint point)</span>&#123;</span><br><span class="line">        <span class="comment">//用户(ip)+在[时间],访问了[com.newcode.community.service.xxx()]</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">        <span class="comment">//获取ip</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getRemoteHost();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">		<span class="comment">//类名+方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> point.getSignature().getDeclaringTypeName() + <span class="string">&quot;.&quot;</span> + point.getSignature().getName();</span><br><span class="line"></span><br><span class="line">        logger.info(String.format(<span class="string">&quot;用户[%s]在[%s]访问了[%s].&quot;</span>,ip,date,target));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十八-springboot整合redis"><a href="#十八-springboot整合redis" class="headerlink" title="十八.springboot整合redis"></a>十八.springboot整合redis</h1><p>​	<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223151757059.png" alt="image-20230223151757059"></p>
<h2 id="1-引入redis"><a href="#1-引入redis" class="headerlink" title="1.引入redis:"></a>1.引入redis:</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-重新装配redisTemplate"><a href="#2-重新装配redisTemplate" class="headerlink" title="2.重新装配redisTemplate"></a>2.重新装配redisTemplate</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">redisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String,Object&gt;redisTemplate(RedisConnectionFactory factory)&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置key的序列化方式</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//设置value的序列化方式</span></span><br><span class="line">        template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="comment">//设置hash的key的序列化方式</span></span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//设置hash的value的序列化方式</span></span><br><span class="line">        template.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line"></span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-配置配置文件"><a href="#3-配置配置文件" class="headerlink" title="3.配置配置文件"></a>3.配置配置文件</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis</span></span><br><span class="line"><span class="comment">#library index</span></span><br><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">11</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">43.143.232.99</span></span><br><span class="line"><span class="attr">spring.redis.password</span>=<span class="string">*****</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>

<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = NewCodeApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">redisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//String redisKey=&quot;test:count&quot;;</span></span><br><span class="line">        <span class="comment">//redisTemplate.opsForValue().set(redisKey,1);</span></span><br><span class="line">        <span class="comment">//System.out.println(redisTemplate.opsForValue().get(redisKey));</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//System.out.println(redisTemplate.opsForValue().increment(redisKey));</span></span><br><span class="line">        <span class="comment">//System.out.println(redisTemplate.opsForValue().decrement(redisKey));</span></span><br><span class="line"></span><br><span class="line">        String testHash=<span class="string">&quot;test:hash1&quot;</span>;</span><br><span class="line">        redisTemplate.opsForHash().put(testHash,<span class="string">&quot;id&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        redisTemplate.opsForHash().put(testHash,<span class="string">&quot;username&quot;</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        redisTemplate.opsForHash().get(testHash,<span class="string">&quot;username&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//编程式事务</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransactional</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;test:tx&quot;</span>;</span><br><span class="line">                operations.multi();</span><br><span class="line">                operations.opsForSet().add(redisKey, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line">                operations.opsForSet().add(redisKey, <span class="string">&quot;李四&quot;</span>);</span><br><span class="line">                operations.opsForSet().add(redisKey, <span class="string">&quot;王五&quot;</span>);</span><br><span class="line">                System.out.println(operations.opsForSet().members(redisKey));</span><br><span class="line">                <span class="keyword">return</span> operations.exec();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多次对一个key操作</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBound</span><span class="params">()</span>&#123;</span><br><span class="line">        String redisKey=<span class="string">&quot;test:bound1&quot;</span>;</span><br><span class="line">        redisTemplate.opsForValue().set(redisKey,<span class="number">1</span>);</span><br><span class="line">        BoundValueOperations operations=redisTemplate.boundValueOps(redisKey);</span><br><span class="line">        operations.increment();</span><br><span class="line">        operations.increment();</span><br><span class="line">        operations.increment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;test:count1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十九-点赞"><a href="#十九-点赞" class="headerlink" title="十九.点赞"></a>十九.点赞</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223155524642.png" alt="image-20230223155524642"></p>
<p>点赞或者取消点赞:</p>
<p>实现的逻辑是利用Redis的set数据结构, 点赞的数量统计为该结构内点赞用户id的数量,取消点赞就直接将用户id去除,判断是否点赞直接判断用户id是否在set内即可:</p>
<h2 id="1-业务层-1"><a href="#1-业务层-1" class="headerlink" title="1.业务层"></a>1.业务层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *点赞法则:</span></span><br><span class="line"><span class="comment"> * 帖子的赞的entityType为1</span></span><br><span class="line"><span class="comment"> * 回复或者楼中楼的entityType为2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//点赞</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">    <span class="comment">//判断用户是否已经点过赞</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line">    <span class="keyword">if</span>(isMember)&#123;</span><br><span class="line">        <span class="comment">//取消赞</span></span><br><span class="line">        redisTemplate.opsForSet().remove(entityLikeKey,userId);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        redisTemplate.opsForSet().add(entityLikeKey,userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点赞数量</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findEntityLikeCount</span><span class="params">(<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某人对某实体有没有点过赞</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findEntityLikeStatus</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">    <span class="comment">//1已经点赞,0未点赞</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey,userId)?<span class="number">1</span>:<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-控制层-2"><a href="#2-控制层-2" class="headerlink" title="2.控制层"></a>2.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LikeController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder holder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/like&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">like</span><span class="params">(<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">        <span class="comment">//点赞</span></span><br><span class="line">        likeService.like(user.getId(),entityType,entityId);</span><br><span class="line">        <span class="comment">//点赞的数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> likeService.findEntityLikeCount(entityType, entityId);</span><br><span class="line">        <span class="comment">//点赞的数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">entityLikeStatus</span> <span class="operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;likeCount&quot;</span>,count);</span><br><span class="line">        map.put(<span class="string">&quot;status&quot;</span>,entityLikeStatus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="literal">null</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-前端"><a href="#3-前端" class="headerlink" title="3.前端"></a>3.前端</h2><p>前端通过ajax异步发送请求实现点赞&#x2F;取消点赞效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">like</span>(<span class="params">btn,entityType,entityId</span>)&#123;</span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/like&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;entityType&quot;</span>:entityType,<span class="string">&quot;entityId&quot;</span>:entityId&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">            data=$.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">            <span class="keyword">if</span>(data.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">                $(btn).<span class="title function_">children</span>(<span class="string">&quot;i&quot;</span>).<span class="title function_">text</span>(data.<span class="property">likeCount</span>)</span><br><span class="line">                $(btn).<span class="title function_">children</span>(<span class="string">&quot;b&quot;</span>).<span class="title function_">text</span>(data.<span class="property">status</span>===<span class="number">1</span>?<span class="string">&#x27;已赞&#x27;</span>:<span class="string">&#x27;赞&#x27;</span>)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十-我收到的赞"><a href="#二十-我收到的赞" class="headerlink" title="二十.我收到的赞"></a>二十.我收到的赞</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224131207299.png" alt="image-20230224131207299"></p>
<p>重构点赞功能,增加以用户id构建的key:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点赞</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType,<span class="type">int</span> entityId,<span class="type">int</span> entityUserId)</span>&#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="comment">//实体获得的赞</span></span><br><span class="line">            String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">            <span class="comment">//用户总共获得的赞</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">userLikeKey</span> <span class="operator">=</span> redisKeyUtil.getUserLikeKey(entityUserId);</span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> operations.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line">            <span class="comment">//开启事务</span></span><br><span class="line">            operations.multi();</span><br><span class="line">            <span class="keyword">if</span>(isMember)&#123;</span><br><span class="line">                operations.opsForSet().remove(entityLikeKey,userId);</span><br><span class="line">                operations.opsForValue().decrement(userLikeKey);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                operations.opsForSet().add(entityLikeKey,userId);</span><br><span class="line">                operations.opsForValue().increment(userLikeKey);</span><br><span class="line">            &#125;</span><br><span class="line">                    <span class="comment">//执行事务</span></span><br><span class="line">            <span class="keyword">return</span> operations.exec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//某个用户总共获得的数量</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findUserLikeCount</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">userLikeKey</span> <span class="operator">=</span> redisKeyUtil.getUserLikeKey(userId);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(userLikeKey);</span><br><span class="line">    <span class="keyword">return</span> count==<span class="literal">null</span>?<span class="number">0</span>:count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//帖子或者回复的点赞数量</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findEntityLikeCount</span><span class="params">(<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某人对某实体有没有点过赞</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findEntityLikeStatus</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);</span><br><span class="line">    <span class="comment">//1已经点赞,0未点赞</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey,userId)?<span class="number">1</span>:<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十一-关注-取消关注-关注列表-粉丝列表"><a href="#二十一-关注-取消关注-关注列表-粉丝列表" class="headerlink" title="二十一.关注&#x2F;取消关注 关注列表&#x2F;粉丝列表"></a>二十一.关注&#x2F;取消关注 关注列表&#x2F;粉丝列表</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224141844224.png" alt="image-20230224141844224"></p>
<p>本项目的粉丝列表只针对用户,但是帖子也可以调用该功能(用在帖子上就为收藏该帖子的用户)</p>
<h2 id="1-key的设计"><a href="#1-key的设计" class="headerlink" title="1.key的设计"></a>1.key的设计</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关注的行为只能发生在用户身上,但是关注的对象可以是其他用户或者帖子(关注帖子默认为收藏帖子)</span></span><br><span class="line"><span class="comment"> * 帖子实体type为1,用户实体为3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//某个用户关注的实体(关注了谁)            实体的id   关注的时间</span></span><br><span class="line"><span class="comment">//      用户的id    关注的实体类型---&gt;zset(entityId,nowDate)</span></span><br><span class="line"><span class="comment">//followee:userId:entityType</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFolloweeKey</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_FOLLOWEE+SPLIT+userId+SPLIT+entityType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//某个实体的关注者,粉丝(谁关注了我)</span></span><br><span class="line"><span class="comment">//follower:entityId:entityType----&gt;zset(userId,nowdate)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFollowerKey</span><span class="params">(<span class="type">int</span> entityId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_FOLLOWER+SPLIT+entityId+SPLIT+entityType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//验证码的key</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getKaptchaKey</span><span class="params">(String owner)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_KAPTCHA+SPLIT+owner;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//登录凭证</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTicketKey</span><span class="params">(String ticket)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_TICKET+SPLIT+ticket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUserKey</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_User+SPLIT+userId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-业务层-1"><a href="#2-业务层-1" class="headerlink" title="2.业务层"></a>2.业务层</h2><p>使用redis的sorted-set结构, 按照一定的分数对元素进行排序</p>
<ul>
<li>由于关注时间也要传到前端,</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关注某个实体</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">follow</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="comment">//被哪些用户关注的key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> redisKeyUtil.getFollowerKey(entityId, entityType);</span><br><span class="line">            <span class="comment">//关注了哪些实体key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> redisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">            <span class="comment">//redis进入事务</span></span><br><span class="line">            operations.multi();</span><br><span class="line">            <span class="comment">//将自己的id添加到被哪些用户关注的key</span></span><br><span class="line">            operations.opsForZSet().add(followerKey,userId,System.currentTimeMillis());</span><br><span class="line">            <span class="comment">//将该实体添加到自己的关注列表</span></span><br><span class="line">            operations.opsForZSet().add(followeeKey,entityId,System.currentTimeMillis());</span><br><span class="line">            <span class="comment">//提交事务</span></span><br><span class="line">            <span class="keyword">return</span> operations.exec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取消关注</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unfollow</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="comment">//被哪些用户关注的key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> redisKeyUtil.getFollowerKey(entityId, entityType);</span><br><span class="line">            <span class="comment">//关注了哪些实体key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> redisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">            operations.multi();</span><br><span class="line">            <span class="comment">//将自己的id从到被哪些用户关注的key中删除</span></span><br><span class="line">            operations.opsForZSet().remove(followerKey,userId);</span><br><span class="line">            <span class="comment">//将该实体从到自己的关注列表删除</span></span><br><span class="line">            operations.opsForZSet().remove(followeeKey,entityId);</span><br><span class="line">            <span class="keyword">return</span> operations.exec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询某个用户关注实体的数量</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findFolloweeCount</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> redisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询用户的关注</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String,Object&gt;&gt;getFollowees(<span class="type">int</span> entityType, <span class="type">int</span> userId,<span class="type">int</span> offset,<span class="type">int</span> limit)&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> redisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="comment">//获得所有有序集合内的元素按照分数从高到低排序</span></span><br><span class="line">    Set&lt;Integer&gt; targetSet = redisTemplate.opsForZSet().reverseRange(followerKey, offset, limit + limit - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(targetSet==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer targetId : targetSet) &#123;</span><br><span class="line">        Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//粉丝实体</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">        map.put(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="comment">//关注时间</span></span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followerKey, targetId);</span><br><span class="line">        map.put(<span class="string">&quot;followTime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">        list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某个实体的粉丝数量</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findFollowerCount</span><span class="params">(<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> redisKeyUtil.getFollowerKey(entityId, entityType);</span><br><span class="line">    <span class="comment">//zcard命令查询该key结构内的所有元素数量</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询某个实体粉丝的ids</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String,Object&gt;&gt;getFollowers(<span class="type">int</span> entityType, <span class="type">int</span> entityId,<span class="type">int</span> offset,<span class="type">int</span> limit)&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> redisKeyUtil.getFollowerKey(entityId, entityType);</span><br><span class="line">    <span class="comment">//获得所有有序集合内的元素按照分数从高到低排序</span></span><br><span class="line">    Set&lt;Integer&gt; fanSet = redisTemplate.opsForZSet().reverseRange(followerKey, offset, limit + limit - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fanSet==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer fanId : fanSet) &#123;</span><br><span class="line">        Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//粉丝实体</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(fanId);</span><br><span class="line">        map.put(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="comment">//关注时间</span></span><br><span class="line">        <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followerKey, fanId);</span><br><span class="line">        map.put(<span class="string">&quot;followTime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">        list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前用户是否关注该实体</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasFollowed</span><span class="params">(<span class="type">int</span> userId,<span class="type">int</span> entityType,<span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> redisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().score(followeeKey,entityId)!=<span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-控制层-1"><a href="#3-控制层-1" class="headerlink" title="3.控制层"></a>3.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/follow&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">follow</span><span class="params">(<span class="type">int</span> entityId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user.getId()==entityId&amp;&amp;entityType==ENTITY_TYPE_USER)&#123;</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">1</span>,<span class="string">&quot;用户不能关注自己&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    followService.follow(user.getId(),entityId,entityType);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="string">&quot;已关注&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(&quot;/unfollow&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">unfollow</span><span class="params">(<span class="type">int</span> entityId,<span class="type">int</span> entityType)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">    followService.unfollow(user.getId(),entityId,entityType);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="string">&quot;已取消关注&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/follower/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">follower</span><span class="params">(Model model, Page page, <span class="meta">@PathVariable(&quot;userId&quot;)</span><span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="comment">//查询用户</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;该用户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/follower/&quot;</span>+user.getId());</span><br><span class="line">    page.setRows((<span class="type">int</span>)followService.findFolloweeCount(userId,ENTITY_TYPE_USER));</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt; userList=followService.getFollowers(ENTITY_TYPE_USER,user.getId(),page.getOffset(),page.getLimit());</span><br><span class="line">    <span class="keyword">if</span> (userList!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;</span><br><span class="line">            <span class="comment">//关注的人</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User)map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasFollowed</span> <span class="operator">=</span> hasFollowed(u.getId());</span><br><span class="line">            map.put(<span class="string">&quot;hasFollowed&quot;</span>,hasFollowed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;users&quot;</span>,userList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/follower&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/followee/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">followee</span><span class="params">(Model model, Page page, <span class="meta">@PathVariable(&quot;userId&quot;)</span><span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="comment">//查询用户</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;该用户不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/followee/&quot;</span>+user.getId());</span><br><span class="line">    page.setRows((<span class="type">int</span>)followService.findFolloweeCount(userId,ENTITY_TYPE_USER));</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt; userList=followService.getFollowees(ENTITY_TYPE_USER,user.getId(),page.getOffset(),page.getLimit());</span><br><span class="line">    <span class="keyword">if</span> (userList!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;</span><br><span class="line">            <span class="comment">//关注的人的关注的人</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User)map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasFollowed</span> <span class="operator">=</span> hasFollowed(u.getId());</span><br><span class="line">            map.put(<span class="string">&quot;hasFollowed&quot;</span>,hasFollowed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;users&quot;</span>,userList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/followee&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//当前用户是否关注传入的用户</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasFollowed</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(holder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> followService.hasFollowed(holder.getUser().getId(),ENTITY_TYPE_USER,userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-前端-1"><a href="#4-前端-1" class="headerlink" title="4.前端"></a>4.前端</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   $(<span class="string">&quot;.follow-btn&quot;</span>).<span class="title function_">click</span>(follow);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">follow</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> btn = <span class="variable language_">this</span>;</span><br><span class="line">   <span class="keyword">if</span> ($(btn).<span class="title function_">hasClass</span>(<span class="string">&quot;btn-info&quot;</span>)) &#123;</span><br><span class="line">      <span class="comment">// 关注TA</span></span><br><span class="line">      $.<span class="title function_">post</span>(</span><br><span class="line">         <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/follow&quot;</span>,</span><br><span class="line">         &#123;<span class="string">&quot;entityType&quot;</span>: <span class="number">3</span>, <span class="string">&quot;entityId&quot;</span>: $(btn).<span class="title function_">prev</span>().<span class="title function_">val</span>()&#125;,</span><br><span class="line">         <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">            data = $.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      )</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 取消关注</span></span><br><span class="line">      <span class="keyword">if</span> ($(btn).<span class="title function_">hasClass</span>(<span class="string">&quot;btn-secondary&quot;</span>)) &#123;</span><br><span class="line">         <span class="comment">// 关注TA</span></span><br><span class="line">         $.<span class="title function_">post</span>(</span><br><span class="line">            <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/unfollow&quot;</span>,</span><br><span class="line">            &#123;<span class="string">&quot;entityType&quot;</span>: <span class="number">3</span>, <span class="string">&quot;entityId&quot;</span>: $(btn).<span class="title function_">prev</span>().<span class="title function_">val</span>()&#125;,</span><br><span class="line">            <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">               data = $.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">               <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         )</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十二-优化登录模块"><a href="#二十二-优化登录模块" class="headerlink" title="二十二.优化登录模块"></a>二十二.优化登录模块</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224170234266.png" alt="image-20230224170234266"></p>
<h2 id="1-优化验证码"><a href="#1-优化验证码" class="headerlink" title="1.优化验证码"></a>1.优化验证码</h2><p>由于用户在验证码阶段未登录,所以无法获得userId. 那么我们需要创造一个短暂的唯一标识标记本次用户验证码的行为.</p>
<p>刷新验证码时利用uuid创造一个标识,存入cookie中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//验证码的归属者</span></span><br><span class="line"><span class="type">String</span> <span class="variable">kaptchaOwner</span> <span class="operator">=</span> CommunityUtil.generateUUID();</span><br><span class="line">Cookie cookie=<span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;kaptchaOwner&quot;</span>,kaptchaOwner);</span><br><span class="line"><span class="comment">//验证码有效时间:120s</span></span><br><span class="line">cookie.setMaxAge(<span class="number">120</span>);</span><br><span class="line">cookie.setPath(contextPath);</span><br><span class="line">response.addCookie(cookie);</span><br></pre></td></tr></table></figure>

<p>然后利用该标识创造一段rediskey连同验证码存入到redis中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将验证码存入redis</span></span><br><span class="line"><span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> redisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line"><span class="comment">//有效时间120s</span></span><br><span class="line">redisTemplate.opsForValue().set(redisKey,text,<span class="number">120</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>之后就从redis中获取正确的验证码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, String code, <span class="type">boolean</span> rememberMe,</span></span><br><span class="line"><span class="params">                        Model model, HttpServletResponse response,</span></span><br><span class="line"><span class="params">                        <span class="meta">@CookieValue(&quot;kaptchaOwner&quot;)</span>String kaptchaOwner)</span>&#123;</span><br><span class="line">        <span class="comment">//检查验证码</span></span><br><span class="line">        <span class="comment">//String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(kaptchaOwner))&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;codeMsg&quot;</span>,<span class="string">&quot;验证码已经过期,请重新输入&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> redisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line">        <span class="type">String</span> <span class="variable">kaptchaCode</span> <span class="operator">=</span>(String) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(code)||StringUtils.isBlank(kaptchaCode)||!kaptchaCode.equalsIgnoreCase(code)) &#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;codeMsg&quot;</span>,<span class="string">&quot;验证码不正确&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-使用redis存储登录凭证"><a href="#2-使用redis存储登录凭证" class="headerlink" title="2.使用redis存储登录凭证"></a>2.使用redis存储登录凭证</h2><p>登录凭证的结构:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginTicket</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line">    <span class="comment">//1为删除 0为正常使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> status;</span><br><span class="line">    <span class="comment">//过期时间</span></span><br><span class="line">    <span class="keyword">private</span> Date expired;</span><br><span class="line">    <span class="comment">//标识</span></span><br><span class="line">    <span class="keyword">private</span> String ticket;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将原本的mapper设置为废弃:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoginTicketMapper</span> &#123;</span><br></pre></td></tr></table></figure>

<p>在登录成功后生成登录凭证传给redis:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全部通过之后,成功登录,生成登录凭证</span></span><br><span class="line">LoginTicket loginTicket=<span class="keyword">new</span> <span class="title class_">LoginTicket</span>();</span><br><span class="line">loginTicket.setTicket(CommunityUtil.generateUUID());</span><br><span class="line">loginTicket.setUserId(user.getId());</span><br><span class="line">loginTicket.setStatus(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//过期时间</span></span><br><span class="line">loginTicket.setExpired(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()+expiredSeconds* <span class="number">1000L</span>));</span><br><span class="line"><span class="comment">//loginTicketMapper.insertLoginTicket(loginTicket);</span></span><br><span class="line"><span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> redisKeyUtil.getTicketKey(loginTicket.getTicket());</span><br><span class="line">redisTemplate.opsForValue().set(ticketKey,loginTicket);</span><br><span class="line">map.put(<span class="string">&quot;ticket&quot;</span>,loginTicket.getTicket());</span><br><span class="line"><span class="keyword">return</span> map;</span><br></pre></td></tr></table></figure>

<p>登出时将登录凭证设置为不可用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span>&#123;</span><br><span class="line">    <span class="comment">//loginTicketMapper.updateStatus(ticket,1);</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> redisKeyUtil.getTicketKey(ticket);</span><br><span class="line">    <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span>(LoginTicket) redisTemplate.opsForValue().get(ticketKey);</span><br><span class="line">    loginTicket.setStatus(<span class="number">1</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(ticketKey,loginTicket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在用户登录状态下如果凭证失效时间与当前时间相差小于两个小时,那么刷新凭证的有效时间,添加两个小时:</p>
<p>(防止用户使用网站用着用着就要返回登录)</p>
<p>在LoginTicketInterceptor中操作:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(ticket!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="comment">//表示登录了</span></span><br><span class="line">    <span class="comment">//查询凭证</span></span><br><span class="line">    <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> userService.findLoginTicket(ticket);</span><br><span class="line">    <span class="comment">//检查凭证是否有效</span></span><br><span class="line">    <span class="keyword">if</span>(loginTicket!=<span class="literal">null</span>&amp;&amp;loginTicket.getStatus()==<span class="number">0</span>&amp;&amp;loginTicket.getExpired().after(<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">        <span class="comment">//根据凭证查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(loginTicket.getUserId());</span><br><span class="line">        <span class="comment">//在本次请求中持有用户</span></span><br><span class="line">        hostHolder.setUser(user);</span><br><span class="line">        <span class="comment">//增加登录凭证的有效时间</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="comment">//相差的毫秒数</span></span><br><span class="line">        <span class="type">long</span> diff=loginTicket.getExpired().getTime()-now.getTime();</span><br><span class="line">        <span class="keyword">if</span>(diff/(<span class="number">1000</span>*<span class="number">60</span>*<span class="number">60</span>)&lt;<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">//凭证加两个小时</span></span><br><span class="line">            <span class="type">long</span> newTime=now.getTime()+<span class="number">2</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">newExpired</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(newTime);</span><br><span class="line">            loginTicket.setExpired(newExpired);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> redisKeyUtil.getTicketKey(loginTicket.getTicket());</span><br><span class="line">            redisTemplate.opsForValue().set(ticketKey,ticket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h2 id="3-缓存用户信息"><a href="#3-缓存用户信息" class="headerlink" title="3.缓存用户信息"></a>3.缓存用户信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//优先从缓存中取值</span></span><br><span class="line">   <span class="keyword">private</span> User <span class="title function_">getUserFromCache</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> redisKeyUtil.getUserKey(userId);</span><br><span class="line">       <span class="keyword">return</span> (User) redisTemplate.opsForValue().get(userKey);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//取不到初始化缓存数据</span></span><br><span class="line">   <span class="keyword">private</span> User <span class="title function_">InitCache</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">       <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> redisKeyUtil.getUserKey(userId);</span><br><span class="line">       redisTemplate.opsForValue().set(userKey,user,<span class="number">60</span>*<span class="number">60</span>*<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">       <span class="keyword">return</span> user;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//数据变化时清除缓存数据</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> redisKeyUtil.getUserKey(userId);</span><br><span class="line">       redisTemplate.delete(userKey);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">    <span class="comment">//return userMapper.selectById(id);</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">userFromCache</span> <span class="operator">=</span> getUserFromCache(id);</span><br><span class="line">    <span class="keyword">if</span>(userFromCache==<span class="literal">null</span>)&#123;</span><br><span class="line">        userFromCache = InitCache(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userFromCache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户更新信息时,让缓存失效,例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//激活状态码</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">activation</span><span class="params">(<span class="type">int</span> userId,String code)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(user.getStatus()==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//已经激活过了</span></span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_REPEAT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(user.getActivationCode().equals(code))&#123;</span><br><span class="line">        userMapper.updateStatus(userId,<span class="number">1</span>);</span><br><span class="line">        clearCache(userId);</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_SUCCESS;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateHeaderImg</span><span class="params">(<span class="type">int</span> userId,String url)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> userMapper.updateHeaderUrl(userId, url);</span><br><span class="line">        clearCache(userId);</span><br><span class="line">        <span class="keyword">return</span> col;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updatePassword</span><span class="params">(<span class="type">int</span> userId,String newPassword)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> userMapper.updatePassword(userId, newPassword);</span><br><span class="line">        clearCache(userId);</span><br><span class="line">        <span class="keyword">return</span> col;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十三-阻塞队列"><a href="#二十三-阻塞队列" class="headerlink" title="二十三.阻塞队列"></a>二十三.阻塞队列</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225125903848.png" alt="image-20230225125903848"></p>
<h1 id="二十四-kafka"><a href="#二十四-kafka" class="headerlink" title="二十四.kafka"></a>二十四.kafka</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225130622534.png" alt="image-20230225130622534"></p>
<h2 id="1启动kafka步骤"><a href="#1启动kafka步骤" class="headerlink" title="1启动kafka步骤"></a>1启动kafka步骤</h2><p>(在版本号的目录下,windows环境)<br>开启zookeeper的命令: bin\windows\zookeeper-server-start.bat config\zookeeper.properties</p>
<p>开启kafka的命令: bin\windows\kafka-server-start.bat config\server.properties</p>
<p>创建topic(test)的命令: bin\windows\kafka-topics.bat –create –bootstrap-server localhost:9092 –replication-factor 1 –partitions 1 –topic test</p>
<p>生产者: bin\windows\kafka-console-producer.bat –broker-list localhost:9092 –topic test</p>
<p>消费者: bin\windows\kafka-console-consumer.bat –bootstrap-server localhost:9092 –topic test –from-beginning</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225133538730.png" alt="image-20230225133538730"></p>
<h2 id="2配置文件"><a href="#2配置文件" class="headerlink" title="2配置文件:"></a>2配置文件:</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kafkaProperties</span></span><br><span class="line"><span class="attr">spring.kafka.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.group-id</span>=<span class="string">test-consumer-group</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.enable-auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.auto-commit-interval</span>=<span class="string">3000s</span></span><br></pre></td></tr></table></figure>

<h2 id="3-测试kafka"><a href="#3-测试kafka" class="headerlink" title="3.测试kafka"></a>3.测试kafka</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = NewCodeApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">kafkaTest</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> kafkaProduce kafkaProduce;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testKafka</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        kafkaProduce.sendMessage(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;howareyou&quot;</span>);</span><br><span class="line">        kafkaProduce.sendMessage(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;ok?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">kafkaProduce</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String topic,String content)</span>&#123;</span><br><span class="line">        kafkaTemplate.send(topic,content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">kafkaConsumer</span>&#123;</span><br><span class="line">    <span class="meta">@KafkaListener(topics = &#123;&quot;test&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(ConsumerRecord record)</span>&#123;</span><br><span class="line">        System.out.println(record.value());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十五-发布系统通知"><a href="#二十五-发布系统通知" class="headerlink" title="二十五.发布系统通知"></a>二十五.发布系统通知</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225153859011.png" alt="image-20230225153859011"></p>
<p>当用户点赞,评论或者关注后. 系统用户都会发送一条message给被点赞,关注和评论的人. 这个功能需要用到kafka</p>
<p>我们把点赞,关注和评论当做一种事件, 当事件发生时,用kafka做自动推送</p>
<h2 id="1-事件的实体"><a href="#1-事件的实体" class="headerlink" title="1.事件的实体:"></a>1.事件的实体:</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主题</span></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line"><span class="comment">//产生事件的用户id</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line"><span class="comment">//事件作用对象的type</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> entityType;</span><br><span class="line"><span class="comment">//事件作用对象的Id</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> entityId;</span><br><span class="line"><span class="comment">//事件作用对象的userID(如果是关注,那么userid=entityID)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> entityUserId;</span><br><span class="line"><span class="comment">//携带的数据</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String,Object&gt;data=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> topic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setTopic</span><span class="params">(String topic)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.topic = topic;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setUserId</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEntityType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> entityType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setEntityType</span><span class="params">(<span class="type">int</span> entityType)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.entityType = entityType;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEntityId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> entityId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setEntityId</span><span class="params">(<span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.entityId = entityId;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getEntityUserId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> entityUserId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setEntityUserId</span><span class="params">(<span class="type">int</span> entityUserId)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.entityUserId = entityUserId;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Event <span class="title function_">setData</span><span class="params">(String key,Object value)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.data.put(key,value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-事件的生产者"><a href="#2-事件的生产者" class="headerlink" title="2.事件的生产者"></a>2.事件的生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventProducer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供处理事件的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fireEvent</span><span class="params">(Event event)</span>&#123;</span><br><span class="line">        <span class="comment">//将事件发布到指定的主题</span></span><br><span class="line">        <span class="comment">//将事件实体以JSON字符串的形式发送</span></span><br><span class="line">        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-事件的消费者"><a href="#3-事件的消费者" class="headerlink" title="3.事件的消费者"></a>3.事件的消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventConsumer</span> <span class="keyword">implements</span> <span class="title class_">CommunityConstant</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(EventConsumer.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//往message表中插入数据</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &#123;TOPIC_COMMENT,TOPIC_FOLLOW,TOPIC_LIKE&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleCommentMessage</span><span class="params">(ConsumerRecord record)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(record==<span class="literal">null</span>||record.value()==<span class="literal">null</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;消息的内容为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">        <span class="keyword">if</span>(event==<span class="literal">null</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;消息格式错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//发送站内通知</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        <span class="comment">//来自系统</span></span><br><span class="line">        message.setFromId(SYSTEM_USER_ID);</span><br><span class="line">        message.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        message.setToId(event.getEntityUserId());</span><br><span class="line">        message.setConversationId(event.getTopic());</span><br><span class="line">        <span class="comment">//消息为未读</span></span><br><span class="line">        message.setStatus(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//map携带产生事件的userID</span></span><br><span class="line">        map.put(<span class="string">&quot;userId&quot;</span>,event.getUserId());</span><br><span class="line">        <span class="comment">//事件作用对象的type</span></span><br><span class="line">        map.put(<span class="string">&quot;entityType&quot;</span>,event.getEntityType());</span><br><span class="line">        <span class="comment">//事件作用对象的id</span></span><br><span class="line">        map.put(<span class="string">&quot;evtityId&quot;</span>,event.getEntityId());</span><br><span class="line">        <span class="keyword">if</span>(event.getData()!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; stringObjectEntry : event.getData().entrySet()) &#123;</span><br><span class="line">                map.put(stringObjectEntry.getKey(),stringObjectEntry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setContent(JSONObject.toJSONString(map));</span><br><span class="line">        messageService.addMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-拿点赞举例"><a href="#4-拿点赞举例" class="headerlink" title="4.拿点赞举例"></a>4.拿点赞举例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//触发点赞事件</span></span><br><span class="line"><span class="keyword">if</span>(entityLikeStatus==<span class="number">1</span>)&#123;</span><br><span class="line">    Event event=<span class="keyword">new</span> <span class="title class_">Event</span>();</span><br><span class="line">    event.setTopic(TOPIC_LIKE)</span><br><span class="line">            .setUserId(user.getId())</span><br><span class="line">            .setEntityType(entityType)</span><br><span class="line">            .setEntityId(entityId)</span><br><span class="line">            .setEntityUserId(entityUserId)</span><br><span class="line">            <span class="comment">//data里面存储点赞所在的帖子的id(点赞的不一定是帖子,也可能是回复)</span></span><br><span class="line">            .setData(<span class="string">&quot;postId&quot;</span>,postId);</span><br><span class="line">    producer.fireEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十六-显示系统通知"><a href="#二十六-显示系统通知" class="headerlink" title="二十六.显示系统通知"></a>二十六.显示系统通知</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225153835023.png" alt="image-20230225153835023"></p>
<h2 id="1-数据层-1"><a href="#1-数据层-1" class="headerlink" title="1.数据层"></a>1.数据层</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--查询最新的一条通知--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLatestNotice&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span> from message</span><br><span class="line">    where id in(</span><br><span class="line">        select max(id) from message</span><br><span class="line">        where status!=2 and from_id=1 and to_id=#&#123;userId&#125;</span><br><span class="line">         and conversation_id=#&#123;topic&#125;</span><br><span class="line">    )</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--查询通知总数--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNoticeCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status!=2 and from_id=1 and to_id=#&#123;userId&#125;</span><br><span class="line">      and conversation_id=#&#123;topic&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--查询未读的通知数量--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNoticeUnreadCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status=0 and from_id=1 and to_id=#&#123;userId&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;topic!=null&quot;</span>&gt;</span></span><br><span class="line">            and conversation_id=#&#123;topic&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--查询通知,带有分页条件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNotice&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span> from message</span><br><span class="line">    where status!=2 and from_id=1 and to_id=#&#123;userId&#125;  and conversation_id=#&#123;topic&#125;</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-控制层-3"><a href="#2-控制层-3" class="headerlink" title="2.控制层"></a>2.控制层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/notice/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getNoticeList</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询评论内容</span></span><br><span class="line">    <span class="comment">//最新的一条评论通知</span></span><br><span class="line">    Message message=messageService.findLatestNotice(user.getId(),TOPIC_COMMENT);</span><br><span class="line">    Map&lt;String,Object&gt;messageVo=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    messageVo.put(<span class="string">&quot;message&quot;</span>,message);</span><br><span class="line">    <span class="keyword">if</span>(message!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//将json字符串里的特殊字符转义</span></span><br><span class="line">        String content= HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        <span class="comment">//content是以JSON对象存储的</span></span><br><span class="line">        HashMap&lt;String,Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">		<span class="comment">//产生事件的user</span></span><br><span class="line">        messageVo.put(<span class="string">&quot;user&quot;</span>,userService.findUserById((<span class="type">int</span>)data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        <span class="comment">//实体的类型</span></span><br><span class="line">        messageVo.put(<span class="string">&quot;entityType&quot;</span>,data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        <span class="comment">//实体的id</span></span><br><span class="line">        messageVo.put(<span class="string">&quot;entityId&quot;</span>,data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        <span class="comment">//帖子的id</span></span><br><span class="line">        messageVo.put(<span class="string">&quot;postId&quot;</span>,data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line">		<span class="comment">//查询评论通知数量总数</span></span><br><span class="line">        <span class="type">int</span> count=messageService.findNoticeCount(user.getId(),TOPIC_COMMENT);</span><br><span class="line">        messageVo.put(<span class="string">&quot;count&quot;</span>,count);</span><br><span class="line">		<span class="comment">//查询未读的评论通知数量</span></span><br><span class="line">        <span class="type">int</span> unreadCount=messageService.findNoticeUnreadCount(user.getId(),TOPIC_COMMENT);</span><br><span class="line">        messageVo.put(<span class="string">&quot;unread&quot;</span>,unreadCount);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;commentNotice&quot;</span>,messageVo);</span><br><span class="line">         <span class="comment">//查询未读消息数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">unreadLetterCount</span> <span class="operator">=</span> messageService.findUnreadLetter(user.getId(), <span class="literal">null</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;unreadLetterCount&quot;</span>,unreadLetterCount);</span><br><span class="line">        <span class="comment">//查询总共未读的通知数量</span></span><br><span class="line">        <span class="type">int</span> noticeUnreadCount=messageService.findNoticeUnreadCount(user.getId(),<span class="literal">null</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;noticeUnreadCount&quot;</span>,noticeUnreadCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/notice&quot;</span>;</span><br><span class="line">   	 &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-具体的消息内容"><a href="#3-具体的消息内容" class="headerlink" title="3.具体的消息内容"></a>3.具体的消息内容</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/notice/detail/&#123;topic&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">noticeDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;topic&quot;)</span>String topic,Model model,Page page)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/notice/detail/&quot;</span>+topic);</span><br><span class="line">    page.setRows(messageService.findNoticeCount(user.getId(),topic));</span><br><span class="line"></span><br><span class="line">    List&lt;Message&gt; notices = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;noticeVoList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (notices!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Message notice : notices) &#123;</span><br><span class="line">            Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">//通知</span></span><br><span class="line">            map.put(<span class="string">&quot;notice&quot;</span>,notice);</span><br><span class="line">            <span class="comment">//内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> HtmlUtils.htmlUnescape(notice.getContent());</span><br><span class="line">            HashMap&lt;String,Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>,userService.findUserById((<span class="type">int</span>)data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">            map.put(<span class="string">&quot;entityType&quot;</span>,data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;entityId&quot;</span>,data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;postId&quot;</span>,data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line">            <span class="comment">//通知的作者</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">fromUser</span> <span class="operator">=</span> userService.findUserById(notice.getFromId());</span><br><span class="line">            map.put(<span class="string">&quot;fromUser&quot;</span>,fromUser);</span><br><span class="line"></span><br><span class="line">            noticeVoList.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;notices&quot;</span>,noticeVoList);</span><br><span class="line">    <span class="comment">//设置已读</span></span><br><span class="line">    List&lt;Integer&gt;ids=getLetterIds(notices);</span><br><span class="line">    <span class="keyword">if</span>(ids!=<span class="literal">null</span>&amp;&amp; !ids.isEmpty())&#123;</span><br><span class="line">        messageService.readMessage(ids);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/notice-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十七-Elasticsearch入门-社区搜索"><a href="#二十七-Elasticsearch入门-社区搜索" class="headerlink" title="二十七.Elasticsearch入门(社区搜索)"></a>二十七.Elasticsearch入门(社区搜索)</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230226135521624.png" alt="image-20230226135521624"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230226150344717.png" alt="image-20230226150344717"></p>
<h2 id="1-配置"><a href="#1-配置" class="headerlink" title="1.配置:"></a>1.配置:</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.elasticsearch.cluster-node</span>=<span class="string">127.0.0.1:9300</span></span><br><span class="line"><span class="attr">spring.elasticsearch.uris</span>= <span class="string">http://localhost:9200</span></span><br><span class="line"><span class="attr">elasticSearch.url</span>=<span class="string">127.0.0.1:9200</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticSearch.url&#125;&quot;)</span></span><br><span class="line">    String esUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">client</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>))</span><br><span class="line">                        .setRequestConfigCallback(<span class="keyword">new</span> <span class="title class_">RestClientBuilder</span>.RequestConfigCallback() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> RequestConfig.Builder <span class="title function_">customizeRequestConfig</span><span class="params">(RequestConfig.Builder builder)</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> builder.setConnectTimeout(<span class="number">5000</span> * <span class="number">1000</span>) <span class="comment">// 连接超时（默认为1秒）</span></span><br><span class="line">                                        .setSocketTimeout(<span class="number">6000</span> * <span class="number">1000</span>);<span class="comment">// 套接字超时（默认为30秒）//更改客户端的超时限制默认30秒现在改为100*1000分钟</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-es接口层"><a href="#2-es接口层" class="headerlink" title="2.es接口层"></a>2.es接口层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DiscussPostRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;DiscussPost,Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加一个返回类作为分页工具</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;DiscussPost&gt; list;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-业务层"><a href="#3-业务层" class="headerlink" title="3.业务层"></a>3.业务层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostRepository discussPostRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;client&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDiscussPost</span><span class="params">(DiscussPost discussPost)</span>&#123;</span><br><span class="line">        discussPostRepository.save(discussPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDiscussPost</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">        discussPostRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SearchResult <span class="title function_">SearchResult</span><span class="params">(String keyword, <span class="type">int</span> current, <span class="type">int</span> limit)</span>&#123;</span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;discusspost&quot;</span>);</span><br><span class="line">        <span class="comment">//高亮</span></span><br><span class="line">        HighlightBuilder highlightBuilder=<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">        highlightBuilder.field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        highlightBuilder.field(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        highlightBuilder.requireFieldMatch(<span class="literal">false</span>);</span><br><span class="line">        highlightBuilder.preTags(<span class="string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">        highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">//构建搜索条件</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">                .query(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">                .sort(SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .sort(SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .sort(SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .from(current)<span class="comment">// 指定从哪条开始查询</span></span><br><span class="line">                .size(limit)<span class="comment">// 需要查出的总记录条数</span></span><br><span class="line">                .highlighter(highlightBuilder);</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        SearchResponse searchResponse= <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span> total=<span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">             total=searchResponse.getHits().getTotalHits().value;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;DiscussPost&gt; list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchResponse.getHits().getHits()) &#123;</span><br><span class="line">            <span class="type">DiscussPost</span> <span class="variable">discussPost</span> <span class="operator">=</span> JSONObject.parseObject(hit.getSourceAsString(), DiscussPost.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理高亮显示的结果</span></span><br><span class="line">            <span class="type">HighlightField</span> <span class="variable">titleField</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (titleField != <span class="literal">null</span>) &#123;</span><br><span class="line">                discussPost.setTitle(titleField.getFragments()[<span class="number">0</span>].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">HighlightField</span> <span class="variable">contentField</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (contentField != <span class="literal">null</span>) &#123;</span><br><span class="line">                discussPost.setContent(contentField.getFragments()[<span class="number">0</span>].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(discussPost);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>(list,total);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-消息队列同步数据"><a href="#4-消息队列同步数据" class="headerlink" title="4.消息队列同步数据"></a>4.消息队列同步数据</h2><p>当回复一个帖子或者发布帖子时,我们通过kafka将数据同步到es中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消费发布事件</span></span><br><span class="line"><span class="meta">@KafkaListener(topics = &#123;TOPIC_PUBLISH_POST&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlePublishMessage</span><span class="params">(ConsumerRecord record)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(record==<span class="literal">null</span>||record.value()==<span class="literal">null</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息的内容为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">    <span class="keyword">if</span>(event==<span class="literal">null</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(event.getEntityId());</span><br><span class="line">    <span class="comment">//存到es中</span></span><br><span class="line">    elasticSearchService.saveDiscussPost(post);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-控制层"><a href="#5-控制层" class="headerlink" title="5.控制层"></a>5.控制层</h2><p>CommentController:</p>
<p>添加回复方法的最后追加:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//回复帖子相当于修改了帖子的状态,需要修改信息到es</span></span><br><span class="line"><span class="keyword">if</span>(comment.getEntityType()==ENTITY_TYPE_POST)&#123;</span><br><span class="line">    <span class="comment">//触发评论事件--&gt;搜索</span></span><br><span class="line">    event=<span class="keyword">new</span> <span class="title class_">Event</span>().setTopic(TOPIC_PUBLISH_POST)</span><br><span class="line">            .setUserId(comment.getId())</span><br><span class="line">            .setEntityId(ENTITY_TYPE_POST)</span><br><span class="line">            .setEntityId(discussPostId);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DiscussPostControlle添加帖子的最后追加:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Event event=<span class="keyword">new</span> <span class="title class_">Event</span>().setTopic(TOPIC_PUBLISH_POST)</span><br><span class="line">        .setUserId(user.getId())</span><br><span class="line">        .setEntityId(ENTITY_TYPE_POST)</span><br><span class="line">        .setEntityId(post.getId());</span><br><span class="line">eventProducer.fireEvent(event);</span><br></pre></td></tr></table></figure>

<p>搜索视图层:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/search&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">search</span><span class="params">(String keyword, Page page, Model model)</span>&#123;</span><br><span class="line">    <span class="type">SearchResult</span> <span class="variable">searchResult</span> <span class="operator">=</span> elasticSearchService.SearchResult(keyword, page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt;discussPosts=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;DiscussPost&gt; list = searchResult.getList();</span><br><span class="line">    <span class="keyword">if</span>(list!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (DiscussPost post : list) &#123;</span><br><span class="line">            Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;post&quot;</span>,post);</span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>,userService.findUserById(post.getUserId()));</span><br><span class="line"></span><br><span class="line">            map.put(<span class="string">&quot;likeCount&quot;</span>,likeService.findEntityLikeCount(ENTITY_TYPE_POST,post.getId()));</span><br><span class="line">            discussPosts.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>,discussPosts);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;keyword&quot;</span>,keyword);</span><br><span class="line">    <span class="comment">//分页信息</span></span><br><span class="line">    page.setPath(<span class="string">&quot;/search?keyword=&quot;</span>+keyword);</span><br><span class="line">    page.setRows(searchResult.getTotal()==<span class="number">0</span>?<span class="number">0</span>:(<span class="type">int</span>)searchResult.getTotal());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/search&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二十八-springsecurity"><a href="#二十八-springsecurity" class="headerlink" title="二十八.springsecurity"></a>二十八.springsecurity</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227120845866.png" alt="image-20230227120845866"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227120831437.png" alt="image-20230227120831437"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227161909892.png" alt="image-20230227161909892"></p>
<p>入门springsecurity博文:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuminglei1987/article/details/107538666?spm=1001.2014.3001.5506">https://blog.csdn.net/liuminglei1987/article/details/107538666?spm=1001.2014.3001.5506</a></p>
<h1 id="二十九-置顶-加精-删除"><a href="#二十九-置顶-加精-删除" class="headerlink" title="二十九.置顶,加精,删除"></a>二十九.置顶,加精,删除</h1><h2 id="0-引入依赖"><a href="#0-引入依赖" class="headerlink" title="0.引入依赖"></a>0.引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity5 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--thymeleaf与springsecurity整合的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="1-数据层-2"><a href="#1-数据层-2" class="headerlink" title="1.数据层"></a>1.数据层</h2><p>修改帖子中的type和status</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">int</span> <span class="title function_">updateType</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> type)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateStatus</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> status)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-逻辑层"><a href="#2-逻辑层" class="headerlink" title="2.逻辑层"></a>2.逻辑层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateType</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> type)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.updateType(id,type);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateStatus</span><span class="params">(<span class="type">int</span> id,<span class="type">int</span> status)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.updateStatus(id,status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-权限控制"><a href="#3-权限控制" class="headerlink" title="3.权限控制"></a>3.权限控制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title class_">CommunityConstant</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/resources/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//@Override</span></span><br><span class="line">    <span class="comment">//protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span></span><br><span class="line">    <span class="comment">//    super.configure(auth);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//授权</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">//需要登录才能访问的路径</span></span><br><span class="line">                .antMatchers(</span><br><span class="line">                    <span class="string">&quot;/user/setting&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/upload&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/discuss/add&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/comment/add/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/letter/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/notice/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/like&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/follow&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/unfollow&quot;</span></span><br><span class="line">                )</span><br><span class="line">                <span class="comment">//这三个任意一个都可以</span></span><br><span class="line">                .hasAnyAuthority(</span><br><span class="line">                    AUTHORITY_ADMIN,AUTHORITY_USER,AUTHORITY_MODERATOR</span><br><span class="line">                )</span><br><span class="line">                .antMatchers(</span><br><span class="line">                    <span class="string">&quot;/discuss/top&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/discuss/wonderful&quot;</span></span><br><span class="line">                ).hasAnyAuthority(</span><br><span class="line">                        AUTHORITY_MODERATOR</span><br><span class="line">                ) .antMatchers(</span><br><span class="line">                        <span class="string">&quot;/discuss/delete&quot;</span></span><br><span class="line">                ).hasAnyAuthority(</span><br><span class="line">                        AUTHORITY_ADMIN</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">//除了上面的几个请求,其他的谁都可以访问</span></span><br><span class="line">                .anyRequest().permitAll().and()</span><br><span class="line">                <span class="comment">//禁用csrf检查，正式环境需要开开</span></span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//权限不够时怎么处理</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                <span class="comment">//没有登录时怎么处理</span></span><br><span class="line">                .authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">AuthenticationEntryPoint</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        <span class="comment">//判断当前请求是普通请求还是异步请求</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">xRequestedWith</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;</span><br><span class="line">                            <span class="comment">//是异步请求</span></span><br><span class="line">                            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">                            writer.write(CommunityUtil.getJsonString(<span class="number">403</span>,<span class="string">&quot;您还未登录&quot;</span>));</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="comment">//是普通请求</span></span><br><span class="line">                            response.sendRedirect(request.getContextPath()+<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">//权限不足时怎么处理</span></span><br><span class="line">                .accessDeniedHandler(<span class="keyword">new</span> <span class="title class_">AccessDeniedHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        <span class="comment">//判断当前请求是普通请求还是异步请求</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">xRequestedWith</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith))&#123;</span><br><span class="line">                            <span class="comment">//是异步请求</span></span><br><span class="line">                            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">                            writer.write(CommunityUtil.getJsonString(<span class="number">403</span>,<span class="string">&quot;您没有访问此功能的权限&quot;</span>));</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="comment">//是普通请求</span></span><br><span class="line">                            response.sendRedirect(request.getContextPath()+<span class="string">&quot;/denied&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Security默认会拦截/logout的请求,进行退出处理</span></span><br><span class="line">        <span class="comment">//覆盖它默认的逻辑,才能执行我们自己退出的代码</span></span><br><span class="line">        http.logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/security/logout&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>同时在LoginTicketInterceptor中去除LoginRequiredInterceptor的作用:</p>
<p>在其中修改方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//从cookie中获取凭证</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> CookieUtil.getValue(request, <span class="string">&quot;ticket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ticket!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//表示登录了</span></span><br><span class="line">        <span class="comment">//查询凭证</span></span><br><span class="line">        <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> userService.findLoginTicket(ticket);</span><br><span class="line">        <span class="comment">//检查凭证是否有效</span></span><br><span class="line">        <span class="keyword">if</span>(loginTicket!=<span class="literal">null</span>&amp;&amp;loginTicket.getStatus()==<span class="number">0</span>&amp;&amp;loginTicket.getExpired().after(<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">            <span class="comment">//根据凭证查询用户</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(loginTicket.getUserId());</span><br><span class="line">            <span class="comment">//在本次请求中持有用户</span></span><br><span class="line">            hostHolder.setUser(user);</span><br><span class="line">            <span class="comment">//构建用户认证的结果,并存入securityContext,便于security授权</span></span><br><span class="line">            Authentication authentication=<span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(</span><br><span class="line">                    user,user.getPassword(),userService.getAuthorities(user.getId()));</span><br><span class="line">            SecurityContextHolder.setContext(<span class="keyword">new</span> <span class="title class_">SecurityContextImpl</span>(authentication));</span><br><span class="line">            <span class="comment">//增加登录凭证的有效时间</span></span><br><span class="line">            <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">            <span class="comment">//相差的毫秒数</span></span><br><span class="line">            <span class="type">long</span> diff=loginTicket.getExpired().getTime()-now.getTime();</span><br><span class="line">            <span class="keyword">if</span>(diff/(<span class="number">1000</span>*<span class="number">60</span>*<span class="number">60</span>)&lt;<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="comment">//凭证加两个小时</span></span><br><span class="line">                <span class="type">long</span> newTime=now.getTime()+<span class="number">2</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">                <span class="type">Date</span> <span class="variable">newExpired</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(newTime);</span><br><span class="line">                loginTicket.setExpired(newExpired);</span><br><span class="line">                <span class="type">String</span> <span class="variable">ticketKey</span> <span class="operator">=</span> redisKeyUtil.getTicketKey(loginTicket.getTicket());</span><br><span class="line">                redisTemplate.opsForValue().set(ticketKey,ticket);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在UserService添加方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得用户权限</span></span><br><span class="line"><span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt;getAuthorities(<span class="type">int</span> userId)&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.findUserById(userId);</span><br><span class="line">    List&lt;GrantedAuthority&gt;list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> <span class="title class_">GrantedAuthority</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getAuthority</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (user.getType())&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> AUTHORITY_ADMIN;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> AUTHORITY_MODERATOR;</span><br><span class="line">                <span class="keyword">default</span>:<span class="keyword">return</span> AUTHORITY_USER;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-前端-2"><a href="#4-前端-2" class="headerlink" title="4.前端"></a>4.前端</h2><p>发送请求:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    $(<span class="string">&quot;#topBtn&quot;</span>).<span class="title function_">click</span>(setTop)</span><br><span class="line">    $(<span class="string">&quot;#wonderfulBtn&quot;</span>).<span class="title function_">click</span>(setWonderful)</span><br><span class="line">    $(<span class="string">&quot;#deleteBtn&quot;</span>).<span class="title function_">click</span>(setDelete)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//置顶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setTop</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/discuss/top&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:$(<span class="string">&quot;#postId&quot;</span>).<span class="title function_">val</span>()&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">            data=$.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">            <span class="keyword">if</span>(data.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">                $(<span class="string">&quot;#topBtn&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>,<span class="string">&quot;disabled&quot;</span>)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setWonderful</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/discuss/wonderful&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:$(<span class="string">&quot;#postId&quot;</span>).<span class="title function_">val</span>()&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">            data=$.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">            <span class="keyword">if</span>(data.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">                $(<span class="string">&quot;#wonderfulBtn&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>,<span class="string">&quot;disabled&quot;</span>)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setDelete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/discuss/top&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;id&quot;</span>:$(<span class="string">&quot;#postId&quot;</span>).<span class="title function_">val</span>()&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">            data=$.<span class="title function_">parseJSON</span>(data)</span><br><span class="line">            <span class="keyword">if</span>(data.<span class="property">code</span>===<span class="number">0</span>)&#123;</span><br><span class="line">               location.<span class="property">href</span>=<span class="variable constant_">CONTEXT_PATH</span>+<span class="string">&quot;/index&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span> <span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://static.nowcoder.com/images/logo_87_87.png&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/css/global.css&#125;&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/css/discuss-detail.css&#125;&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">title</span>&gt;</span>牛客网-帖子详情<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    	<span class="tag">&lt;<span class="name">h6</span> <span class="attr">class</span>=<span class="string">&quot;mb-4&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://static.nowcoder.com/images/img/icons/ico-discuss.png&quot;</span>/&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;post.title&#125;&quot;</span>&gt;</span>备战春招，面试刷题跟他复习，一个月全搞定！<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;float-right&quot;</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;postId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;post.id&#125;&quot;</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger btn-sm&quot;</span> <span class="attr">id</span>=<span class="string">&quot;topBtn&quot;</span></span></span><br><span class="line"><span class="tag">								<span class="attr">th:disabled</span>=<span class="string">&quot;$&#123;post.type==1&#125;&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasAnyAuthority(&#x27;moderator&#x27;)&quot;</span>&gt;</span></span><br><span class="line">							置顶<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger btn-sm&quot;</span> <span class="attr">id</span>=<span class="string">&quot;wonderfulBtn&quot;</span></span></span><br><span class="line"><span class="tag">								<span class="attr">th:disabled</span>=<span class="string">&quot;$&#123;post.status==1&#125;&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasAnyAuthority(&#x27;moderator&#x27;)&quot;</span>&gt;</span>加精<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger btn-sm&quot;</span> <span class="attr">id</span>=<span class="string">&quot;deleteBtn&quot;</span></span></span><br><span class="line"><span class="tag">								<span class="attr">th:disabled</span>=<span class="string">&quot;$&#123;post.status==2&#125;&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;hasAnyAuthority(&#x27;admin&#x27;)&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="三十-Redis高级数据类型"><a href="#三十-Redis高级数据类型" class="headerlink" title="三十.Redis高级数据类型"></a>三十.Redis高级数据类型</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228132231779.png" alt="image-20230228132231779"></p>
<p>HyperLog</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hyperLogTest</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">hyperLog</span><span class="params">()</span> &#123;</span><br><span class="line">        String[]values=<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">        <span class="type">int</span> j=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            j=i%<span class="number">1000</span>;</span><br><span class="line">            values[j]=<span class="string">&quot;userTest_&quot;</span>+i;</span><br><span class="line">            <span class="keyword">if</span>(j==<span class="number">999</span>)&#123;</span><br><span class="line">                stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;hl2&quot;</span>,values);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//统计数量</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">hl2</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;hl2&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;count=&quot;</span>+hl2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//opsForHyperLogLog也可以合并几个key到新一个新的key,但是value重复的会被合并</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">Union</span><span class="params">()</span>&#123;</span><br><span class="line">        String redisKey1=<span class="string">&quot;testLog:1&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(redisKey1,<span class="string">&quot;&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">        String redisKey2=<span class="string">&quot;testLog:2&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">5000</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(redisKey2,<span class="string">&quot;&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">        String redisKey3=<span class="string">&quot;testLog:3&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">15000</span>; i &lt; <span class="number">20000</span>; i++) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(redisKey3,<span class="string">&quot;&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">        String redisKeyUnion=<span class="string">&quot;testUnion&quot;</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        stringRedisTemplate.opsForHyperLogLog().union(redisKeyUnion, redisKey1, redisKey2, redisKey3);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(redisKeyUnion);</span><br><span class="line">        System.out.println(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BitMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 签到功能:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">    String redisSignKey=<span class="string">&quot;userSign&quot;</span>;</span><br><span class="line">    <span class="comment">//假设今天是3月十号, 而三月五号未签到,其他天都签到了</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;<span class="number">11</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(i!=<span class="number">5</span>)&#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().setBit(redisSignKey,i-<span class="number">1</span>,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> index=<span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    List&lt;Long&gt; longs = stringRedisTemplate.opsForValue().bitField(redisSignKey</span><br><span class="line">            , BitFieldSubCommands.create().get(BitFieldSubCommands.BitFieldType.unsigned(index)).valueAt(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">if</span>(longs==<span class="literal">null</span>||longs.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> longs.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(num==<span class="literal">null</span>||num==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询总共签到了几次:</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">RedisCallback</span>&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="keyword">return</span> connection.bitCount(redisSignKey.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(o);</span><br><span class="line">    <span class="comment">//查询连续签到了几天</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>((num&amp;<span class="number">1</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            count++;</span><br><span class="line">            num&gt;&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;连续签到了几天: &quot;</span>+count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三十一-网站数据统计"><a href="#三十一-网站数据统计" class="headerlink" title="三十一.网站数据统计"></a>三十一.网站数据统计</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228144737349.png" alt="image-20230228144737349"></p>
<h2 id="1-业务层-2"><a href="#1-业务层-2" class="headerlink" title="1.业务层"></a>1.业务层</h2><p>使用HyperLogLog统计:</p>
<p>利用每天的日期,生成一个Key,将ip作为值加入HyperlogLog中,最后可以统计出改天总共的UV量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将指定ip计入UV</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUV</span><span class="params">(String ip)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> redisKeyUtil.getUVKey(simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    redisTemplate.opsForHyperLogLog().add(redisKey,ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>统计指定日期的UV:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//统计指定日期范围内的UV</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">calculateUV</span><span class="params">(Date start,Date end)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(start==<span class="literal">null</span>||end==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//整理日期范围内的key</span></span><br><span class="line">    List&lt;String&gt;keyList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//利用CalenDar判断给定的日期的先后顺序</span></span><br><span class="line">    Calendar calendar=Calendar.getInstance();</span><br><span class="line">    calendar.setTime(start);</span><br><span class="line">    <span class="comment">//若设定的日期小于或等于end</span></span><br><span class="line">    <span class="keyword">while</span> (!calendar.getTime().after(end))&#123;</span><br><span class="line">        <span class="comment">//得到指定的日期的UVKey</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uvKey</span> <span class="operator">=</span> redisKeyUtil.getUVKey(simpleDateFormat.format(calendar.getTime()));</span><br><span class="line">       </span><br><span class="line">        keyList.add(uvKey);</span><br><span class="line">        <span class="comment">//往后推一天</span></span><br><span class="line">        calendar.add(Calendar.DATE,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//合并这些数据</span></span><br><span class="line">    <span class="keyword">if</span> (keyList.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uvKey</span> <span class="operator">=</span> redisKeyUtil.getUVKey(simpleDateFormat.format(start), simpleDateFormat.format(end));</span><br><span class="line">    redisTemplate.opsForHyperLogLog().union(uvKey, keyList.toArray());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回统计的数据大小</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(uvKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似的,DAU也是该种逻辑:</p>
<p>用户登录网站后,利用当前的登陆日期生成key,将该key的bitmap位(用户id的位次,比如用户id为102,就将102位设置为1):</p>
<p>之后再统计指定日期范围内的bitmap有多少位1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将指定用户计入DAU</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDAU</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dauKey</span> <span class="operator">=</span> redisKeyUtil.getDAUKey(simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    <span class="comment">//用户id是多少,就把多少位设置为1</span></span><br><span class="line">    redisTemplate.opsForValue().setBit(dauKey,userId,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//指定日期范围内的DAU</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">calculateDAU</span><span class="params">(Date start,Date end)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(start==<span class="literal">null</span>||end==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//整理日期范围内的key</span></span><br><span class="line">    List&lt;<span class="type">byte</span>[]&gt;keyList=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    Calendar calendar=Calendar.getInstance();</span><br><span class="line">    calendar.setTime(start);</span><br><span class="line">    <span class="keyword">while</span> (!calendar.getTime().after(end))&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dauKey</span> <span class="operator">=</span> redisKeyUtil.getDAUKey(simpleDateFormat.format(calendar.getTime()));</span><br><span class="line">        keyList.add(dauKey.getBytes());</span><br><span class="line">        calendar.add(Calendar.DATE,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//进行运算</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span>)redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">RedisCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">doInRedis</span><span class="params">(RedisConnection redisConnection)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">dauKey</span> <span class="operator">=</span> redisKeyUtil.getDAUKey(simpleDateFormat.format(start), simpleDateFormat.format(end));</span><br><span class="line">            redisConnection.bitOp(RedisStringCommands.BitOperation.OR,</span><br><span class="line">                    dauKey.getBytes(),keyList.toArray(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>][<span class="number">0</span>]));</span><br><span class="line">            <span class="keyword">return</span> redisConnection.bitCount(dauKey.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-拦截器-1"><a href="#2-拦截器-1" class="headerlink" title="2.拦截器"></a>2.拦截器</h2><p>由于在每个请求到达controller前都要将访问数据写入到redis中,所以最好使用拦截器完成这个工作:</p>
<p>拦截器将每次请求的ip和userid写入到redis中,以供后续表现层获取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DataService dataService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder holder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//统计UV</span></span><br><span class="line">        String ip=request.getRemoteHost();</span><br><span class="line">        dataService.recordUV(ip);</span><br><span class="line">        <span class="comment">//统计DAU</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> holder.getUser();</span><br><span class="line">        <span class="keyword">if</span>(user!=<span class="literal">null</span>)&#123;</span><br><span class="line">            dataService.recordDAU(user.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-表现层"><a href="#3-表现层" class="headerlink" title="3.表现层"></a>3.表现层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DataService dataService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/data&quot;,method = &#123;RequestMethod.GET,RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDataPage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/admin/data&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计UV情况</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/data/uv&quot;)</span></span><br><span class="line">      <span class="comment">//@DateTimeFormat指定日期格式</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUV</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start</span></span><br><span class="line"><span class="params">            , <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">uv</span> <span class="operator">=</span> dataService.calculateUV(start, end);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uv&quot;</span>,uv);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uvStartDate&quot;</span>,start);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uvEndDate&quot;</span>,end);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/data&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//统计网站DAU</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/data/dau&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDAU</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start</span></span><br><span class="line"><span class="params">            , <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">dau</span> <span class="operator">=</span> dataService.calculateDAU(start, end);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dau&quot;</span>,dau);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dauStartDate&quot;</span>,start);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dauEndDate&quot;</span>,end);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/data&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三十二-任务调度与执行"><a href="#三十二-任务调度与执行" class="headerlink" title="三十二.任务调度与执行"></a>三十二.任务调度与执行</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228190138987.png" alt="image-20230228190138987"></p>
<h1 id="三十三-热帖排行"><a href="#三十三-热帖排行" class="headerlink" title="三十三.热帖排行"></a>三十三.热帖排行</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228194831352.png" alt="image-20230228194831352"></p>
<p>使用quartz进行分布式任务调度</p>
<p>quartz第一次运行时会将配置信息读入到数据库中,之后会从数据库中读取,不再从配置信息中读取</p>
<h2 id="1-引入pom文件"><a href="#1-引入pom文件" class="headerlink" title="1.引入pom文件:"></a>1.引入pom文件:</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-quartz --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-编写任务类"><a href="#2-编写任务类" class="headerlink" title="2.编写任务类:"></a>2.编写任务类:</h2><p>按照上面给的分数公式计算. 每次加精,评论,点赞都会让帖子分数增加.所以我们在处理这些请求的方法中将帖子id加入到redis中(加入到set集合中). 每过一段时间利用quartz定时计算帖子的分数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算帖子分数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">postScoreKey</span> <span class="operator">=</span> redisKeyUtil.getPostScoreKey();</span><br><span class="line">redisTemplate.opsForSet().add(postScoreKey,post.getId());</span><br></pre></td></tr></table></figure>

<p>具体的逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostScoreRefreshJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span>, CommunityConstant &#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger= LoggerFactory.getLogger(PostScoreRefreshJob.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ElasticSearchService elasticSearchService;</span><br><span class="line">    <span class="comment">//牛客纪元</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Date epoch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            epoch=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).parse(<span class="string">&quot;2014-08-01 00:00:00&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;初始化牛客纪元失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//统计分数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">postScoreKey</span> <span class="operator">=</span> redisKeyUtil.getPostScoreKey();</span><br><span class="line">        BoundSetOperations Operations=redisTemplate.boundSetOps(postScoreKey);</span><br><span class="line">        <span class="comment">//没有任何变化</span></span><br><span class="line">        <span class="keyword">if</span>(Operations.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;任务取消,没有需要刷新的帖子&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;[任务开始],正在刷新帖子分数:&quot;</span>+Operations.size());</span><br><span class="line">        <span class="keyword">while</span> (Operations.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//刷新帖子的分数</span></span><br><span class="line">            <span class="built_in">this</span>.refresh((Integer)Operations.pop());</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;[任务结束]帖子分数刷新完毕&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(<span class="type">int</span> postId)</span>&#123;</span><br><span class="line">        <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(postId);</span><br><span class="line">        <span class="keyword">if</span>(post==<span class="literal">null</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;该帖子不存在: id=&quot;</span>+postId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//是否加精</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wonderful</span> <span class="operator">=</span> post.getStatus() == <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//评论数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">commentCount</span> <span class="operator">=</span> post.getCommentCount();</span><br><span class="line">        <span class="comment">//点赞数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算权重</span></span><br><span class="line">        <span class="type">double</span> w=(wonderful?<span class="number">75</span>:<span class="number">0</span>)+commentCount*<span class="number">10</span>+likeCount*<span class="number">2</span>;</span><br><span class="line">        <span class="comment">//分数=帖子的权重加上距离天数</span></span><br><span class="line">        <span class="type">double</span> score=Math.log10(Math.max(w,<span class="number">1</span>))</span><br><span class="line">                +(post.getCreateTime().getTime()-epoch.getTime())/(<span class="number">1000</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>);</span><br><span class="line">        <span class="comment">//更新帖子分数</span></span><br><span class="line">        discussPostService.updateScore(postId,score);</span><br><span class="line">        <span class="comment">//同步es</span></span><br><span class="line">        post.setScore(score);</span><br><span class="line">        elasticSearchService.saveDiscussPost(post);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-编写配置类"><a href="#3-编写配置类" class="headerlink" title="3.编写配置类"></a>3.编写配置类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置刷新帖子分数任务</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JobDetailFactoryBean <span class="title function_">postScoreRefreshJobDetail</span><span class="params">()</span>&#123;</span><br><span class="line">    JobDetailFactoryBean factoryBean=<span class="keyword">new</span> <span class="title class_">JobDetailFactoryBean</span>();</span><br><span class="line">    factoryBean.setJobClass(PostScoreRefreshJob.class);</span><br><span class="line">    factoryBean.setName(<span class="string">&quot;postScoreRefreshJob&quot;</span>);</span><br><span class="line">    factoryBean.setGroup(<span class="string">&quot;communityJobGroup&quot;</span>);</span><br><span class="line">    <span class="comment">//任务是长久保存</span></span><br><span class="line">    factoryBean.setDurability(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//任务是否是可恢复的</span></span><br><span class="line">    factoryBean.setRequestsRecovery(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//                      简单                      复杂</span></span><br><span class="line"><span class="comment">//配置trigger(SimpleTriggerFactoryBean or CronTriggerFactoryBean)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SimpleTriggerFactoryBean <span class="title function_">postScoreRefreshTrigger</span><span class="params">(JobDetail postScoreRefreshJobDetail)</span>&#123;</span><br><span class="line">    SimpleTriggerFactoryBean stfb=<span class="keyword">new</span> <span class="title class_">SimpleTriggerFactoryBean</span>();</span><br><span class="line">    stfb.setJobDetail(postScoreRefreshJobDetail);</span><br><span class="line">    stfb.setName(<span class="string">&quot;postScoreRefreshTrigger&quot;</span>);</span><br><span class="line">    stfb.setGroup(<span class="string">&quot;communityTriggerGroup&quot;</span>);</span><br><span class="line">    <span class="comment">//五分钟执行一遍</span></span><br><span class="line">    stfb.setRepeatInterval(<span class="number">1000</span>*<span class="number">60</span>*<span class="number">5</span>);</span><br><span class="line">    stfb.setJobDataMap(<span class="keyword">new</span> <span class="title class_">JobDataMap</span>());</span><br><span class="line">    <span class="keyword">return</span> stfb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-重构帖子查询逻辑"><a href="#4-重构帖子查询逻辑" class="headerlink" title="4.重构帖子查询逻辑"></a>4.重构帖子查询逻辑</h2><p>现在就需要加判断是佛需要按照score排序的逻辑了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询评论,带有分页</span></span><br><span class="line">List&lt;DiscussPost&gt;selectDiscussPosts(<span class="type">int</span> userId,<span class="type">int</span> offset,<span class="type">int</span> limit,<span class="type">int</span> orderMode);</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPosts&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;DiscussPost&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from discuss_post</span><br><span class="line">    where status!=2</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId!=0&quot;</span>&gt;</span></span><br><span class="line">        and user_id=#&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;orderMode==0&quot;</span>&gt;</span></span><br><span class="line">        order by type desc,create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;orderMode==1&quot;</span>&gt;</span></span><br><span class="line">        order by type desc,score desc,create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>orderMode在请求地址的查询参数中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/index&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getIndexPage</span><span class="params">(Model model, Page page,<span class="meta">@RequestParam(name = &quot;orderMode&quot;,defaultValue = &quot;0&quot;)</span> <span class="type">int</span> orderMode)</span>&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:class</span>=<span class="string">&quot;|nav-link $&#123;orderMode==1?&#x27;active&#x27;:&#x27;&#x27;&#125;|&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/index(orderMode=1)&#125;&quot;</span>&gt;</span>最热<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="三十四-生成长图"><a href="#三十四-生成长图" class="headerlink" title="三十四.生成长图"></a>三十四.生成长图</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230301133515711.png" alt="image-20230301133515711"></p>
<p>下载完安装包之后,可以在控制台直接输入即可将网址内容保存为pdf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltopdf 网址 存储地址</span><br></pre></td></tr></table></figure>

<p>同理:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wkhtmltoimage 网址 存储地址</span><br></pre></td></tr></table></figure>

<p>保存为图像</p>
<p>使用java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/share&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">//查询参数为(?htmlUrl=www.xxx....)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">share</span><span class="params">(String htmlUrl)</span>&#123;</span><br><span class="line">    <span class="comment">//文件名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> CommunityUtil.generateUUID();</span><br><span class="line">    <span class="comment">//异步生成长图</span></span><br><span class="line">    Event event=<span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">            .setTopic(TOPIC_Share)</span><br><span class="line">            .setData(<span class="string">&quot;htmlUrl&quot;</span>,htmlUrl)</span><br><span class="line">            .setData(<span class="string">&quot;filename&quot;</span>,filename)</span><br><span class="line">            .setData(<span class="string">&quot;suffix&quot;</span>,<span class="string">&quot;.png&quot;</span>);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回访问路径</span></span><br><span class="line">    Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//map.put(&quot;setUrl&quot;,domain+context+&quot;/share/image/&quot;+filename);</span></span><br><span class="line">    map.put(<span class="string">&quot;setUrl&quot;</span>,shareBucketUrl+<span class="string">&quot;/&quot;</span>+filename);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="literal">null</span>,map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//废弃</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/share/image/&#123;filename&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSetImage</span><span class="params">(<span class="meta">@PathVariable(&quot;filename&quot;)</span>String filename, HttpServletResponse response)</span>  &#123;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(filename))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;文件名不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.setContentType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storage + <span class="string">&quot;/&quot;</span> + filename + <span class="string">&quot;.png&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        FileInputStream fis=<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">        <span class="type">byte</span>[] buffer=<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> flag=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((flag=fis.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            outputStream.write(buffer,<span class="number">0</span>,flag);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;获取长图失败: &quot;</span>+e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三十五-将文件上传至服务器"><a href="#三十五-将文件上传至服务器" class="headerlink" title="三十五.将文件上传至服务器"></a>三十五.将文件上传至服务器</h1><p>​	<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230301151854517.png" alt="image-20230301151854517"></p>
<p>​	申请七牛云的对象存储权限之后进行配置:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#qiniu</span></span><br><span class="line"><span class="attr">qiniu.key.acess</span>=<span class="string">-FpCBBfKorbxyem5I4UmOlHFxnwpDvhe8HpaZM_-</span></span><br><span class="line"><span class="attr">qiniu.key.secret</span>=<span class="string">AxeHBUcTxreXioMLI16uZcte9c4cAwszZF5g7aBj</span></span><br><span class="line"><span class="attr">qiniu.bucket.header.name</span>=<span class="string">dylan-newcode</span></span><br><span class="line"><span class="attr">qiniu.bucket.header.url</span>=<span class="string">http://rqu0l3xtz.hn-bkt.clouddn.com</span></span><br><span class="line"><span class="attr">qiniu.bucket.share.name</span>=<span class="string">dylan-newcode-share</span></span><br><span class="line"><span class="attr">qiniu.bucket.share.url</span>=<span class="string">http://rqu0rpjdh.hd-bkt.clouddn.com</span></span><br></pre></td></tr></table></figure>

<h2 id="1-将头像上传到七牛云"><a href="#1-将头像上传到七牛云" class="headerlink" title="1.将头像上传到七牛云:"></a>1.将头像上传到七牛云:</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoginRequired</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/setting&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getSettingPage</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">    <span class="comment">//上传文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> CommunityUtil.generateUUID();</span><br><span class="line">    <span class="comment">//设置响应信息</span></span><br><span class="line">    StringMap police=<span class="keyword">new</span> <span class="title class_">StringMap</span>();</span><br><span class="line">    police.put(<span class="string">&quot;returnBody&quot;</span>,CommunityUtil.getJsonString(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">//上传身份凭证</span></span><br><span class="line">    Auth auth=Auth.create(accessKey,secretKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">uploadToken</span> <span class="operator">=</span> auth.uploadToken(headerBucketName, filename, <span class="number">3600</span>, police);</span><br><span class="line">    <span class="comment">//String uploadToken = auth.uploadToken(headerBucketName);</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;uploadToken&quot;</span>,uploadToken);</span><br><span class="line">     model.addAttribute(<span class="string">&quot;filename&quot;</span>,filename);</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/setting&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端"><a href="#前端" class="headerlink" title="前端:"></a>前端:</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;mt-5&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadForm&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row mt-4&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label text-right&quot;</span>&gt;</span>选择头像:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;custom-file&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;token&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;uploadToken&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;filename&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">class</span>=<span class="string">&quot;custom-file-input&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;head-image&quot;</span> <span class="attr">lang</span>=<span class="string">&quot;es&quot;</span> <span class="attr">required</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;custom-file-label&quot;</span> <span class="attr">for</span>=<span class="string">&quot;head-image&quot;</span> <span class="attr">data-browse</span>=<span class="string">&quot;文件&quot;</span>&gt;</span>选择一张图片<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;invalid-feedback&quot;</span>&gt;</span></span><br><span class="line">               xx</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row mt-4&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10 text-center&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info text-white form-control&quot;</span>&gt;</span>立即上传<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $(<span class="string">&quot;#uploadForm&quot;</span>).<span class="title function_">submit</span>(upload);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">upload</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;http://upload-z2.qiniup.com&quot;</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">processData</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">contentType</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">data</span>: <span class="keyword">new</span> <span class="title class_">FormData</span>($(<span class="string">&quot;#uploadForm&quot;</span>)[<span class="number">0</span>]),</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(data &amp;&amp; data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新头像访问路径</span></span><br><span class="line">                $.<span class="title function_">post</span>(</span><br><span class="line">                    <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/user/header/url&quot;</span>,</span><br><span class="line">                    &#123;<span class="string">&quot;filename&quot;</span>:$(<span class="string">&quot;input[name=&#x27;key&#x27;]&quot;</span>).<span class="title function_">val</span>()&#125;,</span><br><span class="line">                    <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">                        data = $.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">                        <span class="keyword">if</span>(data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">alert</span>(<span class="string">&quot;上传失败!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-将分享的长图上传到云服务器"><a href="#2-将分享的长图上传到云服务器" class="headerlink" title="2.将分享的长图上传到云服务器"></a>2.将分享的长图上传到云服务器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/share&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="comment">//查询参数为(?htmlUrl=www.xxx....)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">share</span><span class="params">(String htmlUrl)</span>&#123;</span><br><span class="line">    <span class="comment">//文件名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> CommunityUtil.generateUUID();</span><br><span class="line">    <span class="comment">//异步生成长图</span></span><br><span class="line">    Event event=<span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">            .setTopic(TOPIC_Share)</span><br><span class="line">            .setData(<span class="string">&quot;htmlUrl&quot;</span>,htmlUrl)</span><br><span class="line">            .setData(<span class="string">&quot;filename&quot;</span>,filename)</span><br><span class="line">            .setData(<span class="string">&quot;suffix&quot;</span>,<span class="string">&quot;.png&quot;</span>);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回访问路径</span></span><br><span class="line">    Map&lt;String,Object&gt;map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//map.put(&quot;setUrl&quot;,domain+context+&quot;/share/image/&quot;+filename);</span></span><br><span class="line">    map.put(<span class="string">&quot;setUrl&quot;</span>,shareBucketUrl+<span class="string">&quot;/&quot;</span>+filename);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJsonString(<span class="number">0</span>,<span class="literal">null</span>,map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskScheduler taskScheduler;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费分享事件</span></span><br><span class="line"><span class="meta">@KafkaListener(topics = &#123;TOPIC_Share&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleShare</span><span class="params">(ConsumerRecord record)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(record==<span class="literal">null</span>||record.value()==<span class="literal">null</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息的内容为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">    <span class="keyword">if</span>(event==<span class="literal">null</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">htmlUrl</span> <span class="operator">=</span>(String) event.getData().get(<span class="string">&quot;htmlUrl&quot;</span>);</span><br><span class="line">    String filename=(String) event.getData().get(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">    String suffix=(String) event.getData().get(<span class="string">&quot;suffix&quot;</span>);</span><br><span class="line">    <span class="comment">//命令字符串</span></span><br><span class="line">    String cmd=command+<span class="string">&quot; --quality 75 &quot;</span>+htmlUrl+<span class="string">&quot; &quot;</span>+storage+<span class="string">&quot;/&quot;</span>+filename+suffix;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        logger.info(<span class="string">&quot;生成长图&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;生成长图失败: &quot;</span>+e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//启用定时器,监视该图片,一旦生成了图片,就上传七牛云</span></span><br><span class="line">    uploadTask uploadTask=<span class="keyword">new</span> <span class="title class_">uploadTask</span>(filename,suffix);</span><br><span class="line">    <span class="type">Future</span> <span class="variable">future</span> <span class="operator">=</span> taskScheduler.scheduleAtFixedRate(uploadTask, <span class="number">500</span>);</span><br><span class="line">    uploadTask.setFuture(future);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">uploadTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line">    <span class="comment">//名称后缀</span></span><br><span class="line">    <span class="keyword">private</span> String suffix;</span><br><span class="line">    <span class="comment">//启动任务的返回值,用来停止定时器</span></span><br><span class="line">    <span class="keyword">private</span> Future future;</span><br><span class="line">    <span class="comment">//开始时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> startTime;</span><br><span class="line">    <span class="comment">//上传次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFuture</span><span class="params">(Future future)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.future = future;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">uploadTask</span><span class="params">(String filename, String suffix)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.filename = filename;</span><br><span class="line">        <span class="built_in">this</span>.suffix = suffix;</span><br><span class="line">        <span class="built_in">this</span>.startTime=System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//生成图片失败</span></span><br><span class="line">        <span class="keyword">if</span>(System.currentTimeMillis()-startTime&gt;<span class="number">30000</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;执行时间过长,终止任务 &quot;</span>+filename);</span><br><span class="line">            future.cancel(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//上传失败</span></span><br><span class="line">        <span class="keyword">if</span>(count&gt;=<span class="number">6</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;上传次数过多,终止任务:&quot;</span> +filename);</span><br><span class="line">            future.cancel(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String path=storage+<span class="string">&quot;/&quot;</span>+filename+suffix;</span><br><span class="line">        File file=<span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">        <span class="keyword">if</span>(file.exists())&#123;</span><br><span class="line">            logger.info(String.format(<span class="string">&quot;开始第%d次上传[%s]&quot;</span>,++count,filename));</span><br><span class="line">            <span class="comment">//设置响应信息</span></span><br><span class="line">            <span class="type">StringMap</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringMap</span>();</span><br><span class="line">            policy.put(<span class="string">&quot;returnBody&quot;</span>, CommunityUtil.getJsonString(<span class="number">0</span>));</span><br><span class="line">            <span class="comment">//生成上传凭证</span></span><br><span class="line">            Auth auth=Auth.create(accessKey,secretKey);</span><br><span class="line">            <span class="type">String</span> <span class="variable">uploadToken</span> <span class="operator">=</span> auth.uploadToken(shareBucketName, filename, <span class="number">3600</span>, policy);</span><br><span class="line">            <span class="comment">//指定上传的机房</span></span><br><span class="line">            UploadManager uploadManager=<span class="keyword">new</span> <span class="title class_">UploadManager</span>(<span class="keyword">new</span> <span class="title class_">Configuration</span>(Region.huadong()));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//开始上传图片</span></span><br><span class="line">                Response response=uploadManager.put(</span><br><span class="line">                        path,filename,uploadToken,<span class="literal">null</span>,<span class="string">&quot;image&quot;</span>+suffix,<span class="literal">false</span></span><br><span class="line">                );</span><br><span class="line">                <span class="comment">//处理响应结果</span></span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(response.bodyString());</span><br><span class="line">                System.out.println(jsonObject.get(<span class="string">&quot;code&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span>(jsonObject==<span class="literal">null</span>||jsonObject.get(<span class="string">&quot;code&quot;</span>)==<span class="literal">null</span>||!jsonObject.get(<span class="string">&quot;code&quot;</span>).toString().equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">                    logger.info(String.format(<span class="string">&quot;第%d上传失败[%s]&quot;</span>,count,filename));</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    logger.info(String.format(<span class="string">&quot;第%d上传成功[%s]&quot;</span>,count,filename));</span><br><span class="line">                    future.cancel(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (QiniuException e)&#123;</span><br><span class="line">                logger.info(String.format(<span class="string">&quot;第%d上传失败[%s]&quot;</span>,count,filename));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;等待图片生成 [&quot;</span>+filename+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用spring自带的异步线程池需要配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三十六-优化网站的性能"><a href="#三十六-优化网站的性能" class="headerlink" title="三十六.优化网站的性能"></a>三十六.优化网站的性能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302133451485.png" alt="image-20230302133451485"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302145706823.png" alt="image-20230302145706823"></p>
<h1 id="三十七-总结"><a href="#三十七-总结" class="headerlink" title="三十七.总结"></a>三十七.总结</h1><h2 id="1-单元测试"><a href="#1-单元测试" class="headerlink" title="1.单元测试"></a>1.单元测试</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302150141005.png" alt="image-20230302150141005"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = NewCodeApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">springbootTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DiscussPost data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试启动前被调用一次</span></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beforeClass</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beforeClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//测试启动后被调用一次</span></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">afterClass</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个方法之前都会调用</span></span><br><span class="line">    <span class="comment">//测试前创造数据</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化测试数据</span></span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">DiscussPost</span>();</span><br><span class="line">        data.setUserId(<span class="number">111</span>);</span><br><span class="line">        data.setTitle(<span class="string">&quot;Test Title&quot;</span>);</span><br><span class="line">        data.setContent(<span class="string">&quot;Test Content&quot;</span>);</span><br><span class="line">        data.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        discussPostService.addDiscussPost(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个方法之=之后都会调用</span></span><br><span class="line">    <span class="comment">//测试后删除数据</span></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">        <span class="comment">// 删除测试数据</span></span><br><span class="line">        discussPostService.updateStatus(data.getId(), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(data.getId());</span><br><span class="line">        <span class="comment">//断言</span></span><br><span class="line">        Assert.assertNotNull(post);</span><br><span class="line">        Assert.assertEquals(data.getTitle(), post.getTitle());</span><br><span class="line">        Assert.assertEquals(data.getContent(), post.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateScore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> discussPostService.updateScore(data.getId(), <span class="number">2000.00</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, rows);</span><br><span class="line"></span><br><span class="line">        <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.selectDiscussPostById(data.getId());</span><br><span class="line">        Assert.assertEquals(<span class="number">2000.00</span>, post.getScore(), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-项目监控"><a href="#2-项目监控" class="headerlink" title="2.项目监控"></a>2.项目监控</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302151754621.png" alt="image-20230302151754621"></p>
<h2 id="3-部署"><a href="#3-部署" class="headerlink" title="3.部署"></a>3.部署</h2><p>暂时跳过</p>
<h2 id="4-项目总结"><a href="#4-项目总结" class="headerlink" title="4.项目总结"></a>4.项目总结</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302160812156.png" alt="image-20230302160812156"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Dylan Pan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://dyylan99.github.io/2023/03/21/niu-ke-shou-ye-xiang-mu/">https://dyylan99.github.io/2023/03/21/niu-ke-shou-ye-xiang-mu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Dylan Pan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/03/24/zhong-jian-jian-kai-fa-springboot/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="springboot中间件开发">
                        
                        <span class="card-title">springboot中间件开发</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring/" class="post-category">
                                    spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">spring,中间件</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02/09/spring-mini/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="手写springIOC,AOP核心原理">
                        
                        <span class="card-title">手写springIOC,AOP核心原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring/">
                        <span class="chip bg-color">Spring</span>
                    </a>
                    
                    <a href="/tags/%E6%A1%86%E6%9E%B6/">
                        <span class="chip bg-color">框架</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="song"
                   id="26807310"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">Dylan Pan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">263.6k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/DylanToT99" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1975131479@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1975131479" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1975131479" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
