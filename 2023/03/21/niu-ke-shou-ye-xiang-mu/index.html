<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="仿牛客项目, 认言知">
    <meta name="description" content="一.开发社区首页开发流程:

一次请求的过程

分步实现

开发社区首页,显示前十个帖子
开发分页组件,分页显示所有帖子

后端关键点一:​	由于查询discussPost表时会查询到用户id,而我们在前端页面上现实的是用户的姓名,那么就需">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>仿牛客项目 | 认言知</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.1.1"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">认言知</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">认言知</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">仿牛客项目</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                后端
                            </a>
                        
                            <a href="/categories/%E5%90%8E%E7%AB%AF/spring/" class="post-category">
                                spring
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-03-21
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    19.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    100 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="一-开发社区首页"><a href="#一-开发社区首页" class="headerlink" title="一.开发社区首页"></a>一.开发社区首页</h1><p>开发流程:</p>
<ul>
<li>一次请求的过程</li>
</ul>
<p>分步实现</p>
<ul>
<li>开发社区首页,显示前十个帖子</li>
<li>开发分页组件,分页显示所有帖子</li>
</ul>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><h3 id="关键点一"><a href="#关键点一" class="headerlink" title="关键点一:"></a>关键点一:</h3><p>​	由于查询discussPost表时会查询到用户id,而我们在前端页面上现实的是用户的姓名,那么就需要根据用户id查询姓名. 作法有两种,第一种是连表查询. 第二种是根据查到的id到用户表中查找姓名,最后再同一封装给前端:本项目采用第一种方案:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210317222.png" alt="image-20230217210317222"></p>
<h3 id="关键点二"><a href="#关键点二" class="headerlink" title="关键点二:"></a>关键点二:</h3><p>关于springmvc对于方法中的model和其他参数的问题:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210546363.png" alt="image-20230217210546363"></p>
<h2 id="前端-thymeleaf"><a href="#前端-thymeleaf" class="headerlink" title="前端(thymeleaf)"></a>前端(thymeleaf)</h2><h3 id="关键点一-1"><a href="#关键点一-1" class="headerlink" title="关键点一:"></a>关键点一:</h3><p>关于thymeleaf的语法问题:</p>
<p>通常使用  <strong>${}</strong> 的形式接受后端传过来的参数,而使用 xx: **${yy}**可以为参数取别名:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217210824347.png" alt="image-20230217210824347"></p>
<p><strong>th:if</strong>用于判断条件,条件成立则显示html的内容,否则不显示:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211008030.png" alt="image-20230217211008030"></p>
<p>thymeleaf关于时间日期的格式转换,采用内置的函数#dates.format(date,format):</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211238698.png" alt="image-20230217211238698"></p>
<p><strong>th:utext</strong>会将特殊字符转义,th:text则不会</p>
<h3 id="关键点二-1"><a href="#关键点二-1" class="headerlink" title="关键点二:"></a>关键点二:</h3><p>有一些相对路径的静态资源时,通常需要使用</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211422825.png" alt="image-20230217211422825"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217211433609.png" alt="image-20230217211433609"></p>
<p>这样就会让程序从static目录下寻找静态资源了</p>
<p>而在请求路径中这样写是相对于整个项目的路径如:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212449870.png" alt="image-20230217212449870"></p>
<p>请求路径为:<a target="_blank" rel="noopener" href="http://localhost:8080/community/index?current=1">http://localhost:8080/community/index?current=1</a></p>
<h3 id="关键点三"><a href="#关键点三" class="headerlink" title="关键点三:"></a>关键点三:</h3><p>动态为html标签添加类:| 固定类名,  ${条件语句} |</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212634231.png" alt="image-20230217212634231"></p>
<p>同时,themeleaf还有创建连续数数组<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230217212758254.png" alt="image-20230217212758254">的方法,#numbers.sequence(a,b)—&gt;创建从a到b的数组</p>
<h1 id="二-发送邮件"><a href="#二-发送邮件" class="headerlink" title="二.发送邮件"></a>二.发送邮件</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218141925711.png" alt="image-20230218141925711"></p>
<h2 id="1-启动代发送邮件客户端的smtp功能"><a href="#1-启动代发送邮件客户端的smtp功能" class="headerlink" title="1.启动代发送邮件客户端的smtp功能,"></a>1.启动代发送邮件客户端的smtp功能,</h2><p>本人使用的是qq邮箱,那么就要从设置中启用:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218164836043.png" alt="image-20230218164836043"></p>
<h2 id="2-导入spring-email相关的jar包"><a href="#2-导入spring-email相关的jar包" class="headerlink" title="2.导入spring email相关的jar包"></a>2.导入spring email相关的jar包</h2><pre><code class="xml">  &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-mail&lt;/artifactId&gt;
            &lt;version&gt;2.7.8&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<h2 id="3-配置邮箱参数"><a href="#3-配置邮箱参数" class="headerlink" title="3.配置邮箱参数"></a>3.配置邮箱参数</h2><pre><code class="properties">spring.mail.host=smtp.qq.com
spring.mail.port=465
spring.mail.username=1975131479@qq.com
spring.mail.password=idhhgkpulgrufaac
spring.mail.protocol=smtps
spring.mail.properties.mail.smtp.ssl.enable=true
spring.mail.properties.mail.smtl.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
</code></pre>
<h2 id="4-使用JavaMailSender发送邮件"><a href="#4-使用JavaMailSender发送邮件" class="headerlink" title="4.使用JavaMailSender发送邮件"></a>4.使用JavaMailSender发送邮件</h2><p>创建发送工具类:</p>
<pre><code class="java">@Component
public class MailClient &#123;
    private static final Logger logger= LoggerFactory.getLogger(MailClient.class);

    @Resource
    private JavaMailSender mailSender;
    

    @Value(&quot;$&#123;spring.mail.username&#125;&quot;)
    private String from;

    public void sendMail(String to,String subject,String content)&#123;

        try &#123;
            MimeMessage message=mailSender.createMimeMessage();
            MimeMessageHelper helper=new MimeMessageHelper(message);
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(content,true);
            mailSender.send(helper.getMimeMessage());
        &#125; catch (MessagingException e) &#123;
           logger.error(&quot;发送邮件失败:&quot;+e.getMessage());
        &#125;

    &#125;
&#125;
</code></pre>
<p>测试:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218165210336.png" alt="image-20230218165210336"></p>
<h2 id="5-引入thymeleaf引擎发送html邮件"><a href="#5-引入thymeleaf引擎发送html邮件" class="headerlink" title="5.引入thymeleaf引擎发送html邮件:"></a>5.引入thymeleaf引擎发送html邮件:</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218165309093.png" alt="image-20230218165309093"></p>
<h1 id="三-开发注册功能"><a href="#三-开发注册功能" class="headerlink" title="三.开发注册功能"></a>三.开发注册功能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218145913743.png" alt="image-20230218145913743"></p>
<h2 id="1-开发访问注册页面"><a href="#1-开发访问注册页面" class="headerlink" title="1.开发访问注册页面"></a>1.开发访问注册页面</h2><p>控制层中直接加入代码:</p>
<pre><code class="java">@GetMapping(&quot;/register&quot;)
public String getRegisterPage()&#123;
    return &quot;/site/register&quot;;
&#125;
</code></pre>
<h2 id="2-提交注册数据-注册激活账号"><a href="#2-提交注册数据-注册激活账号" class="headerlink" title="2.提交注册数据,注册激活账号"></a>2.提交注册数据,注册激活账号</h2><p>业务层中加入如下代码:</p>
<pre><code class="java">@Value(&quot;$&#123;community.path.domain&#125;&quot;)
private String domain;

@Value(&quot;$&#123;server.servlet.context-path&#125;&quot;)
private String contextPath;

public User findUserById(int id)&#123;
    return userMapper.selectById(id);
&#125;
//注册方法
public Map&lt;String,Object&gt;register(User user)&#123;
    //map作为传给前端的值
    Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
    //对空值进行判断处理
    if(user==null)&#123;
        throw new IllegalArgumentException(&quot;参数不能为空!&quot;);
    &#125;
    if(StringUtils.isBlank(user.getUsername()))&#123;
        map.put(&quot;usernameMessage&quot;,&quot;账号不能为空&quot;);
        return map;
    &#125;
    if(StringUtils.isBlank(user.getPassword()))&#123;
        map.put(&quot;passwordMessage&quot;,&quot;密码不能为空&quot;);
        return map;
    &#125;
    if(StringUtils.isBlank(user.getEmail()))&#123;
        map.put(&quot;emailMessage&quot;,&quot;邮箱不能为空&quot;);
        return map;
    &#125;

    //验证账号是否已经存在
    User user1 = userMapper.selectByName(user.getUsername());
    if(user1!=null)&#123;
        map.put(&quot;usernameMessage&quot;,&quot;该账号已经存在&quot;);
        return map;
    &#125;

    //验证邮箱
    User user2 = userMapper.selectByEmail(user.getEmail());
    if(user2!=null)&#123;
        map.put(&quot;emailMessage&quot;,&quot;该邮箱已被注册&quot;);
        return map;
    &#125;

    //注册用户
    //盐的长度设置为5位
    user.setSalt(CommunityUtil.generateUUID().substring(0,5));
    user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
    user.setType(0);
    //0表示暂未激活
    user.setStatus(0);
    //生成激活码
    user.setActivationCode(CommunityUtil.generateUUID());
    user.setHeaderUrl(String.format(&quot;http://images.nowcoder.com/head/%dt.png&quot;,new Random().nextInt(1000)));
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    //发送激活邮件
    Context context=new Context();
    context.setVariable(&quot;email&quot;,user.getEmail());
    //通过地址的方式传递账户id和激活码,用户只需要点击一下激活就可以
    //http://localhost:8080/community/activation/101/code
    String url=domain+contextPath+&quot;/activation/&quot;+user.getId()+&quot;/&quot;+user.getActivationCode();
    context.setVariable(&quot;url&quot;,url);
    String content=templateEngine.process(&quot;/mail/activation&quot;,context);
    mailClient.sendMail(user.getEmail(),&quot;激活牛客账号&quot;,content);

    return map;
&#125;
</code></pre>
<p>其中注册成功和激活成功的结果都是返回同一个页面,但是页面的内容根据结果而定:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170058916.png" alt="image-20230218170058916"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170122721.png" alt="image-20230218170122721"></p>
<p>该页面的关键点在于提示信息,和跳转的页面</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230218170212433.png" alt="image-20230218170212433"></p>
<h1 id="四-生成验证码"><a href="#四-生成验证码" class="headerlink" title="四.生成验证码"></a>四.生成验证码</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219134332696.png" alt="image-20230219134332696"></p>
<h2 id="1-导入jar包"><a href="#1-导入jar包" class="headerlink" title="1.导入jar包"></a>1.导入jar包</h2><pre><code class="xml"> &lt;!--验证码--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;
            &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;
            &lt;version&gt;2.3.2&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>
<h2 id="2-编辑配置类"><a href="#2-编辑配置类" class="headerlink" title="2.编辑配置类"></a>2.编辑配置类</h2><pre><code class="java">@Configuration
public class KaptchaConfig &#123;
    @Bean
    public Producer kaptchaProducer()&#123;
        Properties properties=new Properties();
        properties.setProperty(&quot;kaptcha.image.width&quot;,&quot;100&quot;);
        properties.setProperty(&quot;kaptcha.image.height&quot;,&quot;40&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.font.size&quot;,&quot;32&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.font.color&quot;,&quot;0,0,0&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.char.string&quot;,&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.char.length&quot;,&quot;4&quot;);
        properties.setProperty(&quot;kaptcha.noise.impl&quot;,&quot;com.google.code.kaptcha.impl.NoNoise&quot;);


        DefaultKaptcha kaptcha=new DefaultKaptcha();
        Config config=new Config(properties);
        kaptcha.setConfig(config);
        return kaptcha;
    &#125;
&#125;
</code></pre>
<h2 id="3-生成随机验证码"><a href="#3-生成随机验证码" class="headerlink" title="3.生成随机验证码"></a>3.生成随机验证码</h2><pre><code class="java">@GetMapping(&quot;/kaptcha&quot;)
public void getKaptcha(HttpServletResponse response, HttpSession session)&#123;
    //生成验证码
    String text = kaptchaProducer.createText();
    //生成验证码图片
    BufferedImage image = kaptchaProducer.createImage(text);

    //把验证码存入session
    session.setAttribute(&quot;kaptcha&quot;,text);

    //将图片输出给浏览器
    response.setContentType(&quot;image/png&quot;);
    try &#123;
        OutputStream os = response.getOutputStream();
        //输出图片的工具类
        ImageIO.write(image,&quot;png&quot;,os);
    &#125; catch (IOException e) &#123;
       logger.error(&quot;响应验证码失败:&quot;+e.getMessage());
    &#125;
&#125;
</code></pre>
<h1 id="五-登录-退出功能"><a href="#五-登录-退出功能" class="headerlink" title="五.登录,退出功能"></a>五.登录,退出功能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219143026346.png" alt="image-20230219143026346"></p>
<h2 id="1-验证账号-密码-验证码"><a href="#1-验证账号-密码-验证码" class="headerlink" title="1.验证账号,密码,验证码"></a>1.验证账号,密码,验证码</h2><p>验证账号密码的逻辑写在业务层,并且也附带一些提示信息:</p>
<pre><code class="java">//登录
public Map&lt;String,Object&gt;login(String username,String password,int expiredSeconds)&#123;
    Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();

    //空值处理
    if (StringUtils.isBlank(username)) &#123;
        map.put(&quot;usernameMsg&quot;,&quot;账号不能为空!&quot;);
        return map;
    &#125;
    if(StringUtils.isBlank(password))&#123;
        map.put(&quot;passwordMsg&quot;,&quot;密码不能为空&quot;);
        return map;
    &#125;

    //验证账号
    User user = userMapper.selectByName(username);
    if(user==null)&#123;
        map.put(&quot;usernameMsg&quot;,&quot;该账号不存在&quot;);
        return map;
    &#125;
    //验证是否激活
    if(user.getStatus()==0)&#123;
        map.put(&quot;usernameMsg&quot;,&quot;该账号未激活&quot;);
        return map;
    &#125;
    //user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
    //验证密码
    if(!CommunityUtil.md5(password + user.getSalt()).equals(user.getPassword()))&#123;
        map.put(&quot;passwordMsg&quot;,&quot;输入的密码不正确,请再次输入&quot;);
        return map;
    &#125;


    //全部通过之后,成功登录,生成登录凭证
    LoginTicket loginTicket=new LoginTicket();
    //登录凭证由随机字符组成
    loginTicket.setTicket(CommunityUtil.generateUUID());
    loginTicket.setUserId(user.getId());
    loginTicket.setStatus(0);
    //登录凭证的过期时间
    loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds* 1000L));
    
    loginTicketMapper.insertLoginTicket(loginTicket);
    map.put(&quot;ticket&quot;,loginTicket.getTicket());
    return map;
&#125;
</code></pre>
<p>在控制层:</p>
<p>验证用户输入的验证码和session中存放的是否一致:</p>
<pre><code class="java">//检查验证码
String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);
if (StringUtils.isBlank(code)||StringUtils.isBlank(kaptcha)||!kaptcha.equalsIgnoreCase(code)) &#123;
    model.addAttribute(&quot;codeMsg&quot;,&quot;验证码不正确&quot;);
    return &quot;/site/login&quot;;
&#125;
</code></pre>
<p>检查账号密码以及重定向逻辑:</p>
<pre><code class="java">//检查账号密码
int expiredSeconds=rememberMe?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;
Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);
//如果mao中包含&quot;ticket&quot;,则说明用户的账号密码信息正确,可以登录
if(map.containsKey(&quot;ticket&quot;))&#123;
    //拿到cookie信息
    Cookie cookie=new Cookie(&quot;ticket&quot;,map.get(&quot;ticket&quot;).toString());
    //设置cookie有效的路径: 整个项目
    cookie.setPath(contextPath);
    cookie.setMaxAge(expiredSeconds);
    //将设置好的cookie返回给浏览器
    response.addCookie(cookie);
    return &quot;redirect:/index&quot;;
&#125;else&#123;
    //用户在登录的某一环节出了差错
    model.addAttribute(&quot;usernameMsg&quot;,map.get(&quot;usernameMsg&quot;));
    model.addAttribute(&quot;passwordMsg&quot;,map.get(&quot;passwordMsg&quot;));
    return &quot;/site/login&quot;;
&#125;
</code></pre>
<h2 id="2-前端登录处理"><a href="#2-前端登录处理" class="headerlink" title="2.前端登录处理:"></a>2.前端登录处理:</h2><p>注意:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219180535635.png" alt="image-20230219180535635"></p>
<p>正常的java类型写在了参数列表里, springmvc不会自动将其加入到model中(自定义的一些类可以).虽然能为input标签添加name属性将其自动注入到参数中,但是前端无法通过model再次访问这些值. </p>
<p>解决方法: 1.手动添加到model中</p>
<p>​				2.thymeleaf为我们提供了param字段,相当于可以通过request得到请求携带的参数(request.getParameter(…))</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219181225032.png" alt="image-20230219181225032"></p>
<p>这样处理的好处是可以在输入错误后,将上一次输入的结果保留到输入框内</p>
<h2 id="3-登出功能"><a href="#3-登出功能" class="headerlink" title="3.登出功能"></a>3.登出功能</h2><p>登出功能的逻辑就是:</p>
<p> 将上一次登录的cookie设置为失效状态,然后重定向到登录界面</p>
<pre><code class="java">public void logout(String ticket)&#123;
    loginTicketMapper.updateStatus(ticket,1);
&#125;
</code></pre>
<pre><code class="java">@RequestMapping(path = &quot;/logout&quot;,method = RequestMethod.GET)
public String logout(@CookieValue(&quot;ticket&quot;)String ticket)&#123;
    userService.logout(ticket);
    //默认get请求
    return &quot;redirect:/login&quot;;
&#125;
</code></pre>
<p>@CookieValue注解可以直接从本地获得存放的cookie字符串</p>
<h1 id="六-显示登录信息"><a href="#六-显示登录信息" class="headerlink" title="六.显示登录信息"></a>六.显示登录信息</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219160834081.png" alt="image-20230219160834081"></p>
<h2 id="1-定义拦截器-在请求开始前查询登录用户"><a href="#1-定义拦截器-在请求开始前查询登录用户" class="headerlink" title="1.定义拦截器,在请求开始前查询登录用户"></a>1.定义拦截器,在请求开始前查询登录用户</h2><p>定义工具类,每个线程对应一个user对象:</p>
<pre><code class="java">@Component
public class HostHolder &#123;

    private ThreadLocal&lt;User&gt; userThreadLocal=new ThreadLocal&lt;&gt;();

    public void setUser(User user)&#123;
        userThreadLocal.set(user);
    &#125;

    public User getUser()&#123;
        return userThreadLocal.get();
    &#125;

    public void clear()&#123;
        userThreadLocal.remove();
    &#125;

&#125;
</code></pre>
<pre><code class="java">@Component
public class LoginTicketInterceptor implements HandlerInterceptor &#123;

    @Resource
    private UserService userService;
    @Resource
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        //从cookie中获取凭证
        String ticket = CookieUtil.getValue(request, &quot;ticket&quot;);

        if(ticket!=null)&#123;
            //表示登录了
            //查询凭证
            LoginTicket loginTicket = userService.findLoginTicket(ticket);
            //检查凭证是否有效
            if(loginTicket!=null&amp;&amp;loginTicket.getStatus()==0&amp;&amp;loginTicket.getExpired().after(new Date()))&#123;
                //根据凭证查询用户
                User user = userService.findUserById(loginTicket.getUserId());
                //在本次请求中持有用户
                hostHolder.setUser(user);
            &#125;
        &#125;
        return true;
    &#125;
</code></pre>
<p>配置拦截器:</p>
<pre><code class="java">@Configuration
public class WebMvcConfig implements WebMvcConfigurer &#123;
    @Resource
    private LoginTicketInterceptor loginTicketInterceptor;
    @Override
    public void addInterceptors(InterceptorRegistry registry) &#123;
        registry.addInterceptor(loginTicketInterceptor)
                //放行下面的路径,其他的全部拦截
                .excludePathPatterns(&quot;/**/*.css&quot;,&quot;/**/*.js&quot;,&quot;/**/*.png&quot;,&quot;/**/*.jpg&quot;,&quot;/**/*.jpeg&quot;);
    &#125;
&#125;
</code></pre>
<h2 id="2-在模板视图上显示用户数据-且登录或者未登录的情况下显示的状态栏应该不同"><a href="#2-在模板视图上显示用户数据-且登录或者未登录的情况下显示的状态栏应该不同" class="headerlink" title="2.在模板视图上显示用户数据. 且登录或者未登录的情况下显示的状态栏应该不同:"></a>2.在模板视图上显示用户数据. 且登录或者未登录的情况下显示的状态栏应该不同:</h2><pre><code class="java">@Override
public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception &#123;
    User user = hostHolder.getUser();
    //将持有的用户数据放给视图层
    if(user!=null&amp;&amp;modelAndView!=null)&#123;
        modelAndView.addObject(&quot;loginUser&quot;,user);
    &#125;
&#125;

@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;
    //清理用户数据
    hostHolder.clear();
&#125;
</code></pre>
<p>根据登录或者未登录的状态,修改index导航栏得相关信息:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230219182230298.png" alt="image-20230219182230298"></p>
<h1 id="七-账号设置"><a href="#七-账号设置" class="headerlink" title="七.账号设置"></a>七.账号设置</h1><h2 id="1-上传文件"><a href="#1-上传文件" class="headerlink" title="1.上传文件"></a>1.上传文件</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220160818386.png" alt="image-20230220160818386"></p>
<p>携带表单信息,所以必须得是post请求</p>
<p>表单中得添加属性: (上传文件的标识)</p>
<pre><code class="html">enctype=&quot;multipart/form-data&quot;
</code></pre>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220192958424.png" alt="image-20230220192958424"></p>
<p>开发步骤</p>
<h3 id="1-将用户上传的图像保存在服务器"><a href="#1-将用户上传的图像保存在服务器" class="headerlink" title="(1)将用户上传的图像保存在服务器:"></a>(1)将用户上传的图像保存在服务器:</h3><ul>
<li>检查格式</li>
<li>生成随机文件名</li>
<li>保存在指定路径</li>
<li>更新用户保存的头像路径</li>
<li>重定向到首页</li>
</ul>
<pre><code class="java">public String uploadHeaderImg(MultipartFile headerImg, Model model)&#123;
    if(headerImg==null)&#123;
        model.addAttribute(&quot;error&quot;,&quot;您还没有选择图片&quot;);
        return &quot;/site/setting&quot;;
    &#125;

    String originalFilename = headerImg.getOriginalFilename();
    //解析文件后缀
    String suffix = originalFilename.substring(originalFilename.lastIndexOf(&quot;.&quot;)+1);
    if (StringUtils.isBlank(suffix)) &#123;
        model.addAttribute(&quot;error&quot;,&quot;文件的格式不正确&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    if(!(suffix.equals(&quot;png&quot;)||suffix.equals(&quot;jpg&quot;)||suffix.equals(&quot;jpeg&quot;)))&#123;
        model.addAttribute(&quot;error&quot;,&quot;文件的格式不正确&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //生成随机文件名
    String filename = CommunityUtil.generateUUID() +&quot;.&quot;+ suffix;
    //确定文件存放的路径
    File dest=new File(uploadPath+&quot;/&quot;+filename);
    try &#123;
        //存储文件
        headerImg.transferTo(dest);
    &#125; catch (IOException e) &#123;
        logger.error(&quot;上传文件失败&quot;+e.getMessage());
        throw new RuntimeException(&quot;上传文件失败,服务器异常&quot;,e);
    &#125;
    //更新当前用户头像的路径(web路径)
    User user = hostHolder.getUser();
    String headerUrl=domain+contextPath+&quot;/user/header/&quot;+filename;
    userService.updateHeaderImg(user.getId(),headerUrl);

    return &quot;redirect:/index&quot;;
&#125;
</code></pre>
<h3 id="2-创建访问文件路径"><a href="#2-创建访问文件路径" class="headerlink" title="(2)创建访问文件路径"></a>(2)创建访问文件路径</h3><pre><code class="java">//设置头像的访问路径
@RequestMapping(path = &quot;header/&#123;filename&#125;&quot;,method = RequestMethod.GET)
public void getHeader(@PathVariable(&quot;filename&quot;)String filename, HttpServletResponse response)&#123;
    //服务器存放的路径:
    filename=uploadPath+&quot;/&quot;+filename;
    //输出图片
    //文件后缀
    String suffix = filename.substring(filename.lastIndexOf(&quot;.&quot;)+1);
    //响应图片
    response.setContentType(&quot;image/&quot;+suffix);
    //在try括号里的流,都会在finally里中自动关闭
    try ( FileInputStream fis=new FileInputStream(filename))&#123;
        OutputStream os=response.getOutputStream();
        //缓冲区
        byte[]buffer=new byte[1024];
        int b=0;
        while ((b=fis.read(buffer))!=-1)&#123;
            os.write(buffer,0,b);
        &#125;
    &#125; catch (IOException e) &#123;
        logger.error(&quot;读取头像失败&quot;+e.getMessage());
    &#125;
&#125;
</code></pre>
<h2 id="2-修改密码"><a href="#2-修改密码" class="headerlink" title="2.修改密码"></a>2.修改密码</h2><pre><code class="java">//修改密码
@LoginRequired
@PostMapping(&quot;/updatePassword&quot;)
public String updatePassword(String oldPassword,String newPassword1,String newPassword2,Model model)&#123;
    //获取当前用户
    User user = hostHolder.getUser();
    if (StringUtils.isBlank(oldPassword)) &#123;
        model.addAttribute(&quot;oldPasswordMsg&quot;,&quot;密码不能为空!&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //若原密码不正确
    if(!user.getPassword().equals(CommunityUtil.md5(oldPassword+user.getSalt())))&#123;
        model.addAttribute(&quot;oldPasswordMsg&quot;,&quot;原密码错误,请重新输入!&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //若新密码为空:
    if(StringUtils.isBlank(newPassword1))&#123;
        model.addAttribute(&quot;newPasswordMsg1&quot;,&quot;新密码不能为空&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //若两次输入的密码不一致
    if(!newPassword1.equals(newPassword2))&#123;
        model.addAttribute(&quot;newPasswordMsg2&quot;,&quot;两次输入的密码不一致,请重新输入!&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //若新密码和原密码一致:
    if(user.getPassword().equals(CommunityUtil.md5(newPassword1+user.getSalt())))&#123;
        model.addAttribute(&quot;newPasswordMsg1&quot;,&quot;新密码不能与原密码一致!&quot;);
        return &quot;/site/setting&quot;;
    &#125;
    //加密
    newPassword2=CommunityUtil.md5(newPassword2+user.getSalt());
    userService.updatePassword(user.getId(),newPassword2);
    return &quot;redirect:/logout&quot;;
&#125;
</code></pre>
<h1 id="八-检查登录状态"><a href="#八-检查登录状态" class="headerlink" title="八.检查登录状态"></a>八.检查登录状态</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230220191030200.png" alt="image-20230220191030200"></p>
<p>有一些路径在未登录的状态下不允许访问,例如个人的设置页. 这种情况下虽然我们在前端隐藏了,但是还是可以通过输入访问路径的方式来得到页面,这是不安全的. 解决方法是使用拦截器.</p>
<p>工作中常见的除了直接指定拦截路径外,还可以指定拦截器作用的方法,通过自定义注解了来实现:</p>
<h2 id="1-自定义注解"><a href="#1-自定义注解" class="headerlink" title="1.自定义注解"></a>1.自定义注解</h2><pre><code class="java">/**
 * @author Dylan
 * @version 1.0
 * @date 2023/2/20 19:15
 * @description 用来标记哪些方法是需要拦截的
 **/
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginRequired &#123;
&#125;
</code></pre>
<h2 id="2-拦截器"><a href="#2-拦截器" class="headerlink" title="2.拦截器"></a>2.拦截器</h2><p>prehandle方法参数中的Object handler可以得到拦截的对象,强制转换为HandlerMethod对拦截的方法进行操作.</p>
<pre><code class="java">@Component
public class LoginRequiredInterceptor implements HandlerInterceptor &#123;
    @Resource
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        //若拦截对象是方法
        if(handler instanceof HandlerMethod)&#123;
            //强转
            HandlerMethod handlerMethod=(HandlerMethod)handler;
            //得到方法
            Method method = handlerMethod.getMethod();
            //获取方法的自定义标记注解
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            //若注解对象不为空且未处在登录状态
            if(loginRequired!=null&amp;&amp;hostHolder.getUser()==null)&#123;
                //重定向
                response.sendRedirect(request.getContextPath()+&quot;/login&quot;);
                return false;
            &#125;
        &#125;
        return true;
    &#125;
&#125;
</code></pre>
<h1 id="九-过滤敏感词"><a href="#九-过滤敏感词" class="headerlink" title="九.过滤敏感词"></a>九.过滤敏感词</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221105339374.png" alt="image-20230221105339374"></p>
<p>前缀树特点: </p>
<ul>
<li>根节点为空</li>
<li>每个节点只携带一个字符</li>
<li>每个节点的下一层不能有相同元素</li>
<li>可以快速查询检索字符串</li>
<li>核心思想是用空间换取时间</li>
</ul>
<h2 id="1-前缀树的定义"><a href="#1-前缀树的定义" class="headerlink" title="1.前缀树的定义"></a>1.前缀树的定义</h2><p>定义为私有内部类的方式:</p>
<pre><code class="java">//描述前缀树的节点
private class TrieNode&#123;
    //关键词结束的标识
    private boolean isKeyWordEnd=false;

    //当前节点的子节点(key是下级节点的字符,value是下级节点
    //使用map存储
    private Map&lt;Character,TrieNode&gt;subNodes=new HashMap&lt;&gt;();

    //是否是关键词汇的最后一个字符
    public boolean isKeyWordEnd() &#123;
        return isKeyWordEnd;
    &#125;

    public void setKeyWordEnd(boolean keyWordEnd) &#123;
        isKeyWordEnd = keyWordEnd;
    &#125;

    //添加子节点的方法
    public void addSubNode(Character c,TrieNode node)&#123;
        subNodes.put(c,node);
    &#125;
    //获取子节点的方法
    public TrieNode getSubNode(Character c)&#123;
        return subNodes.get(c);
    &#125;
&#125;
</code></pre>
<h2 id="2-根据敏感词初始化前缀树"><a href="#2-根据敏感词初始化前缀树" class="headerlink" title="2.根据敏感词初始化前缀树"></a>2.根据敏感词初始化前缀树</h2><pre><code class="java">//改注解表示这是一个初始化方法,当容器初始化后,这个方法会自动被调用
@PostConstruct
public void init()&#123;
    //读文件的字符
    try (
        //类加载器读取文件流
            InputStream inputStream = this.getClass().getClassLoader().getResourceAsStream(&quot;sensitive-words.txt&quot;);
             BufferedReader reader=new BufferedReader(new InputStreamReader(inputStream));
    ) &#123;
            String keyword;
            while ((keyword=reader.readLine())!=null)&#123;
                //添加到前缀树
                this.addKeyword(keyword);
            &#125;
    &#125;catch (IOException e)&#123;
        logger.error(&quot;加载敏感词异常:&quot;+e.getMessage());
    &#125;
&#125;
//将一个敏感词添加到前缀树
private void addKeyword(String keyword)&#123;
    TrieNode tem=root;
    for (int i = 0; i &lt; keyword.length(); i++) &#123;
        char c = keyword.charAt(i);
        TrieNode subNode = tem.getSubNode(c);
        if(tem.getSubNode(c)==null)&#123;
            subNode = new TrieNode();
            tem.addSubNode(c,subNode);
        &#125;
            tem= subNode;
            //设置结束的标识
            if(i==keyword.length()-1)&#123;
                tem.setKeyWordEnd(true);
            &#125;
    &#125;
&#125;
</code></pre>
<h2 id="3-编写过滤词汇的方法"><a href="#3-编写过滤词汇的方法" class="headerlink" title="3.编写过滤词汇的方法"></a>3.编写过滤词汇的方法</h2><pre><code class="java">//实现检索敏感词的过程
//过滤敏感词并返回过滤后的结果
public String filter(String text)&#123;
    if(StringUtils.isBlank(text))&#123;
        return null;
    &#125;
    //指针1:指向树的节点
    TrieNode tem=root;
    //指针2
    int begin=0;
    //指针3
    int end=0;
    //结果
    StringBuilder stringBuilder=new StringBuilder();

    while (end&lt;text.length())&#123;
        char c = text.charAt(end);
        //跳过符号
        if(isSymbol(c))&#123;
            //若指针1是根节点,将该符号计入结果,让指针2向下走
            if(tem==root)&#123;
                stringBuilder.append(c);
                begin++;
            &#125;
            //无论符号在开头还是中间,指针3都向下走
            end++;
            continue;
        &#125;
        //字符不是特殊字符
        //检查下级节点
        tem=tem.getSubNode(c);
        if(tem==null)&#123;
            //以begin开头的字符串不是敏感词
            stringBuilder.append(c);
            begin++;
            end=begin;
            //重新指向根节点
            tem=root;
        &#125;else if(!tem.isKeyWordEnd)&#123;
            //该字符不是最后一个敏感字符
            end++;
        &#125;else&#123;
            //该字符是最后一个敏感字符:
            stringBuilder.append(REPLACEMENT);
            end++;
            begin=end;
            //重新指向根节点
            tem=root;
        &#125;
    &#125;
    //将最后一批计入结果
    stringBuilder.append(text.substring(begin));
    return stringBuilder.toString();
&#125;

//判断是否为符号
private boolean isSymbol(Character c)&#123;
    //是特殊字符的话返回true,普通字符返回false         东亚的文字范围
    return !CharUtils.isAsciiAlphanumeric(c)&amp;&amp;(c&lt;0x2E80||c&gt;0x9FFF);
&#125;
</code></pre>
<h1 id="十-发布帖子"><a href="#十-发布帖子" class="headerlink" title="十.发布帖子"></a>十.发布帖子</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221152115978.png" alt="image-20230221152115978"></p>
<h2 id="1-处理后端插入数据的代码"><a href="#1-处理后端插入数据的代码" class="headerlink" title="1.处理后端插入数据的代码"></a>1.处理后端插入数据的代码</h2><p>由于是插入一条帖子的字段,所以dao层的方法应该为:</p>
<pre><code class="java">int insertDiscussPost(DiscussPost post);
</code></pre>
<p>mapper.xml的内容:</p>
<pre><code class="xml">&lt;sql id=&quot;insertFields&quot;&gt;
        user_id,title,content,type,status,create_time,comment_count,score
    &lt;/sql&gt;
&lt;insert id=&quot;insertDiscussPost&quot; parameterType=&quot;DiscussPost&quot; keyProperty=&quot;id&quot;&gt;
    insert into discuss_post(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;)
    values(#&#123;userId&#125;,#&#123;title&#125;,#&#123;content&#125;,#&#123;type&#125;,#&#123;status&#125;,#&#123;createTime&#125;,#&#123;commentCount&#125;,#&#123;score&#125;)
&lt;/insert&gt;
</code></pre>
<h2 id="2-编写业务层逻辑"><a href="#2-编写业务层逻辑" class="headerlink" title="2.编写业务层逻辑"></a>2.编写业务层逻辑</h2><pre><code class="java">public int addDiscussPost(DiscussPost discussPost)&#123;
    if(discussPost==null)&#123;
        throw new IllegalArgumentException(&quot;参数不能为空!&quot;);
    &#125;
    //处理标签
    //转义HTML标签(比如在标题或内容中写&lt;h1&gt;你好&lt;h1&gt;,会将大于号小于号视为普通字符而不是标签)
    discussPost.setTitle(HtmlUtils.htmlEscape(discussPost.getTitle()));
    discussPost.setContent(HtmlUtils.htmlEscape(discussPost.getContent()));
    //过滤敏感词
    discussPost.setTitle(sensitiveFilter.filter(discussPost.getTitle()));
    discussPost.setContent(sensitiveFilter.filter(discussPost.getContent()));
    //插入
    return discussPostMapper.insertDiscussPost(discussPost);
&#125;
</code></pre>
<h2 id="3-控制层逻辑"><a href="#3-控制层逻辑" class="headerlink" title="3.控制层逻辑"></a>3.控制层逻辑</h2><p>一些简单的检查:</p>
<pre><code class="java">@PostMapping(&quot;/add&quot;)
@ResponseBody
public String addDiscussPost(String title,String content)&#123;
    User user = holder.getUser();
    if(user==null)&#123;
        return CommunityUtil.getJsonString(403,&quot;您还未登录,请登录后再进行发帖&quot;);
    &#125;
    if(StringUtils.isBlank(title)||StringUtils.isBlank(content))&#123;
        return CommunityUtil.getJsonString(1,&quot;标题或内容不能为空&quot;);
    &#125;
    DiscussPost post=new DiscussPost();
    post.setTitle(title);
    post.setUserId(user.getId());
    post.setContent(content);
    post.setCreateTime(new Date());
    discussPostService.addDiscussPost(post);
    //报错将来统一处理
    return CommunityUtil.getJsonString(0,&quot;发布成功!&quot;);
&#125;
</code></pre>
<h2 id="4-利用ajax异步发送请求"><a href="#4-利用ajax异步发送请求" class="headerlink" title="4.利用ajax异步发送请求"></a>4.利用ajax异步发送请求</h2><p>前端利用ajax异步发送请求:</p>
<pre><code class="js">$(function()&#123;
   $(&quot;#publishBtn&quot;).click(publish);
&#125;);

function publish() &#123;
   $(&quot;#publishModal&quot;).modal(&quot;hide&quot;);
   //获取标题和内容
   let title=$(&quot;#recipient-name&quot;).val();
   let content=$(&quot;#message-text&quot;).val();
   //发送异步请求
   $.post(
      CONTEXT_PATH+&quot;/discuss/add&quot;,
      //参数
      &#123;&quot;title&quot;:title,&quot;content&quot;:content&#125;,
      function (data)&#123;
         data=$.parseJSON(data)
         //在提示框中显示返回的消息
         $(&quot;#hintBody&quot;).text(data.msg);
         //显示提示框
         $(&quot;#hintModal&quot;).modal(&quot;show&quot;);
         //两秒后自动隐藏提示框
         setTimeout(function()&#123;
            $(&quot;#hintModal&quot;).modal(&quot;hide&quot;);
            //成功发布刷新页面
            if (data.code === 0) &#123;
               window.location.reload();
            &#125;
         &#125;, 2000);
      &#125;
   )
&#125;
</code></pre>
<h1 id="十一-帖子详情"><a href="#十一-帖子详情" class="headerlink" title="十一.帖子详情"></a>十一.帖子详情</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221171350640.png" alt="image-20230221171350640"></p>
<h2 id="1-处理后端查询数据的代码"><a href="#1-处理后端查询数据的代码" class="headerlink" title="1.处理后端查询数据的代码:"></a>1.处理后端查询数据的代码:</h2><pre><code class="xml">&lt;select id=&quot;selectDiscussPostById&quot; resultType=&quot;DiscussPost&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from discuss_post
    where id=#&#123;id&#125;
&lt;/select&gt;
</code></pre>
<h2 id="2-处理业务层代码"><a href="#2-处理业务层代码" class="headerlink" title="2.处理业务层代码:"></a>2.处理业务层代码:</h2><p>直接调用</p>
<h2 id="3-处理控制层"><a href="#3-处理控制层" class="headerlink" title="3.处理控制层"></a>3.处理控制层</h2><p>因为查询帖子会用到用户的信息,可以有两种解决方案, </p>
<ul>
<li>一种是连表查询</li>
<li>第二种是根据帖子自带的用户id再查询一次user,这样效率比较低但是可以后期利用缓存.</li>
</ul>
<pre><code class="java">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)
public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;)int id, Model model)&#123;
    DiscussPost post = discussPostService.selectDiscussPostById(id);
    model.addAttribute(&quot;post&quot;,post);
    User user = userService.findUserById(post.getUserId());
    model.addAttribute(&quot;user&quot;,user);
    return &quot;/site/discuss-detail&quot;;
&#125;
</code></pre>
<h2 id="4-处理前端的逻辑"><a href="#4-处理前端的逻辑" class="headerlink" title="4.处理前端的逻辑"></a>4.处理前端的逻辑</h2><p>前端首页只需要将标题上的超链接改为帖子详情的路径:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230221175213206.png" alt="image-20230221175213206"></p>
<p>但是有一个点需要注意,thymeleaf在路径有变量有常量时,不能直接字符串拼接. 而是使用| |将常量和变量括起来,然后变量自取</p>
<h1 id="十二-显示评论"><a href="#十二-显示评论" class="headerlink" title="十二.显示评论"></a>十二.显示评论</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114033384.png" alt="image-20230223114033384"></p>
<h2 id="1-处理数据访问层"><a href="#1-处理数据访问层" class="headerlink" title="1.处理数据访问层"></a>1.处理数据访问层</h2><p>首先需要对comment表有一个细致的了解.</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114439016.png" alt="image-20230223114439016"></p>
<p>首先每个post表都有包含评论该post表的评论数量.</p>
<p>而comment表中的user_id是发表该评论的userId. </p>
<p>entity_type的字段表示评论的类型(1代表回复帖子的评论,2代表回复帖子里评论的评论)</p>
<p>当entity_type是1时,entity_id就是回复的主题帖子的id</p>
<p>当entity_type是2时,entity_id就是评论的楼主的id,无论该楼里是否有楼中楼,每个楼中楼的entity_id都是楼主的id</p>
<p>如果target_id不为0的话,说明该条评论是回复别人的,也就是楼中楼,那么targetId就是回复对象的id</p>
<p>mybatis的xml文件:</p>
<pre><code class="xml">&lt;sql id=&quot;selectFields&quot;&gt;
    id,user_id,entity_type,entity_id,target_id,content,status,create_time
&lt;/sql&gt;

&lt;sql id=&quot;insertFields&quot;&gt;
    user_id,entity_type,entity_id,target_id,content,status,create_time
&lt;/sql&gt;

&lt;select id=&quot;selectCommentByEntity&quot; resultType=&quot;Comment&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from comment
    where status=0
    and entity_type=#&#123;entityType&#125; and entity_id=#&#123;entityId&#125;
    order by create_time asc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=&quot;selectCountByEntity&quot; resultType=&quot;int&quot;&gt;
    select count(id)
    from comment
    where status=0
    and entity_type=#&#123;entityType&#125; and entity_id=#&#123;entityId&#125;
&lt;/select&gt;

&lt;insert id=&quot;insertComment&quot; parameterType=&quot;comment&quot; keyProperty=&quot;id&quot;&gt;
    insert into comment(&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;)
    values (#&#123;userId&#125;,#&#123;entityType&#125;,#&#123;entityId&#125;,#&#123;targetId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)
&lt;/insert&gt;
</code></pre>
<h2 id="2-业务层逻辑"><a href="#2-业务层逻辑" class="headerlink" title="2.业务层逻辑"></a>2.业务层逻辑</h2><pre><code class="java">@Resource
private CommentMapper commentMapper;
@Resource
private DiscussPostService discussPostService;
@Resource
private SensitiveFilter sensitiveFilter;

public List&lt;Comment&gt;findCommentByEntity(int entityType,int entityId,int offset,int limit)&#123;
    return commentMapper.selectCommentByEntity(entityType,entityId,offset,limit);
&#125;

public int findCommentCount(int entityType,int entityId)&#123;
    return commentMapper.selectCountByEntity(entityType,entityId);
&#125;

/**
 * 添加帖子
 */
@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)
public int addComment(Comment comment)&#123;
    if(comment==null)&#123;
        throw new IllegalArgumentException(&quot;评论不能为空&quot;);
    &#125;
    //过滤html标签
    comment.setContent(HtmlUtils.htmlUnescape(comment.getContent()));
    //过滤敏感词
    comment.setContent(sensitiveFilter.filter(comment.getContent()));
    //添加评论
    int rows = commentMapper.insertComment(comment);
    //更新回复给帖子的评论数量
    if(comment.getEntityType()==ENTITY_TYPE_POST)&#123;
        //
        int count = commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(),count);
    &#125;

    return rows;
&#125;
</code></pre>
<h2 id="3-控制层-评论详情"><a href="#3-控制层-评论详情" class="headerlink" title="3.控制层,评论详情"></a>3.控制层,评论详情</h2><pre><code class="java">@GetMapping(&quot;/detail/&#123;discussPostId&#125;&quot;)
public String getDiscussPost(@PathVariable(&quot;discussPostId&quot;)int id, Model model, Page page)&#123;
    //帖子
    DiscussPost post = discussPostService.selectDiscussPostById(id);
    model.addAttribute(&quot;post&quot;,post);
    //作者
    User user = userService.findUserById(post.getUserId());
    model.addAttribute(&quot;user&quot;,user);

    //评论的分页信息
    page.setLimit(5);
    page.setPath(&quot;/discuss/detail/&quot;+id);
    //单个帖子的评论总数
    page.setRows(post.getCommentCount());
    //给帖子的评论:评论
    //给评论的评论:回复
    List&lt;Comment&gt; commentList =
            commentService.findCommentByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
    //评论的列表
    List&lt;Map&lt;String,Object&gt;&gt;commentVoList=new ArrayList&lt;&gt;();
    if(commentList!=null&amp;&amp;!commentList.isEmpty())&#123;
        for (Comment comment : commentList) &#123;
            //一个评论的vo
            Map&lt;String,Object&gt;commentVo=new HashMap&lt;&gt;();
            //评论
            commentVo.put(&quot;comment&quot;,comment);
            //评论的作者
            commentVo.put(&quot;user&quot;,userService.findUserById(comment.getUserId()));

            //查询回复列表
            List&lt;Comment&gt; replyList =
                    commentService.findCommentByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
            //回复VO列表
            List&lt;Map&lt;String,Object&gt;&gt;replyVoList=new ArrayList&lt;&gt;();
            if(replyList!=null)&#123;
                for (Comment reply : replyList) &#123;
                    Map&lt;String,Object&gt;replyVo=new HashMap&lt;&gt;();
                    //存回复:
                    replyVo.put(&quot;reply&quot;,reply);
                    replyVo.put(&quot;user&quot;,userService.findUserById(reply.getUserId()));
                    //回复的目标
                    if(reply.getTargetId()!=0)&#123;
                        User target = userService.findUserById(reply.getTargetId());
                        replyVo.put(&quot;target&quot;,target);
                    &#125;else&#123;
                        replyVo.put(&quot;target&quot;,null);
                    &#125;
                    replyVoList.add(replyVo);
                &#125;
            &#125;
            commentVo.put(&quot;replys&quot;,replyVoList);

            //回复的数量
            int commentCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put(&quot;replyCount&quot;,commentCount);
            commentVoList.add(commentVo);
        &#125;
        model.addAttribute(&quot;comments&quot;,commentVoList);
    &#125;
    return &quot;/site/discuss-detail&quot;;
&#125;
</code></pre>
<h2 id="4-前端页面"><a href="#4-前端页面" class="headerlink" title="4.前端页面"></a>4.前端页面</h2><p>注意一个点</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223120650954.png" alt="image-20230223120650954"></p>
<p>当需要知道循环次数时,往往需要在别名后面加上Stat如rvoStat再取count就为当时处在第几次循环</p>
<h1 id="十三-添加评论"><a href="#十三-添加评论" class="headerlink" title="十三.添加评论"></a>十三.添加评论</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114101675.png" alt="image-20230223114101675"></p>
<h2 id="1-业务层"><a href="#1-业务层" class="headerlink" title="1.业务层"></a>1.业务层</h2><p>因为添加帖子时,会影响到另外一张表discuss_post的数据. 所以我们要使用到spring为我们提供的事务管理方法;</p>
<p>在本次方法上就使用注解的方式进行事务管理</p>
<pre><code class="java">/**
 * 添加帖子
 */
@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)
public int addComment(Comment comment)&#123;
    if(comment==null)&#123;
        throw new IllegalArgumentException(&quot;评论不能为空&quot;);
    &#125;
    //过滤html标签
    comment.setContent(HtmlUtils.htmlUnescape(comment.getContent()));
    //过滤敏感词
    comment.setContent(sensitiveFilter.filter(comment.getContent()));
    //添加评论  
    int rows = commentMapper.insertComment(comment);
    //更新回复给帖子的评论数量
    if(comment.getEntityType()==ENTITY_TYPE_POST)&#123;
        //
        int count = commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(),count);
    &#125;

    return rows;
&#125;
</code></pre>
<h2 id="2-控制层"><a href="#2-控制层" class="headerlink" title="2.控制层"></a>2.控制层</h2><pre><code class="java">@Controller
@RequestMapping(&quot;/comment&quot;)
public class CommentController &#123;

    @Resource
    private CommentService commentService;
    @Resource
    private HostHolder holder;

    @RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;,method = RequestMethod.POST)
    public String addComment(@PathVariable(&quot;discussPostId&quot;)int discussPostId, Comment comment)&#123;
        if(comment.getContent()==null||&quot;&quot;.equals(comment.getContent()))&#123;
            return &quot;redirect:/discuss/detail&quot;+discussPostId;
        &#125;
         comment.setUserId(holder.getUser().getId());
         comment.setStatus(0);
         comment.setCreateTime(new Date());
         commentService.addComment(comment);
        return &quot;redirect:/discuss/detail/&quot;+discussPostId;
    &#125;

&#125;
</code></pre>
<h1 id="十四-私信列表"><a href="#十四-私信列表" class="headerlink" title="十四.私信列表"></a>十四.私信列表</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223114155129.png" alt="image-20230223114155129"></p>
<h2 id="1-数据访问层"><a href="#1-数据访问层" class="headerlink" title="1.数据访问层"></a>1.数据访问层</h2><p>message的表结构:</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223121834387.png" alt="image-20230223121834387"></p>
<p>xml文件:</p>
<pre><code class="xml">&lt;sql id=&quot;selectFields&quot;&gt;
    id,from_id,to_id,conversation_id,content,status,create_time
&lt;/sql&gt;

&lt;select id=&quot;selectConversations&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message where id in(
        select max(id) from message
        where status!=2
        and `from_id`!=1
        and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)
        GROUP BY conversation_id
    )
    order by id desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=&quot;selectConversationCount&quot; resultType=&quot;int&quot;&gt;
    SELECT count(*) from
        (
            select count(id) from message
            where status!=2 and from_id!=1
         and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)
            group by conversation_id
        )a
&lt;/select&gt;

&lt;select id=&quot;selectLetters&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message
    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;
    order by id desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=&quot;selectLetterCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;
&lt;/select&gt;

&lt;select id=&quot;selectUnReadLetterCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status=0 and `from_id`!=1 and to_id=#&#123;userId&#125;
    &lt;if test=&quot;conversationId!=null&quot;&gt;
        and conversation_id=#&#123;conversationId&#125;
    &lt;/if&gt;
&lt;/select&gt;
</code></pre>
<h2 id="2-控制层-1"><a href="#2-控制层-1" class="headerlink" title="2.控制层"></a>2.控制层</h2><pre><code class="java">//用户的私信列表
@RequestMapping(path = &quot;/letter/list&quot;,method = RequestMethod.GET)
public String getLetterList(Model model, Page page)&#123;
    //配置分页信息
    User user = holder.getUser();
    page.setLimit(5);
    page.setPath(&quot;/letter/list&quot;);
    page.setRows(messageService.findConversationCount(user.getId()));
    
    List&lt;Message&gt; conversations = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit());
    List&lt;Map&lt;String,Object&gt;&gt;conversationList=new ArrayList&lt;&gt;();
    if (conversations!=null) &#123;
        for (Message conversation : conversations) &#123;
            Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
            map.put(&quot;conversation&quot;,conversation);
            //用户未读消息数量
            map.put(&quot;unreadCount&quot;,messageService.findUnreadLetter(user.getId(), conversation.getConversationId()));
            //某一条会话的消息数量
            map.put(&quot;letterCount&quot;,messageService.findLetterCount(conversation.getConversationId()));
            int targetId=user.getId()==conversation.getFromId()?conversation.getToId():conversation.getFromId();
            map.put(&quot;target&quot;,userService.findUserById(targetId));
            conversationList.add(map);
        &#125;
    &#125;
    model.addAttribute(&quot;conversations&quot;,conversationList);

    //总共的未读数量
    int unreadLetterTotal = messageService.findUnreadLetter(user.getId(), null);
    model.addAttribute(&quot;unreadLetterTotal&quot;,unreadLetterTotal);
    return &quot;/site/letter&quot;;
&#125;

//用户某一条私信的具体详情
@GetMapping(&quot;/letter/detail/&#123;conversationId&#125;&quot;)
public String getLetterDetail(@PathVariable(&quot;conversationId&quot;)String conversationId,Page page,Model model)&#123;
    page.setLimit(5);
    page.setPath(&quot;/letter/detail/&quot;+conversationId);
    page.setRows(messageService.findLetterCount(conversationId));
    //私信具体列表
    List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String,Object&gt;&gt;letters=new ArrayList&lt;&gt;();
    if(letterList!=null)&#123;
        for (Message message : letterList) &#123;
            Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
            map.put(&quot;letter&quot;,message);
            map.put(&quot;fromUser&quot;,userService.findUserById(message.getFromId()));
            letters.add(map);
        &#125;

    &#125;
    model.addAttribute(&quot;letters&quot;,letters);
    model.addAttribute(&quot;target&quot;,targetUser(conversationId));
    return &quot;/site/letter-detail&quot;;
&#125;

//分解conversationId
private User targetUser(String conversationId)&#123;
    String[] strings = conversationId.split(&quot;_&quot;);
    int id1=Integer.parseInt(strings[0]);
    int id2=Integer.parseInt(strings[1]);
    if(holder.getUser().getId()==id1)&#123;
        return userService.findUserById(id2);
    &#125;else&#123;
        return userService.findUserById(id1);
    &#125;
&#125;
</code></pre>
<h1 id="十五-发送私信"><a href="#十五-发送私信" class="headerlink" title="十五.发送私信"></a>十五.发送私信</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223122150688.png" alt="image-20230223122150688"></p>
<h2 id="1-数据层"><a href="#1-数据层" class="headerlink" title="1.数据层"></a>1.数据层</h2><p>发送私信主要操作的是message表</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224124209233.png" alt="image-20230224124209233"></p>
<p>status为1代表消息已读,status为2代表消息被删除</p>
<p>status为0代表消息未读</p>
<p>发送消息和读取消息主要涉及到消息的插入和更新(主要更新的是status的值)</p>
<p>而每个消息框都要显示最新的消息内容,因为id是自动增长的,所以我们不用通过操作时间的方式来显示查询最新消息,只要获取id最大的message字段就行</p>
<pre><code class="xml">&lt;select id=&quot;selectConversations&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message where id in(
        select max(id) from message
        where status!=2
        and `from_id`!=1
        and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)
        GROUP BY conversation_id
    )
    order by id desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=&quot;selectConversationCount&quot; resultType=&quot;int&quot;&gt;
    SELECT count(*) from
        (
            select count(id) from message
            where status!=2 and from_id!=1
         and (from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125;)
            group by conversation_id
        )a
&lt;/select&gt;

&lt;select id=&quot;selectLetters&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from message
    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;
    order by id desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;

&lt;select id=&quot;selectLetterCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status!=2 and from_id!=1 and conversation_id=#&#123;conversationId&#125;
&lt;/select&gt;

&lt;select id=&quot;selectUnReadLetterCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status=0 and `from_id`!=1 and to_id=#&#123;userId&#125;
    &lt;if test=&quot;conversationId!=null&quot;&gt;
        and conversation_id=#&#123;conversationId&#125;
    &lt;/if&gt;
&lt;/select&gt;

&lt;insert id=&quot;insertMessage&quot; keyProperty=&quot;id&quot; parameterType=&quot;message&quot;&gt;
    insert into message (&lt;include refid=&quot;insertFields&quot;&gt;&lt;/include&gt;)
    values (#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;conversationId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)
&lt;/insert&gt;

&lt;update id=&quot;updateStatus&quot;&gt;
    update message set status=#&#123;status&#125;
    where id in
    &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;
        #&#123;id&#125;
    &lt;/foreach&gt;
&lt;/update&gt;
</code></pre>
<h2 id="2-业务层"><a href="#2-业务层" class="headerlink" title="2.业务层"></a>2.业务层</h2><p>业务层有一点需要注意的是,当点进某个具体的消息会话内时,to_id为点进去的用户的id的所有未读消息的状态都要被设置为已读</p>
<h2 id="3-控制层"><a href="#3-控制层" class="headerlink" title="3.控制层"></a>3.控制层</h2><pre><code class="java">    //用户某一条私信的具体详情
    @GetMapping(&quot;/letter/detail/&#123;conversationId&#125;&quot;)
    public String getLetterDetail(@PathVariable(&quot;conversationId&quot;)String conversationId,Page page,Model model)&#123;
        page.setLimit(5);
        page.setPath(&quot;/letter/detail/&quot;+conversationId);
        page.setRows(messageService.findLetterCount(conversationId));
        //私信具体列表
        List&lt;Message&gt; letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
        List&lt;Map&lt;String,Object&gt;&gt;letters=new ArrayList&lt;&gt;();
        if(letterList!=null)&#123;
            for (Message message : letterList) &#123;
                Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
                map.put(&quot;letter&quot;,message);
                map.put(&quot;fromUser&quot;,userService.findUserById(message.getFromId()));
                letters.add(map);
            &#125;

        &#125;
        model.addAttribute(&quot;letters&quot;,letters);
        model.addAttribute(&quot;target&quot;,targetUser(conversationId));

        //设置已读
        List&lt;Integer&gt;ids=getLetterIds(letterList);
        if(!ids.isEmpty())&#123;
             messageService.readMessage(ids);
        &#125;
        return &quot;/site/letter-detail&quot;;
    &#125;

//得到集合中未读的消息的id

private List&lt;Integer&gt; getLetterIds(List&lt;Message&gt;letterList)&#123;
    List&lt;Integer&gt;ids=new ArrayList&lt;&gt;();
    if (letterList!=null) &#123;
        for (Message message : letterList) &#123;
            //当前用户是否是接受者
            if(holder.getUser().getId()==message.getToId()&amp;&amp;message.getStatus()==0)&#123;
                ids.add(message.getId());
            &#125;
        &#125;
    &#125;
    return ids;
&#125;

//分解conversationId
private User targetUser(String conversationId)&#123;
    String[] strings = conversationId.split(&quot;_&quot;);
    int id1=Integer.parseInt(strings[0]);
    int id2=Integer.parseInt(strings[1]);
    if(holder.getUser().getId()==id1)&#123;
        return userService.findUserById(id2);
    &#125;else&#123;
        return userService.findUserById(id1);
    &#125;
&#125;

//异步请求
@RequestMapping(path = &quot;/letter/send&quot;,method = RequestMethod.POST)
@ResponseBody
public String sendLetter(String toName,String content)&#123;
    User target = userService.findUserByName(toName);
    if(target==null)&#123;
        return CommunityUtil.getJsonString(1,&quot;目标用户不存在&quot;);
    &#125;
    Message message=new Message();
    message.setFromId(holder.getUser().getId());
    message.setToId(target.getId());
    message.setContent(content);
    if (message.getFromId()&lt;message.getToId()) &#123;
        message.setConversationId(message.getFromId()+&quot;_&quot;+message.getToId());
    &#125;else&#123;
        message.setConversationId(message.getToId()+&quot;_&quot;+message.getFromId());
    &#125;
    message.setStatus(0);
    message.setCreateTime(new Date());
    messageService.addMessage(message);

    return CommunityUtil.getJsonString(0);
&#125;
</code></pre>
<h2 id="4-前端"><a href="#4-前端" class="headerlink" title="4.前端"></a>4.前端</h2><pre><code class="javascript">$(function()&#123;
   $(&quot;#sendBtn&quot;).click(send_letter);
   $(&quot;.close&quot;).click(delete_msg);
&#125;);

function send_letter() &#123;
   $(&quot;#sendModal&quot;).modal(&quot;hide&quot;);

   let toName=$(&quot;#recipient-name&quot;).val();
   let content=$(&quot;#message-text&quot;).val();
   $.post(
      CONTEXT_PATH+&quot;/letter/send&quot;,
      &#123;&quot;toName&quot;:toName,&quot;content&quot;:content&#125;,
      function (data)&#123;
         data=$.parseJSON(data);
         if(data.code===0)&#123;
            $(&quot;#hintBody&quot;).text(&quot;发送成功&quot;)
         &#125;else&#123;
            $(&quot;#hintBody&quot;).text(data.msg)

         &#125;
         $(&quot;#hintModal&quot;).modal(&quot;show&quot;);
         setTimeout(function()&#123;
            $(&quot;#hintModal&quot;).modal(&quot;hide&quot;);
            location.reload();
         &#125;, 2000);
      &#125;
   )
&#125;
</code></pre>
<h1 id="十六-统一处理异常"><a href="#十六-统一处理异常" class="headerlink" title="十六.统一处理异常"></a>十六.统一处理异常</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223133010699.png" alt="image-20230223133010699"></p>
<p>advice包下:</p>
<pre><code class="java">//扫描带有controller的bean
@ControllerAdvice(annotations = Controller.class)
public class ExceptionAdvice &#123;
    private static final Logger logger= LoggerFactory.getLogger(ExceptionAdvice.class);


    @ExceptionHandler(&#123;Exception.class&#125;)
    public void handleException(Exception e, HttpServletRequest request, HttpServletResponse response) throws IOException &#123;
        logger.error(&quot;服务器发生异常:&quot;+e.getMessage());
        for (StackTraceElement stackTraceElement : e.getStackTrace()) &#123;
            logger.error(stackTraceElement.toString());
        &#125;
        //获取请求方式
        String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;);
        //该请求是异步请求,返回json
        if (&quot;XMLHttpRequest&quot;.equals(xRequestedWith))&#123;
            //设置响应格式为普通文本
            response.setContentType(&quot;application/plain;charset=utf-8&quot;);
            PrintWriter writer=response.getWriter();
            writer.write(CommunityUtil.getJsonString(1,&quot;服务器异常&quot;));
        &#125;else &#123;
            //普通请求
            //普通请求直接重定向到error界面
            response.sendRedirect(request.getContextPath()+&quot;/error&quot;);
        &#125;

    &#125;

&#125;
</code></pre>
<h1 id="十七-统一记录日志"><a href="#十七-统一记录日志" class="headerlink" title="十七.统一记录日志"></a>十七.统一记录日志</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141027338.png" alt="image-20230223141027338"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141318952.png" alt="image-20230223141318952"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223141734679.png" alt="image-20230223141734679"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223142344480.png" alt="image-20230223142344480"></p>
<h2 id="引入jar包-编写织入程序"><a href="#引入jar包-编写织入程序" class="headerlink" title="引入jar包,编写织入程序:"></a>引入jar包,编写织入程序:</h2><pre><code class="xml">&lt;!--aspect--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>aspect包下:</p>
<pre><code class="java">@Component
@Aspect
public class ServiceLogAspect &#123;
    private static final Logger logger= LoggerFactory.getLogger(ServiceLogAspect.class);

    //织入到service上的方法
    @Pointcut(&quot;execution(* com.newcode.community.service.*.*(..))&quot;)
    public void pointcut()&#123;
    &#125;

    @Before(&quot;pointcut()&quot;)
    public void before(JoinPoint point)&#123;
        //用户(ip)+在[时间],访问了[com.newcode.community.service.xxx()]
        ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = requestAttributes.getRequest();
        //获取ip
        String ip = request.getRemoteHost();

        String date = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());
        //类名+方法名
        String target = point.getSignature().getDeclaringTypeName() + &quot;.&quot; + point.getSignature().getName();

        logger.info(String.format(&quot;用户[%s]在[%s]访问了[%s].&quot;,ip,date,target));

    &#125;
&#125;
</code></pre>
<h1 id="十八-springboot整合redis"><a href="#十八-springboot整合redis" class="headerlink" title="十八.springboot整合redis"></a>十八.springboot整合redis</h1><p>​	<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223151757059.png" alt="image-20230223151757059"></p>
<h2 id="1-引入redis"><a href="#1-引入redis" class="headerlink" title="1.引入redis:"></a>1.引入redis:</h2><pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="2-重新装配redisTemplate"><a href="#2-重新装配redisTemplate" class="headerlink" title="2.重新装配redisTemplate"></a>2.重新装配redisTemplate</h2><pre><code class="java">@Configuration
public class redisConfig &#123;
    @Bean
    @SuppressWarnings(&quot;all&quot;)
    public RedisTemplate&lt;String,Object&gt;redisTemplate(RedisConnectionFactory factory)&#123;
        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();
        template.setConnectionFactory(factory);

        //设置key的序列化方式
        template.setKeySerializer(RedisSerializer.string());
        //设置value的序列化方式
        template.setValueSerializer(RedisSerializer.json());
        //设置hash的key的序列化方式
        template.setHashKeySerializer(RedisSerializer.string());
        //设置hash的value的序列化方式
        template.setHashValueSerializer(RedisSerializer.json());

        template.afterPropertiesSet();
        return template;
    &#125;
&#125;
</code></pre>
<h2 id="3-配置配置文件"><a href="#3-配置配置文件" class="headerlink" title="3.配置配置文件"></a>3.配置配置文件</h2><pre><code class="properties">#redis
#library index
spring.redis.database=11
spring.redis.host=43.143.232.99
spring.redis.password=*****
spring.redis.port=6379
</code></pre>
<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h2><pre><code class="java">@SpringBootTest
@ContextConfiguration(classes = NewCodeApplication.class)
@RunWith(SpringRunner.class)
public class redisTest &#123;

    @Resource
    private RedisTemplate redisTemplate;

    @Resource
    private StringRedisTemplate stringRedisTemplate;

    @Test
    public void test()&#123;
        //String redisKey=&quot;test:count&quot;;
        //redisTemplate.opsForValue().set(redisKey,1);
        //System.out.println(redisTemplate.opsForValue().get(redisKey));
        //
        //System.out.println(redisTemplate.opsForValue().increment(redisKey));
        //System.out.println(redisTemplate.opsForValue().decrement(redisKey));

        String testHash=&quot;test:hash1&quot;;
        redisTemplate.opsForHash().put(testHash,&quot;id&quot;,1);
        redisTemplate.opsForHash().put(testHash,&quot;username&quot;,&quot;张三&quot;);
        redisTemplate.opsForHash().get(testHash,&quot;username&quot;);
    &#125;

    //编程式事务
    @Test
    public void testTransactional()&#123;
        Object execute = redisTemplate.execute(new SessionCallback() &#123;
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException &#123;
                String redisKey = &quot;test:tx&quot;;
                operations.multi();
                operations.opsForSet().add(redisKey, &quot;张三&quot;);
                operations.opsForSet().add(redisKey, &quot;李四&quot;);
                operations.opsForSet().add(redisKey, &quot;王五&quot;);
                System.out.println(operations.opsForSet().members(redisKey));
                return operations.exec();
            &#125;
        &#125;);
        System.out.println(execute);
    &#125;

    //多次对一个key操作
    @Test
    public void testBound()&#123;
        String redisKey=&quot;test:bound1&quot;;
        redisTemplate.opsForValue().set(redisKey,1);
        BoundValueOperations operations=redisTemplate.boundValueOps(redisKey);
        operations.increment();
        operations.increment();
        operations.increment();
    &#125;


    @Test
    public void test1()&#123;
        stringRedisTemplate.opsForValue().set(&quot;test:count1&quot;,&quot;2&quot;);
    &#125;
&#125;
</code></pre>
<h1 id="十九-点赞"><a href="#十九-点赞" class="headerlink" title="十九.点赞"></a>十九.点赞</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230223155524642.png" alt="image-20230223155524642"></p>
<p>点赞或者取消点赞:</p>
<p>实现的逻辑是利用Redis的set数据结构, 点赞的数量统计为该结构内点赞用户id的数量,取消点赞就直接将用户id去除,判断是否点赞直接判断用户id是否在set内即可:</p>
<h2 id="1-业务层-1"><a href="#1-业务层-1" class="headerlink" title="1.业务层"></a>1.业务层</h2><pre><code class="java">/**
 *点赞法则:
 * 帖子的赞的entityType为1
 * 回复或者楼中楼的entityType为2
 */

//点赞
public void like(int userId,int entityType,int entityId)&#123;
    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
    //判断用户是否已经点过赞
    Boolean isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);
    if(isMember)&#123;
        //取消赞
        redisTemplate.opsForSet().remove(entityLikeKey,userId);
    &#125;else&#123;
        redisTemplate.opsForSet().add(entityLikeKey,userId);
    &#125;
&#125;

//点赞数量
public long findEntityLikeCount(int entityType,int entityId)&#123;
    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
    return redisTemplate.opsForSet().size(entityLikeKey);
&#125;

//查询某人对某实体有没有点过赞
//
public int findEntityLikeStatus(int userId,int entityType,int entityId)&#123;
    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
    //1已经点赞,0未点赞
    return redisTemplate.opsForSet().isMember(entityLikeKey,userId)?1:0;
&#125;
</code></pre>
<h2 id="2-控制层-2"><a href="#2-控制层-2" class="headerlink" title="2.控制层"></a>2.控制层</h2><pre><code class="java">@Controller
public class LikeController &#123;
    @Resource
    private LikeService likeService;
    @Resource
    private HostHolder holder;

    @PostMapping(&quot;/like&quot;)
    @ResponseBody
    public String like(int entityType,int entityId)&#123;
        User user = holder.getUser();
        //点赞
        likeService.like(user.getId(),entityType,entityId);
        //点赞的数量
        long count = likeService.findEntityLikeCount(entityType, entityId);
        //点赞的数量
        int entityLikeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);

        Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
        map.put(&quot;likeCount&quot;,count);
        map.put(&quot;status&quot;,entityLikeStatus);

        return CommunityUtil.getJsonString(0,null,map);
    &#125;
&#125;
</code></pre>
<h2 id="3-前端"><a href="#3-前端" class="headerlink" title="3.前端"></a>3.前端</h2><p>前端通过ajax异步发送请求实现点赞&#x2F;取消点赞效果</p>
<pre><code class="js">function like(btn,entityType,entityId)&#123;
    $.post(
        CONTEXT_PATH+&quot;/like&quot;,
        &#123;&quot;entityType&quot;:entityType,&quot;entityId&quot;:entityId&#125;,
        function (data)&#123;
            data=$.parseJSON(data);
            if(data.code===0)&#123;
                $(btn).children(&quot;i&quot;).text(data.likeCount)
                $(btn).children(&quot;b&quot;).text(data.status===1?&#39;已赞&#39;:&#39;赞&#39;)
            &#125;else&#123;
                alert(data.msg)
            &#125;
        &#125;
    )
&#125;
</code></pre>
<h1 id="二十-我收到的赞"><a href="#二十-我收到的赞" class="headerlink" title="二十.我收到的赞"></a>二十.我收到的赞</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224131207299.png" alt="image-20230224131207299"></p>
<p>重构点赞功能,增加以用户id构建的key:</p>
<pre><code class="java">//点赞
public void like(int userId,int entityType,int entityId,int entityUserId)&#123;
    redisTemplate.execute(new SessionCallback() &#123;
        @Override
        public Object execute(RedisOperations operations) throws DataAccessException &#123;
            //实体获得的赞
            String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
            //用户总共获得的赞
            String userLikeKey = redisKeyUtil.getUserLikeKey(entityUserId);
            Boolean isMember = operations.opsForSet().isMember(entityLikeKey, userId);
            //开启事务
            operations.multi();
            if(isMember)&#123;
                operations.opsForSet().remove(entityLikeKey,userId);
                operations.opsForValue().decrement(userLikeKey);
            &#125;else&#123;
                operations.opsForSet().add(entityLikeKey,userId);
                operations.opsForValue().increment(userLikeKey);
            &#125;
                    //执行事务
            return operations.exec();
        &#125;
    &#125;);
&#125;
//某个用户总共获得的数量
public int findUserLikeCount(int userId)&#123;
    String userLikeKey = redisKeyUtil.getUserLikeKey(userId);
    Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);
    return count==null?0:count;
&#125;

//帖子或者回复的点赞数量
public long findEntityLikeCount(int entityType,int entityId)&#123;
    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
    return redisTemplate.opsForSet().size(entityLikeKey);
&#125;

//查询某人对某实体有没有点过赞
public int findEntityLikeStatus(int userId,int entityType,int entityId)&#123;
    String entityLikeKey= redisKeyUtil.getEntityLike(entityType,entityId);
    //1已经点赞,0未点赞
    return redisTemplate.opsForSet().isMember(entityLikeKey,userId)?1:0;
&#125;
</code></pre>
<h1 id="二十一-关注-取消关注-关注列表-粉丝列表"><a href="#二十一-关注-取消关注-关注列表-粉丝列表" class="headerlink" title="二十一.关注&#x2F;取消关注 关注列表&#x2F;粉丝列表"></a>二十一.关注&#x2F;取消关注 关注列表&#x2F;粉丝列表</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224141844224.png" alt="image-20230224141844224"></p>
<p>本项目的粉丝列表只针对用户,但是帖子也可以调用该功能(用在帖子上就为收藏该帖子的用户)</p>
<h2 id="1-key的设计"><a href="#1-key的设计" class="headerlink" title="1.key的设计"></a>1.key的设计</h2><pre><code class="java">/**
 * 关注的行为只能发生在用户身上,但是关注的对象可以是其他用户或者帖子(关注帖子默认为收藏帖子)
 * 帖子实体type为1,用户实体为3
 */

//某个用户关注的实体(关注了谁)            实体的id   关注的时间
//      用户的id    关注的实体类型---&gt;zset(entityId,nowDate)
//followee:userId:entityType
public static String getFolloweeKey(int userId,int entityType)&#123;
    return PREFIX_FOLLOWEE+SPLIT+userId+SPLIT+entityType;
&#125;

//某个实体的关注者,粉丝(谁关注了我)
//follower:entityId:entityType----&gt;zset(userId,nowdate)
public static String getFollowerKey(int entityId,int entityType)&#123;
    return PREFIX_FOLLOWER+SPLIT+entityId+SPLIT+entityType;
&#125;

//验证码的key
public static String getKaptchaKey(String owner)&#123;
    return PREFIX_KAPTCHA+SPLIT+owner;
&#125;

//登录凭证
public static String getTicketKey(String ticket)&#123;
    return PREFIX_TICKET+SPLIT+ticket;
&#125;

public static String getUserKey(int userId)&#123;
    return PREFIX_User+SPLIT+userId;
&#125;
</code></pre>
<h2 id="2-业务层-1"><a href="#2-业务层-1" class="headerlink" title="2.业务层"></a>2.业务层</h2><p>使用redis的sorted-set结构, 按照一定的分数对元素进行排序</p>
<ul>
<li>由于关注时间也要传到前端,</li>
</ul>
<pre><code class="java">//关注某个实体
public void follow(int userId,int entityId,int entityType)&#123;
    redisTemplate.execute(new SessionCallback() &#123;
        @Override
        public Object execute(RedisOperations operations) throws DataAccessException &#123;
            //被哪些用户关注的key
            String followerKey = redisKeyUtil.getFollowerKey(entityId, entityType);
            //关注了哪些实体key
            String followeeKey = redisKeyUtil.getFolloweeKey(userId, entityType);
            //redis进入事务
            operations.multi();
            //将自己的id添加到被哪些用户关注的key
            operations.opsForZSet().add(followerKey,userId,System.currentTimeMillis());
            //将该实体添加到自己的关注列表
            operations.opsForZSet().add(followeeKey,entityId,System.currentTimeMillis());
            //提交事务
            return operations.exec();
        &#125;
    &#125;);
&#125;

//取消关注
public void unfollow(int userId,int entityId,int entityType)&#123;
    redisTemplate.execute(new SessionCallback() &#123;
        @Override
        public Object execute(RedisOperations operations) throws DataAccessException &#123;
            //被哪些用户关注的key
            String followerKey = redisKeyUtil.getFollowerKey(entityId, entityType);
            //关注了哪些实体key
            String followeeKey = redisKeyUtil.getFolloweeKey(userId, entityType);
            operations.multi();
            //将自己的id从到被哪些用户关注的key中删除
            operations.opsForZSet().remove(followerKey,userId);
            //将该实体从到自己的关注列表删除
            operations.opsForZSet().remove(followeeKey,entityId);
            return operations.exec();
        &#125;
    &#125;);
&#125;
//查询某个用户关注实体的数量
public long findFolloweeCount(int userId,int entityType)&#123;
    String followeeKey = redisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().zCard(followeeKey);
&#125;
//查询用户的关注
public List&lt;Map&lt;String,Object&gt;&gt;getFollowees(int entityType, int userId,int offset,int limit)&#123;
    String followerKey = redisKeyUtil.getFolloweeKey(userId, entityType);
    //获得所有有序集合内的元素按照分数从高到低排序
    Set&lt;Integer&gt; targetSet = redisTemplate.opsForZSet().reverseRange(followerKey, offset, limit + limit - 1);

    if(targetSet==null)&#123;
        return null;
    &#125;
    List&lt;Map&lt;String,Object&gt;&gt;list=new ArrayList&lt;&gt;();
    for (Integer targetId : targetSet) &#123;
        Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
        //粉丝实体
        User user = userService.findUserById(targetId);
        map.put(&quot;user&quot;,user);
        //关注时间
        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);
        map.put(&quot;followTime&quot;,new Date(score.longValue()));
        list.add(map);
    &#125;
    return list;
&#125;

//查询某个实体的粉丝数量
public long findFollowerCount(int entityType,int entityId)&#123;
    String followerKey = redisKeyUtil.getFollowerKey(entityId, entityType);
    //zcard命令查询该key结构内的所有元素数量
    return redisTemplate.opsForZSet().zCard(followerKey);
&#125;
//查询某个实体粉丝的ids
public List&lt;Map&lt;String,Object&gt;&gt;getFollowers(int entityType, int entityId,int offset,int limit)&#123;
    String followerKey = redisKeyUtil.getFollowerKey(entityId, entityType);
    //获得所有有序集合内的元素按照分数从高到低排序
    Set&lt;Integer&gt; fanSet = redisTemplate.opsForZSet().reverseRange(followerKey, offset, limit + limit - 1);

    if(fanSet==null)&#123;
        return null;
    &#125;
    List&lt;Map&lt;String,Object&gt;&gt;list=new ArrayList&lt;&gt;();
    for (Integer fanId : fanSet) &#123;
        Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
        //粉丝实体
        User user = userService.findUserById(fanId);
        map.put(&quot;user&quot;,user);
        //关注时间
        Double score = redisTemplate.opsForZSet().score(followerKey, fanId);
        map.put(&quot;followTime&quot;,new Date(score.longValue()));
        list.add(map);
    &#125;
    return list;
&#125;

//查询当前用户是否关注该实体
public boolean hasFollowed(int userId,int entityType,int entityId)&#123;
    String followeeKey = redisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().score(followeeKey,entityId)!=null;
&#125;
</code></pre>
<h2 id="3-控制层-1"><a href="#3-控制层-1" class="headerlink" title="3.控制层"></a>3.控制层</h2><pre><code class="java">@PostMapping(&quot;/follow&quot;)
@ResponseBody
public String follow(int entityId,int entityType)&#123;
    User user = holder.getUser();
    if(user.getId()==entityId&amp;&amp;entityType==ENTITY_TYPE_USER)&#123;
        return CommunityUtil.getJsonString(1,&quot;用户不能关注自己&quot;);
    &#125;
    followService.follow(user.getId(),entityId,entityType);
    return CommunityUtil.getJsonString(0,&quot;已关注&quot;);
&#125;
@PostMapping(&quot;/unfollow&quot;)
@ResponseBody
public String unfollow(int entityId,int entityType)&#123;
    User user = holder.getUser();
    followService.unfollow(user.getId(),entityId,entityType);
    return CommunityUtil.getJsonString(0,&quot;已取消关注&quot;);
&#125;
@GetMapping(&quot;/follower/&#123;userId&#125;&quot;)
public String follower(Model model, Page page, @PathVariable(&quot;userId&quot;)int userId)&#123;
    //查询用户
    User user = userService.findUserById(userId);
    if(user==null)&#123;
        throw new IllegalArgumentException(&quot;该用户不存在&quot;);
    &#125;
    model.addAttribute(&quot;user&quot;,user);
    page.setLimit(5);
    page.setPath(&quot;/follower/&quot;+user.getId());
    page.setRows((int)followService.findFolloweeCount(userId,ENTITY_TYPE_USER));
    List&lt;Map&lt;String,Object&gt;&gt; userList=followService.getFollowers(ENTITY_TYPE_USER,user.getId(),page.getOffset(),page.getLimit());
    if (userList!=null)&#123;
        for (Map&lt;String, Object&gt; map : userList) &#123;
            //关注的人
            User u = (User)map.get(&quot;user&quot;);
            boolean hasFollowed = hasFollowed(u.getId());
            map.put(&quot;hasFollowed&quot;,hasFollowed);
        &#125;
    &#125;
    model.addAttribute(&quot;users&quot;,userList);
    return &quot;/site/follower&quot;;
&#125;

@GetMapping(&quot;/followee/&#123;userId&#125;&quot;)
public String followee(Model model, Page page, @PathVariable(&quot;userId&quot;)int userId)&#123;
    //查询用户
    User user = userService.findUserById(userId);
    if(user==null)&#123;
        throw new IllegalArgumentException(&quot;该用户不存在&quot;);
    &#125;
    model.addAttribute(&quot;user&quot;,user);
    page.setLimit(5);
    page.setPath(&quot;/followee/&quot;+user.getId());
    page.setRows((int)followService.findFolloweeCount(userId,ENTITY_TYPE_USER));
    List&lt;Map&lt;String,Object&gt;&gt; userList=followService.getFollowees(ENTITY_TYPE_USER,user.getId(),page.getOffset(),page.getLimit());
    if (userList!=null)&#123;
        for (Map&lt;String, Object&gt; map : userList) &#123;
            //关注的人的关注的人
            User u = (User)map.get(&quot;user&quot;);
            boolean hasFollowed = hasFollowed(u.getId());
            map.put(&quot;hasFollowed&quot;,hasFollowed);
        &#125;
    &#125;
    model.addAttribute(&quot;users&quot;,userList);
    return &quot;/site/followee&quot;;
&#125;
//当前用户是否关注传入的用户
private boolean hasFollowed(int userId)&#123;
    if(holder.getUser()==null)&#123;
        return false;
    &#125;
    return followService.hasFollowed(holder.getUser().getId(),ENTITY_TYPE_USER,userId);
&#125;
</code></pre>
<h2 id="4-前端-1"><a href="#4-前端-1" class="headerlink" title="4.前端"></a>4.前端</h2><pre><code class="js">$(function()&#123;
   $(&quot;.follow-btn&quot;).click(follow);
&#125;);

function follow() &#123;
   var btn = this;
   if ($(btn).hasClass(&quot;btn-info&quot;)) &#123;
      // 关注TA
      $.post(
         CONTEXT_PATH + &quot;/follow&quot;,
         &#123;&quot;entityType&quot;: 3, &quot;entityId&quot;: $(btn).prev().val()&#125;,
         function (data) &#123;
            data = $.parseJSON(data)
            if (data.code === 0) &#123;
               window.location.reload();
            &#125; else &#123;
               alert(data.msg)
            &#125;
         &#125;
      )
   &#125; else &#123;
      // 取消关注
      if ($(btn).hasClass(&quot;btn-secondary&quot;)) &#123;
         // 关注TA
         $.post(
            CONTEXT_PATH + &quot;/unfollow&quot;,
            &#123;&quot;entityType&quot;: 3, &quot;entityId&quot;: $(btn).prev().val()&#125;,
            function (data) &#123;
               data = $.parseJSON(data)
               if (data.code === 0) &#123;
                  window.location.reload();
               &#125; else &#123;
                  alert(data.msg)
               &#125;
            &#125;
         )
      &#125;
   &#125;
&#125;
</code></pre>
<h1 id="二十二-优化登录模块"><a href="#二十二-优化登录模块" class="headerlink" title="二十二.优化登录模块"></a>二十二.优化登录模块</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230224170234266.png" alt="image-20230224170234266"></p>
<h2 id="1-优化验证码"><a href="#1-优化验证码" class="headerlink" title="1.优化验证码"></a>1.优化验证码</h2><p>由于用户在验证码阶段未登录,所以无法获得userId. 那么我们需要创造一个短暂的唯一标识标记本次用户验证码的行为.</p>
<p>刷新验证码时利用uuid创造一个标识,存入cookie中</p>
<pre><code class="java">//验证码的归属者
String kaptchaOwner = CommunityUtil.generateUUID();
Cookie cookie=new Cookie(&quot;kaptchaOwner&quot;,kaptchaOwner);
//验证码有效时间:120s
cookie.setMaxAge(120);
cookie.setPath(contextPath);
response.addCookie(cookie);
</code></pre>
<p>然后利用该标识创造一段rediskey连同验证码存入到redis中:</p>
<pre><code class="java">//将验证码存入redis
String redisKey = redisKeyUtil.getKaptchaKey(kaptchaOwner);
//有效时间120s
redisTemplate.opsForValue().set(redisKey,text,120, TimeUnit.SECONDS);
</code></pre>
<p>之后就从redis中获取正确的验证码:</p>
<pre><code class="java">@PostMapping(&quot;/login&quot;)
    public String login(String username, String password, String code, boolean rememberMe,
                        Model model, HttpServletResponse response,
                        @CookieValue(&quot;kaptchaOwner&quot;)String kaptchaOwner)&#123;
        //检查验证码
        //String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);
        if (StringUtils.isBlank(kaptchaOwner))&#123;
            model.addAttribute(&quot;codeMsg&quot;,&quot;验证码已经过期,请重新输入&quot;);
            return &quot;/site/login&quot;;
        &#125;
        String redisKey = redisKeyUtil.getKaptchaKey(kaptchaOwner);
        String kaptchaCode =(String) redisTemplate.opsForValue().get(redisKey);
        if (StringUtils.isBlank(code)||StringUtils.isBlank(kaptchaCode)||!kaptchaCode.equalsIgnoreCase(code)) &#123;
            model.addAttribute(&quot;codeMsg&quot;,&quot;验证码不正确&quot;);
            return &quot;/site/login&quot;;
        &#125;
</code></pre>
<h2 id="2-使用redis存储登录凭证"><a href="#2-使用redis存储登录凭证" class="headerlink" title="2.使用redis存储登录凭证"></a>2.使用redis存储登录凭证</h2><p>登录凭证的结构:</p>
<pre><code class="java">@Data
public class LoginTicket &#123;
    private int id;
    private int userId;
    //1为删除 0为正常使用
    private int status;
    //过期时间
    private Date expired;
    //标识
    private String ticket;
&#125;
</code></pre>
<p>将原本的mapper设置为废弃:</p>
<pre><code class="java">@Mapper
@Deprecated
public interface LoginTicketMapper &#123;
</code></pre>
<p>在登录成功后生成登录凭证传给redis:</p>
<pre><code class="java">//全部通过之后,成功登录,生成登录凭证
LoginTicket loginTicket=new LoginTicket();
loginTicket.setTicket(CommunityUtil.generateUUID());
loginTicket.setUserId(user.getId());
loginTicket.setStatus(0);
//过期时间
loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds* 1000L));
//loginTicketMapper.insertLoginTicket(loginTicket);
String ticketKey = redisKeyUtil.getTicketKey(loginTicket.getTicket());
redisTemplate.opsForValue().set(ticketKey,loginTicket);
map.put(&quot;ticket&quot;,loginTicket.getTicket());
return map;
</code></pre>
<p>登出时将登录凭证设置为不可用:</p>
<pre><code class="java">public void logout(String ticket)&#123;
    //loginTicketMapper.updateStatus(ticket,1);
    String ticketKey = redisKeyUtil.getTicketKey(ticket);
    LoginTicket loginTicket =(LoginTicket) redisTemplate.opsForValue().get(ticketKey);
    loginTicket.setStatus(1);
    redisTemplate.opsForValue().set(ticketKey,loginTicket);
&#125;
</code></pre>
<p>在用户登录状态下如果凭证失效时间与当前时间相差小于两个小时,那么刷新凭证的有效时间,添加两个小时:</p>
<p>(防止用户使用网站用着用着就要返回登录)</p>
<p>在LoginTicketInterceptor中操作:</p>
<pre><code class="java">if(ticket!=null)&#123;
    //表示登录了
    //查询凭证
    LoginTicket loginTicket = userService.findLoginTicket(ticket);
    //检查凭证是否有效
    if(loginTicket!=null&amp;&amp;loginTicket.getStatus()==0&amp;&amp;loginTicket.getExpired().after(new Date()))&#123;
        //根据凭证查询用户
        User user = userService.findUserById(loginTicket.getUserId());
        //在本次请求中持有用户
        hostHolder.setUser(user);
        //增加登录凭证的有效时间
        Date now = new Date();
        //相差的毫秒数
        long diff=loginTicket.getExpired().getTime()-now.getTime();
        if(diff/(1000*60*60)&lt;2)&#123;
            //凭证加两个小时
            long newTime=now.getTime()+2*60*60*1000;
            Date newExpired = new Date(newTime);
            loginTicket.setExpired(newExpired);
            String ticketKey = redisKeyUtil.getTicketKey(loginTicket.getTicket());
            redisTemplate.opsForValue().set(ticketKey,ticket);
        &#125;
    &#125;
&#125;
return true;
</code></pre>
<h2 id="3-缓存用户信息"><a href="#3-缓存用户信息" class="headerlink" title="3.缓存用户信息"></a>3.缓存用户信息</h2><pre><code class="java"> //优先从缓存中取值
    private User getUserFromCache(int userId)&#123;
        String userKey = redisKeyUtil.getUserKey(userId);
        return (User) redisTemplate.opsForValue().get(userKey);
    &#125;
    //取不到初始化缓存数据
    private User InitCache(int userId)&#123;
        User user = userMapper.selectById(userId);
        String userKey = redisKeyUtil.getUserKey(userId);
        redisTemplate.opsForValue().set(userKey,user,60*60*2, TimeUnit.SECONDS);
        return user;
    &#125;
    //数据变化时清除缓存数据
    private void clearCache(int userId)&#123;
        String userKey = redisKeyUtil.getUserKey(userId);
        redisTemplate.delete(userKey);
    &#125;
</code></pre>
<pre><code class="java">public User findUserById(int id)&#123;
    //return userMapper.selectById(id);
    User userFromCache = getUserFromCache(id);
    if(userFromCache==null)&#123;
        userFromCache = InitCache(id);
    &#125;
    return userFromCache;
&#125;
</code></pre>
<p>用户更新信息时,让缓存失效,例如:</p>
<pre><code class="java">//激活状态码
public int activation(int userId,String code)&#123;
    User user = userMapper.selectById(userId);
    if(user==null)&#123;
        return ACTIVATION_FAILURE;
    &#125;
    if(user.getStatus()==1)&#123;
        //已经激活过了
        return ACTIVATION_REPEAT;
    &#125;
    if(user.getActivationCode().equals(code))&#123;
        userMapper.updateStatus(userId,1);
        clearCache(userId);
        return ACTIVATION_SUCCESS;
    &#125;else&#123;
        return ACTIVATION_FAILURE;
    &#125;
&#125;
  public int updateHeaderImg(int userId,String url)&#123;
        int col = userMapper.updateHeaderUrl(userId, url);
        clearCache(userId);
        return col;
    &#125;

    public int updatePassword(int userId,String newPassword)&#123;
        int col = userMapper.updatePassword(userId, newPassword);
        clearCache(userId);
        return col;
    &#125;
</code></pre>
<h1 id="二十三-阻塞队列"><a href="#二十三-阻塞队列" class="headerlink" title="二十三.阻塞队列"></a>二十三.阻塞队列</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225125903848.png" alt="image-20230225125903848"></p>
<h1 id="二十四-kafka"><a href="#二十四-kafka" class="headerlink" title="二十四.kafka"></a>二十四.kafka</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225130622534.png" alt="image-20230225130622534"></p>
<h2 id="1启动kafka步骤"><a href="#1启动kafka步骤" class="headerlink" title="1启动kafka步骤"></a>1启动kafka步骤</h2><p>(在版本号的目录下,windows环境)<br>开启zookeeper的命令: bin\windows\zookeeper-server-start.bat config\zookeeper.properties</p>
<p>开启kafka的命令: bin\windows\kafka-server-start.bat config\server.properties</p>
<p>创建topic(test)的命令: bin\windows\kafka-topics.bat –create –bootstrap-server localhost:9092 –replication-factor 1 –partitions 1 –topic test</p>
<p>生产者: bin\windows\kafka-console-producer.bat –broker-list localhost:9092 –topic test</p>
<p>消费者: bin\windows\kafka-console-consumer.bat –bootstrap-server localhost:9092 –topic test –from-beginning</p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225133538730.png" alt="image-20230225133538730"></p>
<h2 id="2配置文件"><a href="#2配置文件" class="headerlink" title="2配置文件:"></a>2配置文件:</h2><pre><code class="properties">#kafkaProperties
spring.kafka.bootstrap-servers=localhost:9092
spring.kafka.consumer.group-id=test-consumer-group
spring.kafka.consumer.enable-auto-commit=true
spring.kafka.consumer.auto-commit-interval=3000s
</code></pre>
<h2 id="3-测试kafka"><a href="#3-测试kafka" class="headerlink" title="3.测试kafka"></a>3.测试kafka</h2><pre><code class="java">@SpringBootTest
@ContextConfiguration(classes = NewCodeApplication.class)
@RunWith(SpringRunner.class)
public class kafkaTest &#123;
    @Resource
    private kafkaProduce kafkaProduce;
    @Test
    public void testKafka() throws InterruptedException &#123;
        kafkaProduce.sendMessage(&quot;test&quot;,&quot;howareyou&quot;);
        kafkaProduce.sendMessage(&quot;test&quot;,&quot;ok?&quot;);
    &#125;
&#125;
@Component
class kafkaProduce&#123;

    @Resource
    private KafkaTemplate kafkaTemplate;
    public void sendMessage(String topic,String content)&#123;
        kafkaTemplate.send(topic,content);
    &#125;
&#125;

@Component
class kafkaConsumer&#123;
    @KafkaListener(topics = &#123;&quot;test&quot;&#125;)
    public void handleMessage(ConsumerRecord record)&#123;
        System.out.println(record.value());
    &#125;
&#125;
</code></pre>
<h1 id="二十五-发布系统通知"><a href="#二十五-发布系统通知" class="headerlink" title="二十五.发布系统通知"></a>二十五.发布系统通知</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225153859011.png" alt="image-20230225153859011"></p>
<p>当用户点赞,评论或者关注后. 系统用户都会发送一条message给被点赞,关注和评论的人. 这个功能需要用到kafka</p>
<p>我们把点赞,关注和评论当做一种事件, 当事件发生时,用kafka做自动推送</p>
<h2 id="1-事件的实体"><a href="#1-事件的实体" class="headerlink" title="1.事件的实体:"></a>1.事件的实体:</h2><pre><code class="java">//主题
private String topic;
//产生事件的用户id
private int userId;
//事件作用对象的type
private int entityType;
//事件作用对象的Id
private int entityId;
//事件作用对象的userID(如果是关注,那么userid=entityID)
private int entityUserId;
//携带的数据
private Map&lt;String,Object&gt;data=new HashMap&lt;&gt;();

public String getTopic() &#123;
    return topic;
&#125;

public Event setTopic(String topic) &#123;
    this.topic = topic;
    return this;
&#125;

public int getUserId() &#123;
    return userId;
&#125;

public Event setUserId(int userId) &#123;
    this.userId = userId;
    return this;
&#125;

public int getEntityType() &#123;
    return entityType;
&#125;

public Event setEntityType(int entityType) &#123;
    this.entityType = entityType;
    return this;
&#125;

public int getEntityId() &#123;
    return entityId;
&#125;

public Event setEntityId(int entityId) &#123;
    this.entityId = entityId;
    return this;
&#125;

public int getEntityUserId() &#123;
    return entityUserId;
&#125;

public Event setEntityUserId(int entityUserId) &#123;
    this.entityUserId = entityUserId;
    return this;
&#125;


public Map&lt;String, Object&gt; getData() &#123;
    return data;
&#125;

public Event setData(String key,Object value) &#123;
    this.data.put(key,value);
    return this;
&#125;
</code></pre>
<h2 id="2-事件的生产者"><a href="#2-事件的生产者" class="headerlink" title="2.事件的生产者"></a>2.事件的生产者</h2><pre><code class="java">@Component
public class EventProducer &#123;
    @Resource
    private KafkaTemplate kafkaTemplate;

    //提供处理事件的方法
    public void fireEvent(Event event)&#123;
        //将事件发布到指定的主题
        //将事件实体以JSON字符串的形式发送
        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));
    &#125;
&#125;
</code></pre>
<h2 id="3-事件的消费者"><a href="#3-事件的消费者" class="headerlink" title="3.事件的消费者"></a>3.事件的消费者</h2><pre><code class="java">@Component
public class EventConsumer implements CommunityConstant &#123;
    private static final Logger logger= LoggerFactory.getLogger(EventConsumer.class);

    @Resource
    private MessageService messageService;

    //往message表中插入数据
    @KafkaListener(topics = &#123;TOPIC_COMMENT,TOPIC_FOLLOW,TOPIC_LIKE&#125;)
    public void handleCommentMessage(ConsumerRecord record)&#123;
        if(record==null||record.value()==null)&#123;
            logger.error(&quot;消息的内容为空&quot;);
            return;
        &#125;
        Event event = JSONObject.parseObject(record.value().toString(), Event.class);
        if(event==null)&#123;
            logger.error(&quot;消息格式错误&quot;);
        &#125;
        //发送站内通知
        Message message = new Message();
        //来自系统
        message.setFromId(SYSTEM_USER_ID);
        message.setCreateTime(new Date());
        message.setToId(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        //消息为未读
        message.setStatus(0);
        //
        Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
        //map携带产生事件的userID
        map.put(&quot;userId&quot;,event.getUserId());
        //事件作用对象的type
        map.put(&quot;entityType&quot;,event.getEntityType());
        //事件作用对象的id
        map.put(&quot;evtityId&quot;,event.getEntityId());
        if(event.getData()!=null)&#123;
            for (Map.Entry&lt;String, Object&gt; stringObjectEntry : event.getData().entrySet()) &#123;
                map.put(stringObjectEntry.getKey(),stringObjectEntry.getValue());
            &#125;
        &#125;
        message.setContent(JSONObject.toJSONString(map));
        messageService.addMessage(message);
    &#125;
&#125;
</code></pre>
<h2 id="4-拿点赞举例"><a href="#4-拿点赞举例" class="headerlink" title="4.拿点赞举例"></a>4.拿点赞举例</h2><pre><code class="java">//触发点赞事件
if(entityLikeStatus==1)&#123;
    Event event=new Event();
    event.setTopic(TOPIC_LIKE)
            .setUserId(user.getId())
            .setEntityType(entityType)
            .setEntityId(entityId)
            .setEntityUserId(entityUserId)
            //data里面存储点赞所在的帖子的id(点赞的不一定是帖子,也可能是回复)
            .setData(&quot;postId&quot;,postId);
    producer.fireEvent(event);
&#125;
</code></pre>
<h1 id="二十六-显示系统通知"><a href="#二十六-显示系统通知" class="headerlink" title="二十六.显示系统通知"></a>二十六.显示系统通知</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230225153835023.png" alt="image-20230225153835023"></p>
<h2 id="1-数据层-1"><a href="#1-数据层-1" class="headerlink" title="1.数据层"></a>1.数据层</h2><pre><code class="xml">&lt;!--查询最新的一条通知--&gt;
&lt;select id=&quot;selectLatestNotice&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message
    where id in(
        select max(id) from message
        where status!=2 and from_id=1 and to_id=#&#123;userId&#125;
         and conversation_id=#&#123;topic&#125;
    )
&lt;/select&gt;
&lt;!--查询通知总数--&gt;
&lt;select id=&quot;selectNoticeCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status!=2 and from_id=1 and to_id=#&#123;userId&#125;
      and conversation_id=#&#123;topic&#125;
&lt;/select&gt;
&lt;!--查询未读的通知数量--&gt;
&lt;select id=&quot;selectNoticeUnreadCount&quot; resultType=&quot;int&quot;&gt;
    select count(id) from message
    where status=0 and from_id=1 and to_id=#&#123;userId&#125;
        &lt;if test=&quot;topic!=null&quot;&gt;
            and conversation_id=#&#123;topic&#125;
        &lt;/if&gt;
&lt;/select&gt;
&lt;!--查询通知,带有分页条件--&gt;
&lt;select id=&quot;selectNotice&quot; resultType=&quot;message&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt; from message
    where status!=2 and from_id=1 and to_id=#&#123;userId&#125;  and conversation_id=#&#123;topic&#125;
    order by id desc
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;
</code></pre>
<h2 id="2-控制层-3"><a href="#2-控制层-3" class="headerlink" title="2.控制层"></a>2.控制层</h2><pre><code class="java">@GetMapping(&quot;/notice/list&quot;)
public String getNoticeList(Model model)&#123;
    User user = holder.getUser();

    //查询评论内容
    //最新的一条评论通知
    Message message=messageService.findLatestNotice(user.getId(),TOPIC_COMMENT);
    Map&lt;String,Object&gt;messageVo=new HashMap&lt;&gt;();
    messageVo.put(&quot;message&quot;,message);
    if(message!=null)&#123;
        //将json字符串里的特殊字符转义
        String content= HtmlUtils.htmlUnescape(message.getContent());
        //content是以JSON对象存储的
        HashMap&lt;String,Object&gt; data = JSONObject.parseObject(content, HashMap.class);
        //产生事件的user
        messageVo.put(&quot;user&quot;,userService.findUserById((int)data.get(&quot;userId&quot;)));
        //实体的类型
        messageVo.put(&quot;entityType&quot;,data.get(&quot;entityType&quot;));
        //实体的id
        messageVo.put(&quot;entityId&quot;,data.get(&quot;entityId&quot;));
        //帖子的id
        messageVo.put(&quot;postId&quot;,data.get(&quot;postId&quot;));
        //查询评论通知数量总数
        int count=messageService.findNoticeCount(user.getId(),TOPIC_COMMENT);
        messageVo.put(&quot;count&quot;,count);
        //查询未读的评论通知数量
        int unreadCount=messageService.findNoticeUnreadCount(user.getId(),TOPIC_COMMENT);
        messageVo.put(&quot;unread&quot;,unreadCount);
        model.addAttribute(&quot;commentNotice&quot;,messageVo);
         //查询未读消息数量
        int unreadLetterCount = messageService.findUnreadLetter(user.getId(), null);
        model.addAttribute(&quot;unreadLetterCount&quot;,unreadLetterCount);
        //查询总共未读的通知数量
        int noticeUnreadCount=messageService.findNoticeUnreadCount(user.getId(),null);
        model.addAttribute(&quot;noticeUnreadCount&quot;,noticeUnreadCount);
        return &quot;/site/notice&quot;;
        &#125;
    &#125;
</code></pre>
<h2 id="3-具体的消息内容"><a href="#3-具体的消息内容" class="headerlink" title="3.具体的消息内容"></a>3.具体的消息内容</h2><pre><code class="java">@GetMapping(&quot;/notice/detail/&#123;topic&#125;&quot;)
public String noticeDetail(@PathVariable(&quot;topic&quot;)String topic,Model model,Page page)&#123;
    User user = holder.getUser();
    page.setLimit(5);
    page.setPath(&quot;/notice/detail/&quot;+topic);
    page.setRows(messageService.findNoticeCount(user.getId(),topic));

    List&lt;Message&gt; notices = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String,Object&gt;&gt;noticeVoList=new ArrayList&lt;&gt;();
    if (notices!=null)&#123;
        for (Message notice : notices) &#123;
            Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
            //通知
            map.put(&quot;notice&quot;,notice);
            //内容
            String content = HtmlUtils.htmlUnescape(notice.getContent());
            HashMap&lt;String,Object&gt; data = JSONObject.parseObject(content, HashMap.class);
            map.put(&quot;user&quot;,userService.findUserById((int)data.get(&quot;userId&quot;)));
            map.put(&quot;entityType&quot;,data.get(&quot;entityType&quot;));
            map.put(&quot;entityId&quot;,data.get(&quot;entityId&quot;));
            map.put(&quot;postId&quot;,data.get(&quot;postId&quot;));
            //通知的作者
            User fromUser = userService.findUserById(notice.getFromId());
            map.put(&quot;fromUser&quot;,fromUser);

            noticeVoList.add(map);
        &#125;
    &#125;
    model.addAttribute(&quot;notices&quot;,noticeVoList);
    //设置已读
    List&lt;Integer&gt;ids=getLetterIds(notices);
    if(ids!=null&amp;&amp; !ids.isEmpty())&#123;
        messageService.readMessage(ids);
    &#125;
    return &quot;/site/notice-detail&quot;;
&#125;
</code></pre>
<h1 id="二十七-Elasticsearch入门-社区搜索"><a href="#二十七-Elasticsearch入门-社区搜索" class="headerlink" title="二十七.Elasticsearch入门(社区搜索)"></a>二十七.Elasticsearch入门(社区搜索)</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230226135521624.png" alt="image-20230226135521624"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230226150344717.png" alt="image-20230226150344717"></p>
<h2 id="1-配置"><a href="#1-配置" class="headerlink" title="1.配置:"></a>1.配置:</h2><pre><code class="properties">spring.data.elasticsearch.cluster-node=127.0.0.1:9300
spring.elasticsearch.uris= http://localhost:9200
elasticSearch.url=127.0.0.1:9200
</code></pre>
<p>配置文件</p>
<pre><code class="java">@Configuration
public class EsConfig &#123;
    @Value(&quot;$&#123;elasticSearch.url&#125;&quot;)
    String esUrl;

    @Bean
    public RestHighLevelClient client()&#123;
        return new RestHighLevelClient(
                RestClient.builder(new HttpHost(&quot;127.0.0.1&quot;, 9200, &quot;http&quot;))
                        .setRequestConfigCallback(new RestClientBuilder.RequestConfigCallback() &#123;
                            @Override
                            public RequestConfig.Builder customizeRequestConfig(RequestConfig.Builder builder) &#123;
                                return builder.setConnectTimeout(5000 * 1000) // 连接超时（默认为1秒）
                                        .setSocketTimeout(6000 * 1000);// 套接字超时（默认为30秒）//更改客户端的超时限制默认30秒现在改为100*1000分钟
                            &#125;
                        &#125;)
        );
    &#125;
&#125;
</code></pre>
<h2 id="2-es接口层"><a href="#2-es接口层" class="headerlink" title="2.es接口层"></a>2.es接口层</h2><pre><code class="java">@Repository
public interface DiscussPostRepository extends ElasticsearchRepository&lt;DiscussPost,Integer&gt; &#123;

&#125;
</code></pre>
<p>添加一个返回类作为分页工具</p>
<pre><code class="java">@Data
@NoArgsConstructor
@AllArgsConstructor
public class SearchResult &#123;
    private List&lt;DiscussPost&gt; list;
    private long total;
&#125;
</code></pre>
<h2 id="3-业务层"><a href="#3-业务层" class="headerlink" title="3.业务层"></a>3.业务层</h2><pre><code class="java">@Service
public class ElasticSearchService &#123;
    @Resource
    private DiscussPostRepository discussPostRepository;

    @Resource
    @Qualifier(&quot;client&quot;)
    private RestHighLevelClient restHighLevelClient;

    public void saveDiscussPost(DiscussPost discussPost)&#123;
        discussPostRepository.save(discussPost);
    &#125;

    public void deleteDiscussPost(int id)&#123;
        discussPostRepository.deleteById(id);
    &#125;

    public SearchResult SearchResult(String keyword, int current, int limit)&#123;
        SearchRequest searchRequest=new SearchRequest(&quot;discusspost&quot;);
        //高亮
        HighlightBuilder highlightBuilder=new HighlightBuilder();
        highlightBuilder.field(&quot;title&quot;);
        highlightBuilder.field(&quot;content&quot;);
        highlightBuilder.requireFieldMatch(false);
        highlightBuilder.preTags(&quot;&lt;span style=&#39;color:red&#39;&gt;&quot;);
        highlightBuilder.postTags(&quot;&lt;/span&gt;&quot;);
        //构建搜索条件
        SearchSourceBuilder searchSourceBuilder  = new SearchSourceBuilder()
                .query(QueryBuilders.multiMatchQuery(keyword, &quot;title&quot;, &quot;content&quot;))
                .sort(SortBuilders.fieldSort(&quot;type&quot;).order(SortOrder.DESC))
                .sort(SortBuilders.fieldSort(&quot;score&quot;).order(SortOrder.DESC))
                .sort(SortBuilders.fieldSort(&quot;createTime&quot;).order(SortOrder.DESC))
                .from(current)// 指定从哪条开始查询
                .size(limit)// 需要查出的总记录条数
                .highlighter(highlightBuilder);
        searchRequest.source(searchSourceBuilder);
        SearchResponse searchResponse= null;
        long total=0L;
        try &#123;
            searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);
             total=searchResponse.getHits().getTotalHits().value;
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
        List&lt;DiscussPost&gt; list=new ArrayList&lt;&gt;();
        for (SearchHit hit : searchResponse.getHits().getHits()) &#123;
            DiscussPost discussPost = JSONObject.parseObject(hit.getSourceAsString(), DiscussPost.class);

            // 处理高亮显示的结果
            HighlightField titleField = hit.getHighlightFields().get(&quot;title&quot;);
            if (titleField != null) &#123;
                discussPost.setTitle(titleField.getFragments()[0].toString());
            &#125;
            HighlightField contentField = hit.getHighlightFields().get(&quot;content&quot;);
            if (contentField != null) &#123;
                discussPost.setContent(contentField.getFragments()[0].toString());
            &#125;
            list.add(discussPost);
        &#125;
        return new SearchResult(list,total);
    &#125;
&#125;
</code></pre>
<h2 id="4-消息队列同步数据"><a href="#4-消息队列同步数据" class="headerlink" title="4.消息队列同步数据"></a>4.消息队列同步数据</h2><p>当回复一个帖子或者发布帖子时,我们通过kafka将数据同步到es中:</p>
<pre><code class="java">//消费发布事件
@KafkaListener(topics = &#123;TOPIC_PUBLISH_POST&#125;)
public void handlePublishMessage(ConsumerRecord record)&#123;
    if(record==null||record.value()==null)&#123;
        logger.error(&quot;消息的内容为空&quot;);
        return;
    &#125;
    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if(event==null)&#123;
        logger.error(&quot;消息格式错误&quot;);
    &#125;
    DiscussPost post = discussPostService.selectDiscussPostById(event.getEntityId());
    //存到es中
    elasticSearchService.saveDiscussPost(post);
&#125;
</code></pre>
<h2 id="5-控制层"><a href="#5-控制层" class="headerlink" title="5.控制层"></a>5.控制层</h2><p>CommentController:</p>
<p>添加回复方法的最后追加:</p>
<pre><code class="java">//回复帖子相当于修改了帖子的状态,需要修改信息到es
if(comment.getEntityType()==ENTITY_TYPE_POST)&#123;
    //触发评论事件--&gt;搜索
    event=new Event().setTopic(TOPIC_PUBLISH_POST)
            .setUserId(comment.getId())
            .setEntityId(ENTITY_TYPE_POST)
            .setEntityId(discussPostId);
    eventProducer.fireEvent(event);
&#125;
</code></pre>
<p>DiscussPostControlle添加帖子的最后追加:</p>
<pre><code class="java">Event event=new Event().setTopic(TOPIC_PUBLISH_POST)
        .setUserId(user.getId())
        .setEntityId(ENTITY_TYPE_POST)
        .setEntityId(post.getId());
eventProducer.fireEvent(event);
</code></pre>
<p>搜索视图层:</p>
<pre><code class="java">@GetMapping(&quot;/search&quot;)
public String search(String keyword, Page page, Model model)&#123;
    SearchResult searchResult = elasticSearchService.SearchResult(keyword, page.getOffset(), page.getLimit());
    List&lt;Map&lt;String,Object&gt;&gt;discussPosts=new ArrayList&lt;&gt;();
    List&lt;DiscussPost&gt; list = searchResult.getList();
    if(list!=null)&#123;
        for (DiscussPost post : list) &#123;
            Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
            map.put(&quot;post&quot;,post);
            map.put(&quot;user&quot;,userService.findUserById(post.getUserId()));

            map.put(&quot;likeCount&quot;,likeService.findEntityLikeCount(ENTITY_TYPE_POST,post.getId()));
            discussPosts.add(map);
        &#125;
    &#125;
    model.addAttribute(&quot;discussPosts&quot;,discussPosts);
    model.addAttribute(&quot;keyword&quot;,keyword);
    //分页信息
    page.setPath(&quot;/search?keyword=&quot;+keyword);
    page.setRows(searchResult.getTotal()==0?0:(int)searchResult.getTotal());
    return &quot;/site/search&quot;;
&#125;
</code></pre>
<h1 id="二十八-springsecurity"><a href="#二十八-springsecurity" class="headerlink" title="二十八.springsecurity"></a>二十八.springsecurity</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227120845866.png" alt="image-20230227120845866"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227120831437.png" alt="image-20230227120831437"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230227161909892.png" alt="image-20230227161909892"></p>
<p>入门springsecurity博文:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuminglei1987/article/details/107538666?spm=1001.2014.3001.5506">https://blog.csdn.net/liuminglei1987/article/details/107538666?spm=1001.2014.3001.5506</a></p>
<h1 id="二十九-置顶-加精-删除"><a href="#二十九-置顶-加精-删除" class="headerlink" title="二十九.置顶,加精,删除"></a>二十九.置顶,加精,删除</h1><h2 id="0-引入依赖"><a href="#0-引入依赖" class="headerlink" title="0.引入依赖"></a>0.引入依赖</h2><pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- https://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity5 --&gt;
&lt;!--thymeleaf与springsecurity整合的依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
    &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="1-数据层-2"><a href="#1-数据层-2" class="headerlink" title="1.数据层"></a>1.数据层</h2><p>修改帖子中的type和status</p>
<pre><code class="java">    int updateType(int id,int type);

    int updateStatus(int id,int status);
&#125;
</code></pre>
<h2 id="2-逻辑层"><a href="#2-逻辑层" class="headerlink" title="2.逻辑层"></a>2.逻辑层</h2><pre><code class="java">public int updateType(int id,int type)&#123;
    return discussPostMapper.updateType(id,type);
&#125;
public int updateStatus(int id,int status)&#123;
    return discussPostMapper.updateStatus(id,status);
&#125;
</code></pre>
<h2 id="3-权限控制"><a href="#3-权限控制" class="headerlink" title="3.权限控制"></a>3.权限控制</h2><pre><code class="java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant  &#123;

    @Override
    public void configure(WebSecurity web) throws Exception &#123;
        web.ignoring().antMatchers(&quot;/resources/**&quot;);
    &#125;
    
    //@Override
    //protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
    //    super.configure(auth);
    //&#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        //授权
        http.authorizeRequests()
                //需要登录才能访问的路径
                .antMatchers(
                    &quot;/user/setting&quot;,
                        &quot;/user/upload&quot;,
                        &quot;/discuss/add&quot;,
                        &quot;/comment/add/**&quot;,
                        &quot;/letter/**&quot;,
                        &quot;/notice/**&quot;,
                        &quot;/like&quot;,
                        &quot;/follow&quot;,
                        &quot;/unfollow&quot;
                )
                //这三个任意一个都可以
                .hasAnyAuthority(
                    AUTHORITY_ADMIN,AUTHORITY_USER,AUTHORITY_MODERATOR
                )
                .antMatchers(
                    &quot;/discuss/top&quot;,
                        &quot;/discuss/wonderful&quot;
                ).hasAnyAuthority(
                        AUTHORITY_MODERATOR
                ) .antMatchers(
                        &quot;/discuss/delete&quot;
                ).hasAnyAuthority(
                        AUTHORITY_ADMIN
                )
                //除了上面的几个请求,其他的谁都可以访问
                .anyRequest().permitAll().and()
                //禁用csrf检查，正式环境需要开开
                .csrf().disable();

        //权限不够时怎么处理
        http.exceptionHandling()
                //没有登录时怎么处理
                .authenticationEntryPoint(new AuthenticationEntryPoint() &#123;
                    @Override
                    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException &#123;
                        //判断当前请求是普通请求还是异步请求
                        String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;);
                        if(&quot;XMLHttpRequest&quot;.equals(xRequestedWith))&#123;
                            //是异步请求
                            response.setContentType(&quot;application/plain;charset=utf-8&quot;);
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJsonString(403,&quot;您还未登录&quot;));
                        &#125;else&#123;
                            //是普通请求
                            response.sendRedirect(request.getContextPath()+&quot;/login&quot;);
                        &#125;
                    &#125;
                &#125;)
                //权限不足时怎么处理
                .accessDeniedHandler(new AccessDeniedHandler() &#123;
                    @Override
                    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException &#123;
                        //判断当前请求是普通请求还是异步请求
                        String xRequestedWith = request.getHeader(&quot;x-requested-with&quot;);
                        if(&quot;XMLHttpRequest&quot;.equals(xRequestedWith))&#123;
                            //是异步请求
                            response.setContentType(&quot;application/plain;charset=utf-8&quot;);
                            PrintWriter writer = response.getWriter();
                            writer.write(CommunityUtil.getJsonString(403,&quot;您没有访问此功能的权限&quot;));
                        &#125;else&#123;
                            //是普通请求
                            response.sendRedirect(request.getContextPath()+&quot;/denied&quot;);
                        &#125;
                    &#125;
                &#125;);

        //Security默认会拦截/logout的请求,进行退出处理
        //覆盖它默认的逻辑,才能执行我们自己退出的代码
        http.logout()
                .logoutUrl(&quot;/security/logout&quot;);

    &#125;
</code></pre>
<p>同时在LoginTicketInterceptor中去除LoginRequiredInterceptor的作用:</p>
<p>在其中修改方法:</p>
<pre><code class="java">@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
    //从cookie中获取凭证
    String ticket = CookieUtil.getValue(request, &quot;ticket&quot;);

    if(ticket!=null)&#123;
        //表示登录了
        //查询凭证
        LoginTicket loginTicket = userService.findLoginTicket(ticket);
        //检查凭证是否有效
        if(loginTicket!=null&amp;&amp;loginTicket.getStatus()==0&amp;&amp;loginTicket.getExpired().after(new Date()))&#123;
            //根据凭证查询用户
            User user = userService.findUserById(loginTicket.getUserId());
            //在本次请求中持有用户
            hostHolder.setUser(user);
            //构建用户认证的结果,并存入securityContext,便于security授权
            Authentication authentication=new UsernamePasswordAuthenticationToken(
                    user,user.getPassword(),userService.getAuthorities(user.getId()));
            SecurityContextHolder.setContext(new SecurityContextImpl(authentication));
            //增加登录凭证的有效时间
            Date now = new Date();
            //相差的毫秒数
            long diff=loginTicket.getExpired().getTime()-now.getTime();
            if(diff/(1000*60*60)&lt;2)&#123;
                //凭证加两个小时
                long newTime=now.getTime()+2*60*60*1000;
                Date newExpired = new Date(newTime);
                loginTicket.setExpired(newExpired);
                String ticketKey = redisKeyUtil.getTicketKey(loginTicket.getTicket());
                redisTemplate.opsForValue().set(ticketKey,ticket);
            &#125;

        &#125;
    &#125;
    return true;
&#125;
</code></pre>
<p>在UserService添加方法:</p>
<pre><code class="java">//获得用户权限
public Collection&lt;? extends GrantedAuthority&gt;getAuthorities(int userId)&#123;
    User user = this.findUserById(userId);
    List&lt;GrantedAuthority&gt;list=new ArrayList&lt;&gt;();
    list.add(new GrantedAuthority() &#123;
        @Override
        public String getAuthority() &#123;
            switch (user.getType())&#123;
                case 1:
                    return AUTHORITY_ADMIN;
                case 2:
                    return AUTHORITY_MODERATOR;
                default:return AUTHORITY_USER;
            &#125;
        &#125;
    &#125;);
    return list;
&#125;
</code></pre>
<h2 id="4-前端-2"><a href="#4-前端-2" class="headerlink" title="4.前端"></a>4.前端</h2><p>发送请求:</p>
<pre><code class="js">$(function ()&#123;
    $(&quot;#topBtn&quot;).click(setTop)
    $(&quot;#wonderfulBtn&quot;).click(setWonderful)
    $(&quot;#deleteBtn&quot;).click(setDelete)
&#125;)
//置顶
function setTop()&#123;
    $.post(
        CONTEXT_PATH+&quot;/discuss/top&quot;,
        &#123;&quot;id&quot;:$(&quot;#postId&quot;).val()&#125;,
        function (data)&#123;
            data=$.parseJSON(data)
            if(data.code===0)&#123;
                $(&quot;#topBtn&quot;).attr(&quot;disabled&quot;,&quot;disabled&quot;)
            &#125;else&#123;
                alert(data.msg);
            &#125;
        &#125;
    )
&#125;
function setWonderful()&#123;
    $.post(
        CONTEXT_PATH+&quot;/discuss/wonderful&quot;,
        &#123;&quot;id&quot;:$(&quot;#postId&quot;).val()&#125;,
        function (data)&#123;
            data=$.parseJSON(data)
            if(data.code===0)&#123;
                $(&quot;#wonderfulBtn&quot;).attr(&quot;disabled&quot;,&quot;disabled&quot;)
            &#125;else&#123;
                alert(data.msg);
            &#125;
        &#125;
    )
&#125;

function setDelete()&#123;
    $.post(
        CONTEXT_PATH+&quot;/discuss/top&quot;,
        &#123;&quot;id&quot;:$(&quot;#postId&quot;).val()&#125;,
        function (data)&#123;
            data=$.parseJSON(data)
            if(data.code===0)&#123;
               location.href=CONTEXT_PATH+&quot;/index&quot;;
            &#125;else&#123;
                alert(data.msg);
            &#125;
        &#125;
    )
&#125;
</code></pre>
<p>页面:</p>
<pre><code class="html">&lt;!doctype html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot; xmlns:sec=&quot;http://www.thymeleaf.org/extras/spring-security&quot;&gt;
&lt;head&gt;
   &lt;meta charset=&quot;utf-8&quot;&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;
   &lt;link rel=&quot;icon&quot; href=&quot;https://static.nowcoder.com/images/logo_87_87.png&quot;/&gt;
   &lt;link rel=&quot;stylesheet&quot; href=&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css&quot; crossorigin=&quot;anonymous&quot;&gt;
   &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/css/global.css&#125;&quot; /&gt;
   &lt;link rel=&quot;stylesheet&quot; th:href=&quot;@&#123;/css/discuss-detail.css&#125;&quot; /&gt;
   &lt;title&gt;牛客网-帖子详情&lt;/title&gt;
&lt;/head&gt;
    
    
        &lt;h6 class=&quot;mb-4&quot;&gt;
                    &lt;img src=&quot;http://static.nowcoder.com/images/img/icons/ico-discuss.png&quot;/&gt;
                    &lt;span th:utext=&quot;$&#123;post.title&#125;&quot;&gt;备战春招，面试刷题跟他复习，一个月全搞定！&lt;/span&gt;
                    &lt;div class=&quot;float-right&quot;&gt;
                        &lt;input id=&quot;postId&quot; th:value=&quot;$&#123;post.id&#125;&quot;&gt;
                        &lt;button type=&quot;button&quot; class=&quot;btn btn-danger btn-sm&quot; id=&quot;topBtn&quot;
                                th:disabled=&quot;$&#123;post.type==1&#125;&quot; sec:authorize=&quot;hasAnyAuthority(&#39;moderator&#39;)&quot;&gt;
                            置顶&lt;/button&gt;
                        &lt;button type=&quot;button&quot; class=&quot;btn btn-danger btn-sm&quot; id=&quot;wonderfulBtn&quot;
                                th:disabled=&quot;$&#123;post.status==1&#125;&quot; sec:authorize=&quot;hasAnyAuthority(&#39;moderator&#39;)&quot;&gt;加精&lt;/button&gt;
                        &lt;button type=&quot;button&quot; class=&quot;btn btn-danger btn-sm&quot; id=&quot;deleteBtn&quot;
                                th:disabled=&quot;$&#123;post.status==2&#125;&quot; sec:authorize=&quot;hasAnyAuthority(&#39;admin&#39;)&quot;&gt;删除&lt;/button&gt;
                    &lt;/div&gt;
                &lt;/h6&gt;
</code></pre>
<h1 id="三十-Redis高级数据类型"><a href="#三十-Redis高级数据类型" class="headerlink" title="三十.Redis高级数据类型"></a>三十.Redis高级数据类型</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228132231779.png" alt="image-20230228132231779"></p>
<p>HyperLog</p>
<pre><code class="java">@SpringBootTest
public class hyperLogTest &#123;
    @Resource
    private StringRedisTemplate stringRedisTemplate;
    @Test
    void hyperLog() &#123;
        String[]values=new String[1000];
        int j=0;
        for (int i = 0; i &lt; 1000000; i++) &#123;
            j=i%1000;
            values[j]=&quot;userTest_&quot;+i;
            if(j==999)&#123;
                stringRedisTemplate.opsForHyperLogLog().add(&quot;hl2&quot;,values);
            &#125;
        &#125;
        //统计数量
        Long hl2 = stringRedisTemplate.opsForHyperLogLog().size(&quot;hl2&quot;);
        System.out.println(&quot;count=&quot;+hl2);
    &#125;

    //opsForHyperLogLog也可以合并几个key到新一个新的key,但是value重复的会被合并
    @Test
    void Union()&#123;
        String redisKey1=&quot;testLog:1&quot;;
        for (int i = 0; i &lt; 10000; i++) &#123;
            stringRedisTemplate.opsForHyperLogLog().add(redisKey1,&quot;&quot;+i);
        &#125;
        String redisKey2=&quot;testLog:2&quot;;
        for (int i = 5000; i &lt; 15000; i++) &#123;
            stringRedisTemplate.opsForHyperLogLog().add(redisKey2,&quot;&quot;+i);
        &#125;
        String redisKey3=&quot;testLog:3&quot;;
        for (int i = 15000; i &lt; 20000; i++) &#123;
            stringRedisTemplate.opsForHyperLogLog().add(redisKey3,&quot;&quot;+i);
        &#125;
        String redisKeyUnion=&quot;testUnion&quot;;
        //
        stringRedisTemplate.opsForHyperLogLog().union(redisKeyUnion, redisKey1, redisKey2, redisKey3);
        Long size = stringRedisTemplate.opsForHyperLogLog().size(redisKeyUnion);
        System.out.println(size);
    &#125;
&#125;
</code></pre>
<p>BitMap</p>
<pre><code class="java">/**
 * 签到功能:
 */
@Test
void sign()&#123;
    String redisSignKey=&quot;userSign&quot;;
    //假设今天是3月十号, 而三月五号未签到,其他天都签到了
    for (int i = 1; i &lt;11 ; i++) &#123;
        if(i!=5)&#123;
            stringRedisTemplate.opsForValue().setBit(redisSignKey,i-1,true);
        &#125;
    &#125;

    int count=0;
    int index=10;
    // 获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0
    List&lt;Long&gt; longs = stringRedisTemplate.opsForValue().bitField(redisSignKey
            , BitFieldSubCommands.create().get(BitFieldSubCommands.BitFieldType.unsigned(index)).valueAt(0));
    if(longs==null||longs.isEmpty())&#123;
        return;
    &#125;
    Long num = longs.get(0);
    if(num==null||num==0)&#123;
        return;
    &#125;
    //查询总共签到了几次:
    Object o = stringRedisTemplate.execute(new RedisCallback&lt;Object&gt;() &#123;
        @Override
        public Object doInRedis(RedisConnection connection) throws DataAccessException &#123;
            return connection.bitCount(redisSignKey.getBytes());
        &#125;
    &#125;);
    System.out.println(o);
    //查询连续签到了几天
    while (true)&#123;
        if((num&amp;1)==0)&#123;
            break;
        &#125;else&#123;
            count++;
            num&gt;&gt;&gt;=1;
        &#125;
    &#125;
    System.out.println(&quot;连续签到了几天: &quot;+count);
&#125;
</code></pre>
<h1 id="三十一-网站数据统计"><a href="#三十一-网站数据统计" class="headerlink" title="三十一.网站数据统计"></a>三十一.网站数据统计</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228144737349.png" alt="image-20230228144737349"></p>
<h2 id="1-业务层-2"><a href="#1-业务层-2" class="headerlink" title="1.业务层"></a>1.业务层</h2><p>使用HyperLogLog统计:</p>
<p>利用每天的日期,生成一个Key,将ip作为值加入HyperlogLog中,最后可以统计出改天总共的UV量:</p>
<pre><code class="java">@Resource
private RedisTemplate redisTemplate;

private SimpleDateFormat simpleDateFormat=new SimpleDateFormat(&quot;yyyyMMdd&quot;);

//将指定ip计入UV
public void recordUV(String ip)&#123;
    String redisKey = redisKeyUtil.getUVKey(simpleDateFormat.format(new Date()));
    redisTemplate.opsForHyperLogLog().add(redisKey,ip);
&#125;
</code></pre>
<p>统计指定日期的UV:</p>
<pre><code class="java">//统计指定日期范围内的UV
public long calculateUV(Date start,Date end)&#123;
    if(start==null||end==null)&#123;
        throw new IllegalArgumentException(&quot;参数不能为空&quot;);
    &#125;
    //整理日期范围内的key
    List&lt;String&gt;keyList=new ArrayList&lt;&gt;();
    //利用CalenDar判断给定的日期的先后顺序
    Calendar calendar=Calendar.getInstance();
    calendar.setTime(start);
    //若设定的日期小于或等于end
    while (!calendar.getTime().after(end))&#123;
        //得到指定的日期的UVKey
        String uvKey = redisKeyUtil.getUVKey(simpleDateFormat.format(calendar.getTime()));
       
        keyList.add(uvKey);
        //往后推一天
        calendar.add(Calendar.DATE,1);
    &#125;
    //合并这些数据
    if (keyList.isEmpty())&#123;
        return 0;
    &#125;
    String uvKey = redisKeyUtil.getUVKey(simpleDateFormat.format(start), simpleDateFormat.format(end));
    redisTemplate.opsForHyperLogLog().union(uvKey, keyList.toArray());

    //返回统计的数据大小
    return redisTemplate.opsForHyperLogLog().size(uvKey);
&#125;
</code></pre>
<p>类似的,DAU也是该种逻辑:</p>
<p>用户登录网站后,利用当前的登陆日期生成key,将该key的bitmap位(用户id的位次,比如用户id为102,就将102位设置为1):</p>
<p>之后再统计指定日期范围内的bitmap有多少位1:</p>
<pre><code class="java">//将指定用户计入DAU
public void recordDAU(int userId)&#123;
    String dauKey = redisKeyUtil.getDAUKey(simpleDateFormat.format(new Date()));
    //用户id是多少,就把多少位设置为1
    redisTemplate.opsForValue().setBit(dauKey,userId,true);
&#125;
//指定日期范围内的DAU
public long calculateDAU(Date start,Date end)&#123;
    if(start==null||end==null)&#123;
        throw new IllegalArgumentException(&quot;参数不能为空&quot;);
    &#125;
    //整理日期范围内的key
    List&lt;byte[]&gt;keyList=new ArrayList&lt;&gt;();
    Calendar calendar=Calendar.getInstance();
    calendar.setTime(start);
    while (!calendar.getTime().after(end))&#123;
        String dauKey = redisKeyUtil.getDAUKey(simpleDateFormat.format(calendar.getTime()));
        keyList.add(dauKey.getBytes());
        calendar.add(Calendar.DATE,1);
    &#125;
    //进行运算
    return (long)redisTemplate.execute(new RedisCallback() &#123;
        @Override
        public Object doInRedis(RedisConnection redisConnection) throws DataAccessException &#123;
            String dauKey = redisKeyUtil.getDAUKey(simpleDateFormat.format(start), simpleDateFormat.format(end));
            redisConnection.bitOp(RedisStringCommands.BitOperation.OR,
                    dauKey.getBytes(),keyList.toArray(new byte[0][0]));
            return redisConnection.bitCount(dauKey.getBytes());
        &#125;
    &#125;);
&#125;
</code></pre>
<h2 id="2-拦截器-1"><a href="#2-拦截器-1" class="headerlink" title="2.拦截器"></a>2.拦截器</h2><p>由于在每个请求到达controller前都要将访问数据写入到redis中,所以最好使用拦截器完成这个工作:</p>
<p>拦截器将每次请求的ip和userid写入到redis中,以供后续表现层获取数据</p>
<pre><code class="java">@Component
public class DataInterceptor implements HandlerInterceptor &#123;
    @Resource
    private DataService dataService;
    @Resource
    private HostHolder holder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        //统计UV
        String ip=request.getRemoteHost();
        dataService.recordUV(ip);
        //统计DAU
        User user = holder.getUser();
        if(user!=null)&#123;
            dataService.recordDAU(user.getId());
        &#125;

        return true;
    &#125;
&#125;
</code></pre>
<h2 id="3-表现层"><a href="#3-表现层" class="headerlink" title="3.表现层"></a>3.表现层</h2><pre><code class="java">@Controller
public class DataController &#123;
    @Resource
    private DataService dataService;

    @RequestMapping(path = &quot;/data&quot;,method = &#123;RequestMethod.GET,RequestMethod.POST&#125;)
    public String getDataPage()&#123;
        return &quot;/site/admin/data&quot;;
    &#125;

    //统计UV情况
    @PostMapping(&quot;/data/uv&quot;)
      //@DateTimeFormat指定日期格式
    public String getUV(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start
            , @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model)&#123;
        long uv = dataService.calculateUV(start, end);
        model.addAttribute(&quot;uv&quot;,uv);
        model.addAttribute(&quot;uvStartDate&quot;,start);
        model.addAttribute(&quot;uvEndDate&quot;,end);
        return &quot;forward:/data&quot;;
    &#125;
    //统计网站DAU
    @PostMapping(&quot;/data/dau&quot;)
    public String getDAU(@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date start
            , @DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;) Date end, Model model)&#123;
        long dau = dataService.calculateDAU(start, end);
        model.addAttribute(&quot;dau&quot;,dau);
        model.addAttribute(&quot;dauStartDate&quot;,start);
        model.addAttribute(&quot;dauEndDate&quot;,end);
        return &quot;forward:/data&quot;;
    &#125;

&#125;
</code></pre>
<h1 id="三十二-任务调度与执行"><a href="#三十二-任务调度与执行" class="headerlink" title="三十二.任务调度与执行"></a>三十二.任务调度与执行</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228190138987.png" alt="image-20230228190138987"></p>
<h1 id="三十三-热帖排行"><a href="#三十三-热帖排行" class="headerlink" title="三十三.热帖排行"></a>三十三.热帖排行</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230228194831352.png" alt="image-20230228194831352"></p>
<p>使用quartz进行分布式任务调度</p>
<p>quartz第一次运行时会将配置信息读入到数据库中,之后会从数据库中读取,不再从配置信息中读取</p>
<h2 id="1-引入pom文件"><a href="#1-引入pom文件" class="headerlink" title="1.引入pom文件:"></a>1.引入pom文件:</h2><pre><code class="xml">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-quartz --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h2 id="2-编写任务类"><a href="#2-编写任务类" class="headerlink" title="2.编写任务类:"></a>2.编写任务类:</h2><p>按照上面给的分数公式计算. 每次加精,评论,点赞都会让帖子分数增加.所以我们在处理这些请求的方法中将帖子id加入到redis中(加入到set集合中). 每过一段时间利用quartz定时计算帖子的分数:</p>
<pre><code class="java">//计算帖子分数
String postScoreKey = redisKeyUtil.getPostScoreKey();
redisTemplate.opsForSet().add(postScoreKey,post.getId());
</code></pre>
<p>具体的逻辑:</p>
<pre><code class="java">public class PostScoreRefreshJob implements Job, CommunityConstant &#123;
    private Logger logger= LoggerFactory.getLogger(PostScoreRefreshJob.class);

    @Resource
    private RedisTemplate redisTemplate;
    @Resource
    private DiscussPostService discussPostService;
    @Resource
    private LikeService likeService;
    @Resource
    private ElasticSearchService elasticSearchService;
    //牛客纪元
    private static final Date epoch;

    static &#123;
        try &#123;
            epoch=new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(&quot;2014-08-01 00:00:00&quot;);
        &#125; catch (ParseException e) &#123;
            throw new RuntimeException(&quot;初始化牛客纪元失败&quot;);
        &#125;
    &#125;
    //统计分数
    @Override
    public void execute(JobExecutionContext jobExecutionContext) throws JobExecutionException &#123;
        String postScoreKey = redisKeyUtil.getPostScoreKey();
        BoundSetOperations Operations=redisTemplate.boundSetOps(postScoreKey);
        //没有任何变化
        if(Operations.size()==0)&#123;
            logger.info(&quot;任务取消,没有需要刷新的帖子&quot;);
            return;
        &#125;
        logger.info(&quot;[任务开始],正在刷新帖子分数:&quot;+Operations.size());
        while (Operations.size()&gt;0)&#123;
            //刷新帖子的分数
            this.refresh((Integer)Operations.pop());
        &#125;
        logger.info(&quot;[任务结束]帖子分数刷新完毕&quot;);
    &#125;
    private void refresh(int postId)&#123;
        DiscussPost post = discussPostService.selectDiscussPostById(postId);
        if(post==null)&#123;
            logger.error(&quot;该帖子不存在: id=&quot;+postId);
            return;
        &#125;
        //是否加精
        boolean wonderful = post.getStatus() == 1;
        //评论数量
        int commentCount = post.getCommentCount();
        //点赞数量
        long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId);

        //计算权重
        double w=(wonderful?75:0)+commentCount*10+likeCount*2;
        //分数=帖子的权重加上距离天数
        double score=Math.log10(Math.max(w,1))
                +(post.getCreateTime().getTime()-epoch.getTime())/(1000*60*60*24);
        //更新帖子分数
        discussPostService.updateScore(postId,score);
        //同步es
        post.setScore(score);
        elasticSearchService.saveDiscussPost(post);
    &#125;
&#125;
</code></pre>
<h2 id="3-编写配置类"><a href="#3-编写配置类" class="headerlink" title="3.编写配置类"></a>3.编写配置类</h2><pre><code class="java">//配置刷新帖子分数任务
@Bean
public JobDetailFactoryBean postScoreRefreshJobDetail()&#123;
    JobDetailFactoryBean factoryBean=new JobDetailFactoryBean();
    factoryBean.setJobClass(PostScoreRefreshJob.class);
    factoryBean.setName(&quot;postScoreRefreshJob&quot;);
    factoryBean.setGroup(&quot;communityJobGroup&quot;);
    //任务是长久保存
    factoryBean.setDurability(true);
    //任务是否是可恢复的
    factoryBean.setRequestsRecovery(true);
    return factoryBean;
&#125;
//                      简单                      复杂
//配置trigger(SimpleTriggerFactoryBean or CronTriggerFactoryBean)
@Bean
public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail)&#123;
    SimpleTriggerFactoryBean stfb=new SimpleTriggerFactoryBean();
    stfb.setJobDetail(postScoreRefreshJobDetail);
    stfb.setName(&quot;postScoreRefreshTrigger&quot;);
    stfb.setGroup(&quot;communityTriggerGroup&quot;);
    //五分钟执行一遍
    stfb.setRepeatInterval(1000*60*5);
    stfb.setJobDataMap(new JobDataMap());
    return stfb;
&#125;
</code></pre>
<h2 id="4-重构帖子查询逻辑"><a href="#4-重构帖子查询逻辑" class="headerlink" title="4.重构帖子查询逻辑"></a>4.重构帖子查询逻辑</h2><p>现在就需要加判断是佛需要按照score排序的逻辑了</p>
<pre><code class="java">//查询评论,带有分页
List&lt;DiscussPost&gt;selectDiscussPosts(int userId,int offset,int limit,int orderMode);
</code></pre>
<pre><code class="xml">&lt;select id=&quot;selectDiscussPosts&quot; resultType=&quot;DiscussPost&quot;&gt;
    select &lt;include refid=&quot;selectFields&quot;&gt;&lt;/include&gt;
    from discuss_post
    where status!=2
    &lt;if test=&quot;userId!=0&quot;&gt;
        and user_id=#&#123;userId&#125;
    &lt;/if&gt;
    &lt;if test=&quot;orderMode==0&quot;&gt;
        order by type desc,create_time desc
    &lt;/if&gt;
    &lt;if test=&quot;orderMode==1&quot;&gt;
        order by type desc,score desc,create_time desc
    &lt;/if&gt;
    limit #&#123;offset&#125;,#&#123;limit&#125;
&lt;/select&gt;
</code></pre>
<p>orderMode在请求地址的查询参数中:</p>
<pre><code class="java">@RequestMapping(path = &quot;/index&quot;,method = RequestMethod.GET)
public String getIndexPage(Model model, Page page,@RequestParam(name = &quot;orderMode&quot;,defaultValue = &quot;0&quot;) int orderMode)&#123;
</code></pre>
<pre><code class="html">&lt;li class=&quot;nav-item&quot;&gt;
   &lt;a th:class=&quot;|nav-link $&#123;orderMode==1?&#39;active&#39;:&#39;&#39;&#125;|&quot; th:href=&quot;@&#123;/index(orderMode=1)&#125;&quot;&gt;最热&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<h1 id="三十四-生成长图"><a href="#三十四-生成长图" class="headerlink" title="三十四.生成长图"></a>三十四.生成长图</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230301133515711.png" alt="image-20230301133515711"></p>
<p>下载完安装包之后,可以在控制台直接输入即可将网址内容保存为pdf</p>
<pre><code class="shell">wkhtmltopdf 网址 存储地址
</code></pre>
<p>同理:</p>
<pre><code>wkhtmltoimage 网址 存储地址
</code></pre>
<p>保存为图像</p>
<p>使用java</p>
<pre><code class="java">@GetMapping(&quot;/share&quot;)
@ResponseBody
//查询参数为(?htmlUrl=www.xxx....)
public String share(String htmlUrl)&#123;
    //文件名
    String filename = CommunityUtil.generateUUID();
    //异步生成长图
    Event event=new Event()
            .setTopic(TOPIC_Share)
            .setData(&quot;htmlUrl&quot;,htmlUrl)
            .setData(&quot;filename&quot;,filename)
            .setData(&quot;suffix&quot;,&quot;.png&quot;);
    eventProducer.fireEvent(event);

    //返回访问路径
    Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
    //map.put(&quot;setUrl&quot;,domain+context+&quot;/share/image/&quot;+filename);
    map.put(&quot;setUrl&quot;,shareBucketUrl+&quot;/&quot;+filename);
    return CommunityUtil.getJsonString(0,null,map);
&#125;
</code></pre>
<pre><code class="java">//废弃
@GetMapping(&quot;/share/image/&#123;filename&#125;&quot;)
public void getSetImage(@PathVariable(&quot;filename&quot;)String filename, HttpServletResponse response)  &#123;
    if(StringUtils.isBlank(filename))&#123;
        throw new IllegalArgumentException(&quot;文件名不能为空&quot;);
    &#125;
    response.setContentType(&quot;image/png&quot;);
    File file = new File(storage + &quot;/&quot; + filename + &quot;.png&quot;);
    try &#123;
        OutputStream outputStream = response.getOutputStream();
        FileInputStream fis=new FileInputStream(file);
        byte[] buffer=new byte[1024];
        int flag=0;
        while((flag=fis.read(buffer))!=-1)&#123;
            outputStream.write(buffer,0,flag);
        &#125;
        
    &#125; catch (IOException e) &#123;
        logger.error(&quot;获取长图失败: &quot;+e.getMessage());
    &#125;
&#125;
</code></pre>
<h1 id="三十五-将文件上传至服务器"><a href="#三十五-将文件上传至服务器" class="headerlink" title="三十五.将文件上传至服务器"></a>三十五.将文件上传至服务器</h1><p>​	<img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230301151854517.png" alt="image-20230301151854517"></p>
<p>​	申请七牛云的对象存储权限之后进行配置:</p>
<pre><code class="properties">#qiniu
qiniu.key.acess=-FpCBBfKorbxyem5I4UmOlHFxnwpDvhe8HpaZM_-
qiniu.key.secret=AxeHBUcTxreXioMLI16uZcte9c4cAwszZF5g7aBj
qiniu.bucket.header.name=dylan-newcode
qiniu.bucket.header.url=http://rqu0l3xtz.hn-bkt.clouddn.com
qiniu.bucket.share.name=dylan-newcode-share
qiniu.bucket.share.url=http://rqu0rpjdh.hd-bkt.clouddn.com
</code></pre>
<h2 id="1-将头像上传到七牛云"><a href="#1-将头像上传到七牛云" class="headerlink" title="1.将头像上传到七牛云:"></a>1.将头像上传到七牛云:</h2><pre><code class="java">@LoginRequired
@GetMapping(&quot;/setting&quot;)
public String getSettingPage(Model model)&#123;
    //上传文件名称
    String filename = CommunityUtil.generateUUID();
    //设置响应信息
    StringMap police=new StringMap();
    police.put(&quot;returnBody&quot;,CommunityUtil.getJsonString(0));
    //上传身份凭证
    Auth auth=Auth.create(accessKey,secretKey);
    String uploadToken = auth.uploadToken(headerBucketName, filename, 3600, police);
    //String uploadToken = auth.uploadToken(headerBucketName);
    model.addAttribute(&quot;uploadToken&quot;,uploadToken);
     model.addAttribute(&quot;filename&quot;,filename);
     
    return &quot;/site/setting&quot;;
&#125;
</code></pre>
<h3 id="前端"><a href="#前端" class="headerlink" title="前端:"></a>前端:</h3><pre><code class="html">&lt;form class=&quot;mt-5&quot; id=&quot;uploadForm&quot;&gt;
   &lt;div class=&quot;form-group row mt-4&quot;&gt;
      &lt;label class=&quot;col-sm-2 col-form-label text-right&quot;&gt;选择头像:&lt;/label&gt;
      &lt;div class=&quot;col-sm-10&quot;&gt;
         &lt;div class=&quot;custom-file&quot;&gt;
            &lt;input type=&quot;hidden&quot; name=&quot;token&quot; th:value=&quot;$&#123;uploadToken&#125;&quot;&gt;
            &lt;input type=&quot;hidden&quot; name=&quot;key&quot; th:value=&quot;$&#123;filename&#125;&quot;&gt;
            &lt;input type=&quot;file&quot; class=&quot;custom-file-input&quot;
                  name=&quot;file&quot; id=&quot;head-image&quot; lang=&quot;es&quot; required=&quot;&quot;&gt;
            &lt;label class=&quot;custom-file-label&quot; for=&quot;head-image&quot; data-browse=&quot;文件&quot;&gt;选择一张图片&lt;/label&gt;
            &lt;div class=&quot;invalid-feedback&quot;&gt;
               xx
            &lt;/div&gt;
         &lt;/div&gt;
      &lt;/div&gt;
   &lt;/div&gt;
   &lt;div class=&quot;form-group row mt-4&quot;&gt;
      &lt;div class=&quot;col-sm-2&quot;&gt;&lt;/div&gt;
      &lt;div class=&quot;col-sm-10 text-center&quot;&gt;
         &lt;button type=&quot;submit&quot; class=&quot;btn btn-info text-white form-control&quot;&gt;立即上传&lt;/button&gt;
      &lt;/div&gt;
   &lt;/div&gt;
&lt;/form&gt;
</code></pre>
<pre><code class="js">$(function()&#123;
    $(&quot;#uploadForm&quot;).submit(upload);
&#125;);

function upload() &#123;
    $.ajax(&#123;
        url: &quot;http://upload-z2.qiniup.com&quot;,
        method: &quot;post&quot;,
        processData: false,
        contentType: false,
        data: new FormData($(&quot;#uploadForm&quot;)[0]),
        success: function(data) &#123;
            if(data &amp;&amp; data.code === 0) &#123;
                // 更新头像访问路径
                $.post(
                    CONTEXT_PATH + &quot;/user/header/url&quot;,
                    &#123;&quot;filename&quot;:$(&quot;input[name=&#39;key&#39;]&quot;).val()&#125;,
                    function(data) &#123;
                        data = $.parseJSON(data);
                        if(data.code === 0) &#123;
                            window.location.reload();
                        &#125; else &#123;
                            alert(data.msg);
                        &#125;
                    &#125;
                );
            &#125; else &#123;
                alert(&quot;上传失败!&quot;);
            &#125;
        &#125;
    &#125;);
    return false;
&#125;
</code></pre>
<h2 id="2-将分享的长图上传到云服务器"><a href="#2-将分享的长图上传到云服务器" class="headerlink" title="2.将分享的长图上传到云服务器"></a>2.将分享的长图上传到云服务器</h2><pre><code class="java">@GetMapping(&quot;/share&quot;)
@ResponseBody
//查询参数为(?htmlUrl=www.xxx....)
public String share(String htmlUrl)&#123;
    //文件名
    String filename = CommunityUtil.generateUUID();
    //异步生成长图
    Event event=new Event()
            .setTopic(TOPIC_Share)
            .setData(&quot;htmlUrl&quot;,htmlUrl)
            .setData(&quot;filename&quot;,filename)
            .setData(&quot;suffix&quot;,&quot;.png&quot;);
    eventProducer.fireEvent(event);

    //返回访问路径
    Map&lt;String,Object&gt;map=new HashMap&lt;&gt;();
    //map.put(&quot;setUrl&quot;,domain+context+&quot;/share/image/&quot;+filename);
    map.put(&quot;setUrl&quot;,shareBucketUrl+&quot;/&quot;+filename);
    return CommunityUtil.getJsonString(0,null,map);
&#125;
</code></pre>
<pre><code class="java">    @Resource
    private ThreadPoolTaskScheduler taskScheduler;

//消费分享事件
@KafkaListener(topics = &#123;TOPIC_Share&#125;)
public void handleShare(ConsumerRecord record)&#123;
    if(record==null||record.value()==null)&#123;
        logger.error(&quot;消息的内容为空&quot;);
        return;
    &#125;
    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if(event==null)&#123;
        logger.error(&quot;消息格式错误&quot;);
    &#125;
    String htmlUrl =(String) event.getData().get(&quot;htmlUrl&quot;);
    String filename=(String) event.getData().get(&quot;filename&quot;);
    String suffix=(String) event.getData().get(&quot;suffix&quot;);
    //命令字符串
    String cmd=command+&quot; --quality 75 &quot;+htmlUrl+&quot; &quot;+storage+&quot;/&quot;+filename+suffix;
    try &#123;
        Runtime.getRuntime().exec(cmd);
        logger.info(&quot;生成长图&quot;);
    &#125; catch (IOException e) &#123;
        logger.error(&quot;生成长图失败: &quot;+e.getMessage());
    &#125;

    //启用定时器,监视该图片,一旦生成了图片,就上传七牛云
    uploadTask uploadTask=new uploadTask(filename,suffix);
    Future future = taskScheduler.scheduleAtFixedRate(uploadTask, 500);
    uploadTask.setFuture(future);
&#125;

class uploadTask implements Runnable&#123;
    //文件名称
    private String filename;
    //名称后缀
    private String suffix;
    //启动任务的返回值,用来停止定时器
    private Future future;
    //开始时间
    private long startTime;
    //上传次数
    private int count;
    public void setFuture(Future future) &#123;
        this.future = future;
    &#125;

    public uploadTask(String filename, String suffix) &#123;
        this.filename = filename;
        this.suffix = suffix;
        this.startTime=System.currentTimeMillis();
    &#125;

    @Override
    public void run() &#123;
        //生成图片失败
        if(System.currentTimeMillis()-startTime&gt;30000)&#123;
            logger.error(&quot;执行时间过长,终止任务 &quot;+filename);
            future.cancel(true);
            return;
        &#125;
        //上传失败
        if(count&gt;=6)&#123;
            logger.error(&quot;上传次数过多,终止任务:&quot; +filename);
            future.cancel(true);
            return;
        &#125;
        String path=storage+&quot;/&quot;+filename+suffix;
        File file=new File(path);
        if(file.exists())&#123;
            logger.info(String.format(&quot;开始第%d次上传[%s]&quot;,++count,filename));
            //设置响应信息
            StringMap policy = new StringMap();
            policy.put(&quot;returnBody&quot;, CommunityUtil.getJsonString(0));
            //生成上传凭证
            Auth auth=Auth.create(accessKey,secretKey);
            String uploadToken = auth.uploadToken(shareBucketName, filename, 3600, policy);
            //指定上传的机房
            UploadManager uploadManager=new UploadManager(new Configuration(Region.huadong()));
            try &#123;
                Thread.sleep(3000);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            try &#123;
                //开始上传图片
                Response response=uploadManager.put(
                        path,filename,uploadToken,null,&quot;image&quot;+suffix,false
                );
                //处理响应结果
                JSONObject jsonObject = JSONObject.parseObject(response.bodyString());
                System.out.println(jsonObject.get(&quot;code&quot;));
                if(jsonObject==null||jsonObject.get(&quot;code&quot;)==null||!jsonObject.get(&quot;code&quot;).toString().equals(&quot;0&quot;))&#123;
                    logger.info(String.format(&quot;第%d上传失败[%s]&quot;,count,filename));
                &#125;else&#123;
                    logger.info(String.format(&quot;第%d上传成功[%s]&quot;,count,filename));
                    future.cancel(true);
                &#125;
            &#125;catch (QiniuException e)&#123;
                logger.info(String.format(&quot;第%d上传失败[%s]&quot;,count,filename));
            &#125;
        &#125;else&#123;
            logger.info(&quot;等待图片生成 [&quot;+filename+&quot;]&quot;);
        &#125;
    &#125;
&#125;
</code></pre>
<p>使用spring自带的异步线程池需要配置:</p>
<pre><code class="java">@Configuration
@EnableScheduling
@EnableAsync
public class ThreadPoolConfig &#123;
&#125;
</code></pre>
<h1 id="三十六-优化网站的性能"><a href="#三十六-优化网站的性能" class="headerlink" title="三十六.优化网站的性能"></a>三十六.优化网站的性能</h1><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302133451485.png" alt="image-20230302133451485"></p>
<p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302145706823.png" alt="image-20230302145706823"></p>
<h1 id="三十七-总结"><a href="#三十七-总结" class="headerlink" title="三十七.总结"></a>三十七.总结</h1><h2 id="1-单元测试"><a href="#1-单元测试" class="headerlink" title="1.单元测试"></a>1.单元测试</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302150141005.png" alt="image-20230302150141005"></p>
<pre><code class="java">@SpringBootTest
@ContextConfiguration(classes = NewCodeApplication.class)
@RunWith(SpringRunner.class)
public class springbootTest &#123;
    @Autowired
    private DiscussPostService discussPostService;

    private DiscussPost data;

    //测试启动前被调用一次
    @BeforeClass
    public static void beforeClass() &#123;
        System.out.println(&quot;beforeClass&quot;);
    &#125;
    //测试启动后被调用一次
    @AfterClass
    public static void afterClass() &#123;
        System.out.println(&quot;afterClass&quot;);
    &#125;

    //每个方法之前都会调用
    //测试前创造数据
    @Before
    public void before() &#123;
        System.out.println(&quot;before&quot;);

        // 初始化测试数据
        data = new DiscussPost();
        data.setUserId(111);
        data.setTitle(&quot;Test Title&quot;);
        data.setContent(&quot;Test Content&quot;);
        data.setCreateTime(new Date());
        discussPostService.addDiscussPost(data);
    &#125;

    //每个方法之=之后都会调用
    //测试后删除数据
    @After
    public void after() &#123;
        System.out.println(&quot;after&quot;);
        // 删除测试数据
        discussPostService.updateStatus(data.getId(), 2);
    &#125;

    @Test
    public void test1() &#123;
        System.out.println(&quot;test1&quot;);
    &#125;

    @Test
    public void test2() &#123;
        System.out.println(&quot;test2&quot;);
    &#125;

    @Test
    public void testFindById() &#123;
        DiscussPost post = discussPostService.selectDiscussPostById(data.getId());
        //断言
        Assert.assertNotNull(post);
        Assert.assertEquals(data.getTitle(), post.getTitle());
        Assert.assertEquals(data.getContent(), post.getContent());
    &#125;
    @Test
    public void testUpdateScore() &#123;
        int rows = discussPostService.updateScore(data.getId(), 2000.00);
        Assert.assertEquals(1, rows);

        DiscussPost post = discussPostService.selectDiscussPostById(data.getId());
        Assert.assertEquals(2000.00, post.getScore(), 2);
    &#125;
&#125;
</code></pre>
<h2 id="2-项目监控"><a href="#2-项目监控" class="headerlink" title="2.项目监控"></a>2.项目监控</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302151754621.png" alt="image-20230302151754621"></p>
<h2 id="3-部署"><a href="#3-部署" class="headerlink" title="3.部署"></a>3.部署</h2><p>暂时跳过</p>
<h2 id="4-项目总结"><a href="#4-项目总结" class="headerlink" title="4.项目总结"></a>4.项目总结</h2><p><img src="https://gitee.com/DylanToT99/images/raw/master/images/image-20230302160812156.png" alt="image-20230302160812156"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Dylan Pan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://dyylan99.github.io/2023/03/21/niu-ke-shou-ye-xiang-mu/">https://dyylan99.github.io/2023/03/21/niu-ke-shou-ye-xiang-mu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Dylan Pan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/03/24/zhong-jian-jian-kai-fa-springboot/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="springboot中间件开发">
                        
                        <span class="card-title">springboot中间件开发</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring/" class="post-category">
                                    spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">spring,中间件</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02/09/spring-mini/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="手写springIOC,AOP核心原理">
                        
                        <span class="card-title">手写springIOC,AOP核心原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring/">
                        <span class="chip bg-color">Spring</span>
                    </a>
                    
                    <a href="/tags/%E6%A1%86%E6%9E%B6/">
                        <span class="chip bg-color">框架</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="song"
                   id="26807310"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">Dylan Pan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">263.5k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/DylanToT99" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1975131479@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1975131479" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1975131479" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
